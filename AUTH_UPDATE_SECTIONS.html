<!-- ================================================================ -->
<!-- FIREBASE AUTHENTICATION SYSTEM UPDATE GUIDE                      -->
<!-- ================================================================ -->
<!-- 
This file contains the UPDATED sections for Firebase Auth integration.
Follow the instructions below to update your index.html file.
-->

<!-- ============================================================== -->
<!-- SECTION 1: REPLACE AUTH CONTAINER (Lines ~1232-1270)         -->
<!-- ============================================================== -->
<!-- 
Find the <div id="auth-container"> section in your index.html
Replace EVERYTHING from <div id="auth-container"> to </div> (before main-app)
With the code below:
-->

<div id="auth-container" class="w-full max-w-md mx-auto">
    <div class="text-center mb-10 fade-in">
        <div class="inline-block bg-gradient-to-br from-indigo-500 to-purple-600 p-4 rounded-2xl shadow-2xl mb-4">
            <svg class="w-14 h-14 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M2.25 21h1.5m18 0h-18M2.25 9l4.5-1.636M18.75 3l-1.5.545m0 6.205l3 1m-3-1l-3-1m-3 1l-3 1m-3-1l3 1m0 0l4.5-1.636m0 0l4.5 1.636m0 0l4.5-1.636m0 0l-1.5-.545m0 0l-1.5.545m0 0l-3 1m-3-1l3-1m3 1l3-1m-3 1l-3-1" />
            </svg>
        </div>
        <h1 id="auth-title" class="mt-4 text-4xl font-extrabold bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400 bg-clip-text text-transparent fade-in delay-100">Welcome Back</h1>
        <p id="auth-subtitle" class="mt-3 text-base text-gray-600 dark:text-gray-400 fade-in delay-200">Log in to control your smart devices.</p>
    </div>

    <!-- Login Form -->
    <form id="login-form" class="space-y-5" onsubmit="event.preventDefault(); handleLogin();">
        <div class="relative fade-in delay-200">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207" /></svg>
            </div>
            <input type="email" id="login-email" required placeholder="Email Address" autocomplete="email" class="w-full pl-16 py-3">
        </div>
        <div class="relative fade-in delay-300">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
            </div>
            <input type="password" id="login-password" required placeholder="Password" autocomplete="current-password" class="w-full pl-16 pr-12 py-3">
            <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-indigo-500 transition-colors">
                <svg id="eye-open" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                <svg id="eye-closed" class="h-5 w-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>
            </button>
        </div>
        <div class="text-right fade-in delay-350">
            <button type="button" id="forgot-password-link" class="text-sm text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 transition-colors">Forgot Password?</button>
        </div>
        <button id="login-btn" type="submit" class="btn w-full flex justify-center items-center py-3 fade-in delay-400 text-base">
            <span id="login-btn-text">Log In</span>
            <svg id="login-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </button>
        <div class="text-center mt-4 fade-in delay-500">
            <span class="text-gray-600 dark:text-gray-400">Don't have an account? </span>
            <button type="button" id="show-signup-link" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 font-semibold transition-colors">Sign Up</button>
        </div>
    </form>

    <!-- Signup Form (Hidden by default) -->
    <form id="signup-form" class="space-y-5 hidden" onsubmit="event.preventDefault(); handleSignup();">
        <div class="relative fade-in delay-200">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
            </div>
            <input type="text" id="signup-name" required placeholder="Full Name" autocomplete="name" class="w-full pl-16 py-3">
        </div>
        <div class="relative fade-in delay-250">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207" /></svg>
            </div>
            <input type="email" id="signup-email" required placeholder="Email Address" autocomplete="email" class="w-full pl-16 py-3">
        </div>
        <div class="relative fade-in delay-300">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
            </div>
            <input type="password" id="signup-password" required placeholder="Password (min 6 characters)" minlength="6" autocomplete="new-password" class="w-full pl-16 pr-12 py-3">
            <button type="button" id="toggle-password-signup" class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-indigo-500 transition-colors">
                <svg id="eye-open-signup" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                <svg id="eye-closed-signup" class="h-5 w-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>
            </button>
        </div>
        <button id="signup-btn" type="submit" class="btn w-full flex justify-center items-center py-3 fade-in delay-400 text-base">
            <span id="signup-btn-text">Create Account</span>
            <svg id="signup-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </button>
        <div class="text-center mt-4 fade-in delay-500">
            <span class="text-gray-600 dark:text-gray-400">Already have an account? </span>
            <button type="button" id="show-login-link" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 font-semibold transition-colors">Log In</button>
        </div>
    </form>

    <!-- Forgot Password Form (Hidden by default) -->
    <form id="forgot-password-form" class="space-y-5 hidden" onsubmit="event.preventDefault(); handlePasswordReset();">
        <div class="text-center mb-4">
            <p class="text-sm text-gray-600 dark:text-gray-400">Enter your email address and we'll send you a password reset link.</p>
        </div>
        <div class="relative fade-in delay-200">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207" /></svg>
            </div>
            <input type="email" id="reset-email" required placeholder="Email Address" autocomplete="email" class="w-full pl-16 py-3">
        </div>
        <button id="reset-btn" type="submit" class="btn w-full flex justify-center items-center py-3 fade-in delay-300 text-base">
            <span id="reset-btn-text">Send Reset Link</span>
            <svg id="reset-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </button>
        <div class="text-center mt-4 fade-in delay-400">
            <button type="button" id="back-to-login-link" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 font-semibold transition-colors">← Back to Login</button>
        </div>
    </form>
</div>


<!-- ============================================================== -->
<!-- SECTION 2: JAVASCRIPT UPDATES                                 -->
<!-- ============================================================== -->
<!--
PART A: Add these NEW Firebase helper functions (Add AFTER setupFirebaseListeners function around line 2150)
-->

<script>
// ===== FIREBASE AUTHENTICATION FUNCTIONS =====

// Global variable to store current user info
window.currentUser = null;

// Initialize Firebase Auth listener
function initializeAuthListener() {
    const { onAuthStateChanged } = window.firebaseModules;
    
    onAuthStateChanged(auth, (user) => {
        if (user) {
            window.currentUser = {
                uid: user.uid,
                email: user.email,
                displayName: user.displayName || user.email.split('@')[0],
                emailVerified: user.emailVerified
            };
            console.log('User authenticated:', window.currentUser);
            
            // Save user activity
            saveUserActivity('login').catch(err => console.error('Failed to save login activity:', err));
            
            // Load user's data and show main app
            showMainApp();
        } else {
            window.currentUser = null;
            console.log('User logged out');
            showAuth();
        }
    });
}

// Save user activity to Firestore
async function saveUserActivity(activityType, details = {}) {
    if (!window.currentUser) return;
    
    try {
        const { addDoc, collection, serverTimestamp } = window.firebaseModules;
        
        await addDoc(collection(db, 'userActivity'), {
            userId: window.currentUser.uid,
            userEmail: window.currentUser.email,
            userName: window.currentUser.displayName,
            activityType: activityType,
            details: details,
            timestamp: serverTimestamp(),
            device: navigator.userAgent
        });
        
        console.log(`✅ User activity saved: ${activityType}`);
    } catch (error) {
        console.error('Error saving user activity:', error);
    }
}

// Update log saving to include user info
async function saveLogToFirebase(logText, logType) {
    try {
        const { addDoc, collection, serverTimestamp } = window.firebaseModules;
        
        const logData = {
            text: logText,
            type: logType,
            timestamp: serverTimestamp(),
            userId: window.currentUser ? window.currentUser.uid : 'anonymous',
            userEmail: window.currentUser ? window.currentUser.email : 'anonymous',
            userName: window.currentUser ? window.currentUser.displayName : 'anonymous'
        };
        
        await addDoc(collection(db, 'logs'), logData);
        console.log('✅ Log saved to Firebase with user info');
    } catch (error) {
        console.error('Error saving log to Firebase:', error);
        throw error;
    }
}

// Handle Login
async function handleLogin() {
    const { signInWithEmailAndPassword } = window.firebaseModules;
    const loginBtn = document.getElementById('login-btn');
    const loginBtnText = document.getElementById('login-btn-text');
    const loginSpinner = document.getElementById('login-spinner');
    
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    loginBtnText.classList.add('hidden');
    loginSpinner.classList.remove('hidden');
    loginBtn.disabled = true;
    
    try {
        await signInWithEmailAndPassword(auth, email, password);
        showToast('✅ Login successful!', 'success');
    } catch (error) {
        let errorMessage = 'Login failed';
        switch (error.code) {
            case 'auth/invalid-email':
                errorMessage = 'Invalid email address';
                break;
            case 'auth/user-not-found':
                errorMessage = 'No account found with this email';
                break;
            case 'auth/wrong-password':
                errorMessage = 'Incorrect password';
                break;
            case 'auth/too-many-requests':
                errorMessage = 'Too many attempts. Try again later';
                break;
            case 'auth/invalid-credential':
                errorMessage = 'Invalid email or password';
                break;
            default:
                errorMessage = error.message;
        }
        showToast(errorMessage, 'error');
        console.error('Login error:', error);
    } finally {
        loginBtnText.classList.remove('hidden');
        loginSpinner.classList.add('hidden');
        loginBtn.disabled = false;
    }
}

// Handle Signup
async function handleSignup() {
    const { createUserWithEmailAndPassword, updateProfile } = window.firebaseModules;
    const signupBtn = document.getElementById('signup-btn');
    const signupBtnText = document.getElementById('signup-btn-text');
    const signupSpinner = document.getElementById('signup-spinner');
    
    const name = document.getElementById('signup-name').value;
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;
    
    signupBtnText.classList.add('hidden');
    signupSpinner.classList.remove('hidden');
    signupBtn.disabled = true;
    
    try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        
        // Update profile with display name
        await updateProfile(userCredential.user, {
            displayName: name
        });
        
        // Save initial user data to Firestore
        const { setDoc, doc } = window.firebaseModules;
        await setDoc(doc(db, 'users', userCredential.user.uid), {
            uid: userCredential.user.uid,
            displayName: name,
            email: email,
            createdAt: new Date().toISOString(),
            role: 'user'
        });
        
        showToast('✅ Account created successfully!', 'success');
        console.log('User created:', userCredential.user);
        
    } catch (error) {
        let errorMessage = 'Signup failed';
        switch (error.code) {
            case 'auth/email-already-in-use':
                errorMessage = 'Email already registered';
                break;
            case 'auth/invalid-email':
                errorMessage = 'Invalid email address';
                break;
            case 'auth/weak-password':
                errorMessage = 'Password too weak (min 6 characters)';
                break;
            default:
                errorMessage = error.message;
        }
        showToast(errorMessage, 'error');
        console.error('Signup error:', error);
    } finally {
        signupBtnText.classList.remove('hidden');
        signupSpinner.classList.add('hidden');
        signupBtn.disabled = false;
    }
}

// Handle Password Reset
async function handlePasswordReset() {
    const { sendPasswordResetEmail } = window.firebaseModules;
    const resetBtn = document.getElementById('reset-btn');
    const resetBtnText = document.getElementById('reset-btn-text');
    const resetSpinner = document.getElementById('reset-spinner');
    
    const email = document.getElementById('reset-email').value;
    
    resetBtnText.classList.add('hidden');
    resetSpinner.classList.remove('hidden');
    resetBtn.disabled = true;
    
    try {
        await sendPasswordResetEmail(auth, email);
        showToast('✅ Password reset email sent! Check your inbox', 'success');
        
        // Switch back to login form after 2 seconds
        setTimeout(() => {
            switchToLogin();
        }, 2000);
        
    } catch (error) {
        let errorMessage = 'Failed to send reset email';
        switch (error.code) {
            case 'auth/invalid-email':
                errorMessage = 'Invalid email address';
                break;
            case 'auth/user-not-found':
                errorMessage = 'No account found with this email';
                break;
            default:
                errorMessage = error.message;
        }
        showToast(errorMessage, 'error');
        console.error('Password reset error:', error);
    } finally {
        resetBtnText.classList.remove('hidden');
        resetSpinner.classList.add('hidden');
        resetBtn.disabled = false;
    }
}

// Form switching functions
function switchToSignup() {
    document.getElementById('login-form').classList.add('hidden');
    document.getElementById('signup-form').classList.remove('hidden');
    document.getElementById('forgot-password-form').classList.add('hidden');
    document.getElementById('auth-title').textContent = 'Create Account';
    document.getElementById('auth-subtitle').textContent = 'Sign up to start controlling your smart home.';
}

function switchToLogin() {
    document.getElementById('login-form').classList.remove('hidden');
    document.getElementById('signup-form').classList.add('hidden');
    document.getElementById('forgot-password-form').classList.add('hidden');
    document.getElementById('auth-title').textContent = 'Welcome Back';
    document.getElementById('auth-subtitle').textContent = 'Log in to control your smart devices.';
}

function switchToForgotPassword() {
    document.getElementById('login-form').classList.add('hidden');
    document.getElementById('signup-form').classList.add('hidden');
    document.getElementById('forgot-password-form').classList.remove('hidden');
    document.getElementById('auth-title').textContent = 'Reset Password';
    document.getElementById('auth-subtitle').textContent = 'We\'ll help you recover your account.';
}

// Setup form switching event listeners
document.addEventListener('DOMContentLoaded', () => {
    // Initialize auth listener
    initializeAuthListener();
    
    // Form switching buttons
    document.getElementById('show-signup-link')?.addEventListener('click', switchToSignup);
    document.getElementById('show-login-link')?.addEventListener('click', switchToLogin);
    document.getElementById('forgot-password-link')?.addEventListener('click', switchToForgotPassword);
    document.getElementById('back-to-login-link')?.addEventListener('click', switchToLogin);
    
    // Password toggle for signup form
    document.getElementById('toggle-password-signup')?.addEventListener('click', () => {
        const passwordInput = document.getElementById('signup-password');
        const eyeOpen = document.getElementById('eye-open-signup');
        const eyeClosed = document.getElementById('eye-closed-signup');
        const isPassword = passwordInput.type === 'password';
        passwordInput.type = isPassword ? 'text' : 'password';
        eyeOpen.classList.toggle('hidden', !isPassword);
        eyeClosed.classList.toggle('hidden', isPassword);
    });
});
</script>

<!--
PART B: MODIFY showMainApp function (around line 2305)
Replace the existing showMainApp function with this updated version:
-->

<script>
const showMainApp = () => {
    authContainer.classList.add('hidden');
    mainAppContainer.classList.remove('hidden');
    mainControlsHeader.classList.remove('hidden');
    
    // Update greeting with user's name
    if (window.currentUser) {
        const greetingText = document.getElementById('greeting-text');
        if (greetingText) {
            const userName = window.currentUser.displayName || window.currentUser.email.split('@')[0];
            greetingText.textContent = `Welcome back, ${userName}!`;
        }
    }
    
    // Load Firebase data
    loadLogsFromFirebase().then(logs => {
        logEntries = logs;
        renderLog();
        console.log(`Loaded ${logs.length} logs from Firebase`);
    }).catch(err => console.error("Error loading logs:", err));
    
    loadApplianceConfigs().catch(err => console.error("Error loading appliance configs:", err));
    
    loadAnalyticsFromFirebase().then(data => {
        if (data) {
            usageData = data.usageData || usageData;
            hourlyActivity = data.hourlyActivity || hourlyActivity;
            yesterdayData = data.yesterdayData || yesterdayData;
            console.log("Analytics loaded from Firebase");
            
            if (typeof updateAllCharts === 'function') {
                updateAllCharts();
            }
        }
    }).catch(err => console.error("Error loading analytics:", err));
    
    // Connect to MQTT only after successful login
    connectMqtt();
};

const showAuth = () => {
    authContainer.classList.remove('hidden');
    mainAppContainer.classList.add('hidden');
    mainControlsHeader.classList.add('hidden');
    isManualDisconnect = true;
    if (client && client.isConnected()) {
        client.disconnect();
    }
    // Clear reconnect timer
    if (reconnectTimer) {
        clearTimeout(reconnectTimer);
        reconnectTimer = null;
    }
};

// Attach logout function to both buttons
logoutBtnDrawer.onclick = async () => {
    const { signOut } = window.firebaseModules;
    try {
        // Save logout activity
        await saveUserActivity('logout');
        await signOut(auth);
        showToast('Logged out successfully', 'success');
    } catch (error) {
        console.error('Logout error:', error);
        showToast('Logout failed', 'error');
    }
};

logoutBtnMain.onclick = async () => {
    const { signOut } = window.firebaseModules;
    try {
        // Save logout activity
        await saveUserActivity('logout');
        await signOut(auth);
        showToast('Logged out successfully', 'success');
    } catch (error) {
        console.error('Logout error:', error);
        showToast('Logout failed', 'error');
    }
};
</script>

<!--
PART C: Track device toggles in user activity
Add this code inside the toggleLight function (around line 3250) AFTER the MQTT publish:
-->

<script>
// Inside toggleLight function, add after client.send(message):
saveUserActivity('device_toggle', {
    deviceId: lightNum,
    deviceName: appliances[lightNum - 1].name,
    action: command,
    timestamp: new Date().toISOString()
}).catch(err => console.error('Failed to save toggle activity:', err));
</script>

