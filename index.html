<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Smart Home Automation</title>
    <!-- Tailwind CSS CDN - For development/testing only. For production, install via npm -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Date Adapter for time-based charts -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK v9+ (Modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, setDoc, doc, getDoc, getDocs, query, orderBy, limit, onSnapshot, deleteDoc, serverTimestamp, updateDoc, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, updateProfile, updateEmail, updatePassword, setPersistence, browserLocalPersistence, browserSessionPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref as dbRef, onValue, get, push, set, remove, query as dbQuery, orderByChild, startAt, endAt, limitToLast, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        
        window.firebaseModules = {
            initializeApp, getFirestore, getAuth, getStorage, getDatabase,
            signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut,
            sendPasswordResetEmail, updateProfile, updateEmail, updatePassword,
            setPersistence, browserLocalPersistence, browserSessionPersistence,
            collection, addDoc, setDoc, doc, getDoc, getDocs, query, orderBy, limit, onSnapshot, deleteDoc,
            serverTimestamp, updateDoc, where, ref, uploadBytes, getDownloadURL, deleteObject,
            dbRef, onValue, get, push, set, remove, dbQuery, orderByChild, startAt, endAt, limitToLast, update
        };
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            box-sizing: border-box;
        }
        
        html {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            touch-action: manipulation;
            scroll-behavior: smooth;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            background-attachment: fixed; /* Prevent background flickering on scroll */
            color: #1f2937;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            width: 100%;
            min-height: 100vh;
            /* Improve scroll performance and reduce flickering */
            -webkit-overflow-scrolling: touch;
            will-change: scroll-position;
        }

        /* Card styling */
        .card {
            background: rgba(249, 250, 251, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            box-shadow: 0 10px 40px -10px rgba(55, 65, 81, 0.15);
            border: 1px solid rgba(209, 213, 219, 0.6);
            transition: all 0.3s ease;
            /* Improve rendering performance */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        
        .card:hover {
            transform: translateY(-4px) translateZ(0);
            box-shadow: 0 20px 60px -15px rgba(55, 65, 81, 0.2);
        }

        /* Button styling */
        .btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: #fff;
            border-radius: 0.875rem;
            padding: 0.625rem 1.5rem;
            font-weight: 600;
            font-size: 0.95rem;
            box-shadow: 0 4px 16px 0 rgba(99, 102, 241, 0.3);
            border: none;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .btn:hover {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            box-shadow: 0 6px 20px 0 rgba(99, 102, 241, 0.4);
            transform: translateY(-1px);
        }
        
        .btn:active {
            transform: translateY(0px) scale(0.98);
        }

        /* Input styling */
        input[type="time"], input[type="text"], input[type="email"], input[type="password"], 
        input[type="date"], textarea, select {
            background: rgba(243, 244, 246, 0.95); /* Light mode default */
            border-radius: 0.75rem;
            border: 1.5px solid rgba(156, 163, 175, 0.4);
            font-size: 0.95rem;
            padding: 0.625rem 0.875rem;
            color: #1f2937; /* Light mode default */
            transition: all 0.2s ease;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* Dark mode specific input text color */
        body.dark-mode input[type="time"],
        body.dark-mode input[type="text"],
        body.dark-mode input[type="email"],
        body.dark-mode input[type="password"],
        body.dark-mode input[type="date"],
        body.dark-mode textarea,
        body.dark-mode select {
            color: var(--text-primary) !important;
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: #6366f1;
            outline: none;
            background: rgba(249, 250, 251, 0.98);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        input[type="checkbox"]:checked {
            background-color: #6366f1;
            border-color: #6366f1;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            background-size: 100% 100%;
            background-position: 50%;
            background-repeat: no-repeat;
        }

        /* Mobile-specific input fixes */
        @media (max-width: 768px) {
            /* Prevent iOS zoom on input focus */
            input[type="email"], input[type="password"], input[type="text"],
            input[type="time"], input[type="date"], textarea, select {
                font-size: 16px !important;
            }
            
            /* Ensure auth container is mobile-friendly */
            #auth-container, #signup-container, #forgot-password-container {
                width: 100%;
                min-height: 100vh;
                padding: 1rem;
            }
            
            /* Make cards responsive */
            .card {
                width: 100% !important;
                max-width: 100% !important;
                padding: 1.25rem !important;
            }
            
            /* Adjust buttons for mobile - minimum 44px touch target */
            .btn {
                min-height: 44px;
                padding: 0.75rem 1.25rem;
                font-size: 0.95rem;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }
            
            /* Better mobile form elements */
            input, textarea, select {
                width: 100%;
                max-width: 100%;
                min-height: 44px;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }
            
            /* Optimize transitions for mobile */
            .btn, .toggle-track, input, select, textarea {
                transition-duration: 0.2s !important;
            }
            
            /* Improve scroll performance on mobile */
            body, html {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
            
            /* Disable hover effects on mobile */
            .card:hover, .btn:hover {
                transform: none !important;
            }

            body {
                -webkit-tap-highlight-color: transparent;
            }

            /* Single column layouts on mobile */
            #page-faults .grid,
            .grid-cols-2, .grid-cols-3, .grid-cols-4 {
                grid-template-columns: 1fr !important;
            }
            
            /* Responsive headings */
            h1 { font-size: 1.75rem !important; }
            h2 { font-size: 1.5rem !important; }
            h3 { font-size: 1.25rem !important; }
            
            /* Better spacing for mobile */
            .space-y-6 > * + * { margin-top: 1rem !important; }
            .gap-6 { gap: 1rem !important; }
            
            /* Time range button groups */
            .flex.flex-wrap.gap-2 button {
                min-width: 60px;
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }
            
            /* Responsive stats cards */
            #pzem-stats-container > div,
            .stats-card {
                padding: 1rem !important;
            }
            
            /* Chart titles and labels */
            canvas {
                max-height: 300px;
            }
            
            /* Menu items - larger touch targets */
            button[id^="drawer-"],
            .accordion-toggle {
                min-height: 48px;
                padding: 0.75rem 1rem !important;
                font-size: 1rem !important;
            }
            
            /* Toggle switches - easier to tap */
            .toggle-switch {
                width: 60px !important;
                height: 36px !important;
            }
            
            /* Log container */
            #log-container {
                font-size: 0.8rem;
                max-height: 400px !important;
            }
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 32px;
            cursor: pointer;
        }
        
        .toggle-checkbox {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-track {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white; /* Changed to white */
            border: 1.5px solid #1f2937; /* Black outline */
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .toggle-thumb {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 26px;
            height: 26px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .toggle-checkbox:checked + .toggle-track {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
        }
        
        .toggle-checkbox:checked ~ .toggle-thumb {
            transform: translateX(24px);
        }

        /* Dark mode overrides for generic toggles */
        body.dark-mode .toggle-track {
            box-shadow: none !important;
            border: 1.5px solid #1f2937 !important; /* Ensure black border in dark mode */
        }
        
        body.dark-mode .toggle-checkbox:checked + .toggle-track {
            background: #22c55e !important; /* Green for checked state in dark mode */
            box-shadow: none !important;
        }
        
        body.dark-mode .toggle-thumb {
            background: #ffffff; /* Pure white thumb in dark mode */
        }

        /* Dark mode overrides for specific Tailwind-styled toggles (Safety Mechanism, Fault Protection) */
        body.dark-mode input.sr-only.peer ~ span.bg-gray-300 {
            background-color: #555555 !important; /* Gray track when unchecked in dark mode */
            border-width: 1.5px !important;
            border-style: solid !important;
            border-color: #ffffff !important; /* White border for track in dark mode */
        }

        /* Specific rule for the thumb when the toggle is OFF in dark mode */
        body.dark-mode input.sr-only.peer:not(:checked) ~ span.bg-white {
            background-color: #333333 !important; /* Dark gray thumb when unchecked in dark mode */
            border-color: #333333 !important; /* Dark gray border for thumb */
        }



        body.dark-mode input.sr-only.peer ~ span.bg-white {
            background-color: #ffffff !important; /* White thumb */
            border-color: #ffffff !important; /* White border for thumb */
        }
        
        body.dark-mode input.sr-only.peer:checked ~ span.peer-checked\:bg-green-500 {
            background-color: #22c55e !important; /* Ensure green for checked state */
        }
        
        body.dark-mode input.sr-only.peer:checked ~ span.peer-checked\:border-white {
            border-color: #ffffff !important; /* Ensure white border for thumb in checked state */
        }

        /* Fire Alarm Banner */
        #flame-alarm-banner {
            animation: pulse-bg 1s infinite;
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px rgba(220, 38, 38, 0.8);
            z-index: 100;
        }
        
        @keyframes pulse-bg {
            0%, 100% { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); }
            50% { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        }

        /* Fault Alarm Banner */
        #fault-alarm-banner {
            animation: pulse-bg-fault 1s infinite;
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px rgba(234, 179, 8, 0.8);
            z-index: 100;
        }

        @keyframes pulse-bg-fault {
            0%, 100% { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
            50% { background: linear-gradient(135deg, #fbbd23 0%, #f59e0b 100%); }
        }

        /* Appliance Icons */
        .appliance-icon {
            color: #94a3b8;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .icon-on[data-type="light"] .appliance-icon,
        .icon-on[data-type="other"] .appliance-icon {
            color: #f59e0b;
            filter: drop-shadow(0 0 8px rgba(245, 158, 11, 0.8));
            animation: glow-pulse 2s ease-in-out infinite;
        }
        
        @keyframes glow-pulse {
            0%, 100% { filter: drop-shadow(0 0 8px rgba(245, 158, 11, 0.8)); }
            50% { filter: drop-shadow(0 0 12px rgba(245, 158, 11, 1)); }
        }
        
        .icon-on[data-type="fan"] .appliance-icon {
            color: #38bdf8;
            filter: drop-shadow(0 0 12px rgba(56, 189, 248, 0.8));
            animation: spin 1.5s linear infinite, fan-glow 2s ease-in-out infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes fan-glow {
            0%, 100% { filter: drop-shadow(0 0 12px rgba(56, 189, 248, 0.8)); }
            50% { filter: drop-shadow(0 0 16px rgba(56, 189, 248, 1)); }
        }

        /* Card States */
        .card-on {
            border-color: rgba(245, 158, 11, 0.5);
            background: linear-gradient(135deg, rgba(249, 250, 251, 0.7) 0%, rgba(254, 243, 199, 0.3) 100%);
            box-shadow: 0 0 25px rgba(245, 158, 11, 0.25);
        }

        /* Dark mode overrides for Appliance Icons */
        body.dark-mode .icon-on[data-type="light"] .appliance-icon,
        body.dark-mode .icon-on[data-type="other"] .appliance-icon {
            color: #FFFFFF; /* White when on */
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.5)); /* White glow */
            animation: dark-mode-glow-pulse 2s ease-in-out infinite;
        }
        
        @keyframes dark-mode-glow-pulse { /* Renamed to avoid conflicts, made top-level */
            0%, 100% { filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.5)); }
            50% { filter: drop-shadow(0 0 12px rgba(255, 255, 255, 0.7)); }
        }
        
        body.dark-mode .icon-on[data-type="fan"] .appliance-icon {
            color: #FFFFFF; /* White when on */
            filter: drop-shadow(0 0 12px rgba(255, 255, 255, 0.5)); /* White glow */
            animation: spin 1.5s linear infinite, dark-mode-fan-glow 2s ease-in-out infinite;
        }
        
        @keyframes dark-mode-fan-glow { /* Renamed to avoid conflicts, made top-level */
            0%, 100% { filter: drop-shadow(0 0 12px rgba(255, 255, 255, 0.5)); }
            50% { filter: drop-shadow(0 0 16px rgba(255, 255, 255, 0.7)); }
        }

        /* Drawer styles */
        .drawer {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 4px 0 40px rgba(0, 0, 0, 0.2);
        }
        
        .drawer-closed {
            transform: translateX(-100%);
        }
        
        .drawer-open {
            transform: translateX(0);
        }

        /* Accordion */
        .accordion-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 0.875rem 1rem;
            font-weight: 600;
            color: #4338ca; /* Light mode default */
            background: linear-gradient(135deg, rgba(238, 242, 255, 0.8) 0%, rgba(224, 231, 255, 0.6) 100%); /* Light mode default */
            border-radius: 0.75rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(199, 210, 254, 0.5); /* Light mode default */
        }
        
        .accordion-toggle:hover {
            background: linear-gradient(135deg, rgba(224, 231, 255, 0.9) 0%, rgba(199, 210, 254, 0.7) 100%); /* Light mode default */
            transform: translateY(-2px);
        }

        /* Dark mode overrides for Accordion */
        body.dark-mode .accordion-toggle {
            color: var(--text-primary); /* White text */
            background: var(--card-bg); /* Dark gray background */
            border-color: var(--card-border);
        }

        body.dark-mode .accordion-toggle:hover {
            background: #333333; /* Slightly lighter dark gray on hover */
        }
        
        .accordion-content {
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 0;
            will-change: max-height; /* Hint to browser for smoother transitions */
        }

        /* Navigation tabs */
        .nav-tab {
            background: transparent;
            color: #6b7280; /* Light mode default */
            border: none;
            cursor: pointer;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease;
        }

        .nav-tab:hover {
            color: #4b5563; /* Light mode default */
            background: rgba(99, 102, 241, 0.1); /* Light mode default */
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); /* Light mode default */
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        
        /* Dark mode overrides for Nav Tabs */
        body.dark-mode .nav-tab {
            color: var(--muted); /* Secondary gray text */
        }
        
        body.dark-mode .nav-tab:hover {
            color: var(--text-primary); /* White text on hover */
            background: rgba(255,255,255,0.08); /* Subtle gray hover background */
        }
        
        body.dark-mode .nav-tab.active {
            background: #333333; /* Darker gray for active tab */
            color: var(--text-primary); /* White text for active tab */
            box-shadow: none; /* Remove colored shadow */
        }
        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Chart container */
        .chart-container {
            position: relative;
            background: rgba(249, 250, 251, 0.8);
            border-radius: 1rem;
            padding: 1rem;
            max-width: 100%;
            overflow: hidden;
        }
        
        @media (max-width: 640px) {
            .chart-container {
                padding: 0.5rem;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(148, 163, 184, 0.1);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 4px;
        }

        /* Fade in animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            opacity: 0;
        }

        /* Microphone icon specific styling */
        .microphone-icon {
            position: fixed;
            bottom: calc(5rem + 1.25rem); /* Adjust based on navbar height + spacing */
            right: 1.25rem; /* 5 units from right */
            background-color: #6366f1; /* indigo-600 */
            color: #fff;
            width: 4rem; /* w-16 */
            height: 4rem; /* h-16 */
            border-radius: 9999px; /* rounded-full */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 110; /* z-40 */
            transition: all 0.3s ease;
        }

        .microphone-icon:hover {
            transform: scale(1.05);
            background-color: #4f46e5; /* indigo-700 */
        }

        .microphone-icon.listening {
            animation: pulse-microphone 1.5s infinite;
            background-color: #ef4444; /* red-500 */
        }

        @keyframes pulse-microphone {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

        /* ensure the nav-tab styling has enough z-index to not overlap it */
        .nav-tab {
            z-index: 30; /* Ensure nav-tabs are below microphone */
        }

        /* Sensor Cards Styling */
        .sensor-card {
            background: linear-gradient(135deg, rgba(249, 250, 251, 0.95) 0%, rgba(243, 244, 246, 0.95) 100%);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 10px 40px -10px rgba(55, 65, 81, 0.15);
            border: 1px solid rgba(209, 213, 219, 0.6);
            transition: all 0.3s ease;
        }

        .sensor-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 60px -15px rgba(55, 65, 81, 0.2);
        }

        .sensor-value-big {
            font-size: 3rem;
            font-weight: bold;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        body.dark-mode .sensor-value-big {
            color: var(--text-primary) !important;
            -webkit-text-fill-color: var(--text-primary) !important;
            background: none !important;
        }

        body.dark-mode .text-gray-500 {
            color: var(--muted) !important; /* Ensures gray-500 text is readable in dark mode */
        }

        .sensor-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .trend-indicator {
            display: inline-block;
            margin-left: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .trend-up { color: #ef4444; }
        .trend-down { color: #10b981; }
        .trend-stable { color: #6b7280; }

        .motion-pulse {
            animation: motion-pulse 1.5s ease-in-out infinite;
        }

        @keyframes motion-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .gas-alarm-active {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
            color: white !important;
            animation: pulse-bg 1s infinite;
        }
    </style>

    <!-- Dark theme variables & overrides (keeps design professional and readable) -->
    <style>
        :root {
            --bg-gradient-light: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            --bg-gradient-dark: linear-gradient(135deg, #071127 0%, #0b1220 100%);
            --page-bg: #f8fafc;
            --text-primary: #1f2937;
            --muted: #6b7280;
            --card-bg: rgba(249,250,251,0.95);
            --card-border: rgba(209,213,219,0.6);
            --accent: #6366f1;
            --accent-2: #8b5cf6;
            --glass: rgba(255,255,255,0.04);
            --input-bg: rgba(243,244,246,0.95);
            --btn-bg-start: #6366f1;
            --btn-bg-end: #8b5cf6;
        }

        /* Dark-mode overrides - apply by adding .dark-mode to <body> */
        body.dark-mode {
            background: linear-gradient(135deg, #181818 0%, #212121 100%) !important; /* YouTube Dark Background */
            color: #FFFFFF !important; /* Primary White Text */
            --page-bg: #181818;
            --text-primary: #FFFFFF;
            --muted: #AAAAAA; /* Secondary Gray Text */
            --card-bg: #212121; /* YouTube Surface/Cards */
            --card-border: rgba(255,255,255,0.1); /* Subtle border */
            --glass: rgba(255,255,255,0.05);
            --input-bg: #333333; /* Darker Input Field */
            --btn-bg-start: #3A3A3A; /* Neutral Gray Button Start (YouTube-like) */
            --btn-bg-end: #2B2B2B; /* Neutral Gray Button End (YouTube-like) */
            -webkit-font-smoothing: antialiased;
        }

        /* Use variables for key components to give cohesive dark look */
        body.dark-mode, 
        body.dark-mode .card, 
        body.dark-mode .sensor-card, 
        body.dark-mode .chart-container, 
        body.dark-mode .accordion-item,
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3, body.dark-mode h4, body.dark-mode p, body.dark-mode span, body.dark-mode div, body.dark-mode label, body.dark-mode small {
            background: var(--card-bg) !important; /* Ensures nested elements inherit dark background */
            color: var(--text-primary) !important; /* Ensures all text is white */
            border-color: var(--card-border) !important;
        }

        .card:hover { box-shadow: 0 18px 50px -20px rgba(2,6,23,0.8); }

        body.dark-mode input[type="time"], body.dark-mode input[type="text"], body.dark-mode input[type="email"], body.dark-mode input[type="password"], body.dark-mode input[type="number"], body.dark-mode textarea, body.dark-mode select {
            background: var(--input-bg) !important;
            color: var(--text-primary) !important;
            border-color: rgba(148,163,184,0.12) !important;
        }

        .btn {
            background: linear-gradient(135deg, var(--btn-bg-start) 0%, var(--btn-bg-end) 100%) !important;
            color: #ffffff !important;
        }

        /* Theme toggle appearance */
        #theme-track { display: inline-block; width: 56px; height: 32px; border-radius: 16px; transition: all 0.25s ease; }
        #theme-thumb { position: absolute; top: 3px; left: 3px; width: 26px; height: 26px; border-radius: 50%; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition: all 0.25s cubic-bezier(0.4,0,0.2,1); }
        
        /* Light Mode Defaults for Track (when OFF) */
        #theme-toggle:not(:checked) + #theme-track { background: #d1d5db; /* gray-300 */ }
        /* Light Mode Track (when ON) */
        #theme-toggle:checked + #theme-track { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); /* green */ }


        /* Dark Mode styles */
        body.dark-mode #theme-toggle:not(:checked) + #theme-track { background: #555555; /* Dark gray for OFF state in dark mode */ box-shadow: none !important; border: 1.5px solid rgba(255,255,255,0.1); }
        body.dark-mode #theme-toggle:checked + #theme-track { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important; /* Green gradient for checked state in dark mode */ box-shadow: none !important; }
        
        body.dark-mode #theme-thumb { background: #ffffff; /* Pure white thumb in dark mode */ }
        body.dark-mode #theme-toggle:checked ~ #theme-thumb { transform: translateX(24px); } /* Ensure thumb moves */

        /* Subtle shadow on dark cards */
        body.dark-mode .card { box-shadow: 0 10px 30px rgba(2,6,23,0.6); }

        /* Toasts in dark mode */
        body.dark-mode #toast-container > div { filter: drop-shadow(0 0 30px rgba(0,0,0,0.6)); }

        /* Dark mode for power price input container */
        body.dark-mode .power-price-input-container {
            background: var(--input-bg) !important;
            color: var(--text-primary) !important;
        }


        /* Dark mode for time range buttons in Analytics - Consolidated */
        body.dark-mode .time-range-btn,
        body.dark-mode .pzem-time-range-btn,
        body.dark-mode .device-time-btn { /* Added device-time-btn */
            background: #a0a0a0 !important; /* Light gray background for inactive buttons */
            color: #ffffff !important; /* White text */
            border: 1.5px solid #a0a0a0 !important; /* Border matches background */
        }

        body.dark-mode .time-range-btn.active,
        body.dark-mode .pzem-time-range-btn.active,
        body.dark-mode .device-time-btn.active { /* Added device-time-btn.active */
            background: #000000 !important; /* Black background for active state */
            color: #ffffff !important; /* White text */
            border: 1.5px solid #000000 !important; /* Border matches background */
        }        /* Dark mode overrides for specific Tailwind-styled toggles (Safety Mechanism, Fault Protection) */
        body.dark-mode input.sr-only.peer ~ span.bg-gray-300 {
            background-color: #555555 !important; /* Dark gray track when unchecked */
        }

        body.dark-mode input.sr-only.peer ~ span.bg-white {
            background-color: #ffffff !important; /* White thumb */
            border-color: #ffffff !important; /* White border for thumb */
        }
        
        body.dark-mode input.sr-only.peer:checked ~ span.peer-checked\:bg-green-500 {
            background-color: #22c55e !important; /* Ensure green for checked state */
        }
        
        body.dark-mode input.sr-only.peer:checked ~ span.peer-checked\:border-white {
            border-color: #ffffff !important; /* Ensure white border for thumb in checked state */
        }

        /* Dark mode for About section text */
        body.dark-mode #accordion-about *,
        body.dark-mode #accordion-about p,
        body.dark-mode #accordion-about span,
        body.dark-mode #accordion-about h3,
        body.dark-mode #accordion-about li,
        body.dark-mode #accordion-about a {
            color: var(--text-primary) !important; /* All text in About section should be white */
        }
        body.dark-mode #accordion-about svg {
            color: var(--text-primary) !important; /* Icons in About section should be white */
        }
        
        /* Dark mode override for timer list items (bg-gray-100) */
        body.dark-mode .accordion-content .bg-gray-100 {
            background-color: var(--input-bg) !important; /* Use a dark background for timer items */
            border-color: var(--card-border) !important;
        }
    </style>

</head>
<body class="bg-slate-50">

    <!-- Fire Alarm Banner -->
    <div id="flame-alarm-banner" class="hidden fixed top-0 left-0 right-0 z-[100] text-white text-center py-5 px-4">
        <div class="text-3xl font-extrabold">ðŸ”¥ FIRE ALARM TRIGGERED! ðŸ”¥</div>
    </div>

    <!-- Fault Alarm Banner -->
    <div id="fault-alarm-banner" class="hidden fixed top-0 left-0 right-0 z-[100] text-white text-center py-5 px-4">
        <div id="fault-banner-content" class="text-3xl font-extrabold">âš¡ FAULT DETECTED! âš¡</div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 flex flex-col gap-2 items-center"></div>

    <!-- Drawer and Backdrop Removed -->

    <!-- Auth Container -->
        <div id="auth-container" class="flex items-center justify-center min-h-screen p-4">
            <div class="card w-full max-w-md p-8">
                <h1 class="text-3xl font-bold text-center mb-6 text-indigo-700">Smart Home</h1>
                
                <!-- Login Form -->
                <form id="login-form" autocomplete="on">
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Email</label>
                                <input type="email" id="login-email" name="email" autocomplete="email" required placeholder="email@example.com" inputmode="email">
                            </div>
                    <div class="mb-4 relative">
                        <label for="login-password" class="block text-sm font-medium mb-2">Password</label>
                        <input type="password" id="login-password" name="password" autocomplete="current-password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 top-7 px-3 flex items-center text-gray-500">
                            <svg id="eye-open" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            <svg id="eye-closed" class="h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .95-3.036 3.37-5.456 6.125-6.5M16.5 7.5c.325.325.625.675.9 1.05M17.5 12a5.5 5.5 0 01-1.013 3.487M21 4l-2.939 2.939" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21l2.939-2.939" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.5 14.5c.325.325.675.625 1.05.9" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 12l2.5 2.5" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.5 9.5c-.325-.325-.625-.675-.9-1.05" />
                            </svg>
                        </button>
                    </div>
                    <div class="mb-6 flex items-center">
                        <input type="checkbox" id="remember-me" class="w-4 h-4 text-indigo-600 bg-gray-100 border-gray-300 rounded focus:ring-indigo-500 focus:ring-2">
                        <label for="remember-me" class="ml-2 text-sm text-gray-700">
                            Remember me <span class="text-xs text-gray-500">(Stay logged in)</span>
                        </label>
                    </div>
                    <button type="submit" class="btn w-full">Login</button>
                </form>
                
                <div class="flex justify-between items-center mt-4 text-sm">
                    <button id="forgot-password-btn" class="text-indigo-600 hover:text-indigo-800 font-semibold">
                        Forgot Password?
                    </button>
                    <p class="text-gray-600">
                        Don't have an account? <button id="switch-to-signup" class="text-indigo-600 font-semibold">Sign Up</button>
                    </p>
                </div>
            </div>
        </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const togglePassword = document.getElementById('toggle-password');
        const password = document.getElementById('login-password');
        const eyeOpen = document.getElementById('eye-open');
        const eyeClosed = document.getElementById('eye-closed');
    
        togglePassword.addEventListener('click', function (e) {
            // toggle the type attribute
            const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
            password.setAttribute('type', type);
            // toggle the eye / eye-slash icon
            eyeOpen.classList.toggle('hidden');
            eyeClosed.classList.toggle('hidden');
        });
    });
    </script>

    <!-- Forgot Password Form (Hidden) -->
    <div id="forgot-password-container" class="hidden flex items-center justify-center min-h-screen p-4">
        <div class="card w-full max-w-md p-8">
            <h1 class="text-3xl font-bold text-center mb-2 text-indigo-700">Reset Password</h1>
            <p class="text-center text-gray-600 mb-6 text-sm">Enter your email to receive a password reset link</p>
            
            <form id="forgot-password-form">
                <div class="mb-6">
                    <label for="reset-email" class="block text-sm font-medium mb-2">Email</label>
                    <input type="email" id="reset-email" required placeholder="email@example.com">
                </div>
                <button type="submit" class="btn w-full">Send Reset Link</button>
            </form>
            
            <p class="text-center mt-4 text-sm text-gray-600">
                Remember your password? <button id="switch-to-login-from-forgot" class="text-indigo-600 font-semibold">Login</button>
            </p>
        </div>
    </div>

    <!-- Signup Form (Hidden) -->
    <div id="signup-container" class="hidden flex items-center justify-center min-h-screen p-4">
        <div class="card w-full max-w-md p-8">
            <h1 class="text-3xl font-bold text-center mb-6 text-indigo-700">Create Account</h1>
            
            <form id="signup-form" autocomplete="on">
                <div class="mb-4">
                    <label for="signup-name" class="block text-sm font-medium mb-2">Name</label>
                    <input type="text" id="signup-name" name="name" autocomplete="name" required placeholder="Your Name" inputmode="text">
                </div>
                <div class="mb-4">
                    <label for="signup-email" class="block text-sm font-medium mb-2">Email</label>
                    <input type="email" id="signup-email" name="email" autocomplete="email" required placeholder="email@example.com" inputmode="email">
                </div>
                <div class="mb-6">
                    <label for="signup-password" class="block text-sm font-medium mb-2">Password</label>
                    <input type="password" id="signup-password" name="password" autocomplete="new-password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button type="submit" class="btn w-full">Sign Up</button>
            </form>
            
            <p class="text-center mt-4 text-sm text-gray-600">
                Already have an account? <button id="switch-to-login" class="text-indigo-600 font-semibold">Login</button>
            </p>
        </div>
    </div>

    <!-- Main App -->
    <main id="main-app" class="hidden w-full max-w-6xl mx-auto p-4 space-y-6 pb-20">

        
        <!-- Navigation Tabs -->
        <div class="fixed bottom-0 left-0 right-0 z-30 bg-white shadow-[0_-1px_3px_0_rgba(0,0,0,0.1)] flex justify-around p-2">
            <button class="nav-tab active" data-page="control">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </button>
            <button class="nav-tab" data-page="monitor">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
            </button>
            <button class="nav-tab" data-page="analytics">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
            </button>
            <button class="nav-tab" data-page="menu">
                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>

        <!-- Fire Alarm Page -->
        <div id="page-fire-alarm" class="hidden space-y-6">
            <div class="card p-6">
                <h2 class="text-2xl font-bold text-gray-800">Fire Alarm</h2>
            </div>
            <!-- Fire Alarm Test -->
            <div class="card p-6">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">ðŸ”¥</span>
                        <h2 class="text-xl font-bold text-gray-800">Fire Alarm Control</h2>
                    </div>
                    <div class="flex flex-wrap justify-center gap-2">
                        <button id="test-alarm-btn-page" class="btn bg-orange-500 hover:bg-orange-600 text-sm">Test Alarm</button>
                        <button id="stop-alarm-btn-page" class="btn bg-gray-400 text-sm" disabled>Stop Alarm</button>
                    </div>
                </div>
                <div id="fire-alarm-appliances-off" class="hidden mt-4 p-4 bg-red-100 border border-red-200 rounded-lg text-sm text-red-700">
                    <p><strong>All appliances have been turned off as a safety precaution.</strong></p>
                </div>
            </div>

            <!-- Fire Safety Mechanism Toggle -->
            <div class="card p-6">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <h2 class="text-xl font-bold text-gray-800">Fire Safety Mechanism</h2>
                    <label for="safety-mechanism-toggle" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="safety-mechanism-toggle" class="sr-only peer">
                        <span class="w-14 h-8 bg-gray-300 rounded-full peer peer-checked:bg-green-500 transition-all duration-300" aria-hidden="true"></span>
                        <span class="absolute left-1 top-1 bg-white border-gray-300 border w-6 h-6 rounded-full transition-all duration-300 peer-checked:transform peer-checked:translate-x-full peer-checked:border-white" aria-hidden="true"></span>
                    </label>
                </div>
                <div id="safety-mechanism-explanation" class="mt-4 text-sm text-gray-700 space-y-3">
                    <div id="safety-on-explanation" class="hidden p-4 bg-green-50 border-l-4 border-green-500">
                        <h4 class="font-semibold text-green-800">Mechanism ON: Proactive Protection</h4>
                        <p>When the safety mechanism is <strong>ON</strong>, your home is under active protection. In normal conditions, all your devices will function as usual. However, the instant a fire is detected, the system will automatically and forcibly turn <strong>OFF</strong> all connected electrical appliances. This action is crucial to prevent electrical faults from escalating the fire. Devices will remain in this locked-off state, and cannot be turned on manually, until the fire alarm has been silenced by pressing the "Stop Alarm" button.</p>
                    </div>
                    <div id="safety-off-explanation" class="p-4 bg-red-50 border-l-4 border-red-500">
                        <h4 class="font-semibold text-red-800">Mechanism OFF: Manual Control</h4>
                        <p>When the safety mechanism is <strong>OFF</strong>, the automatic shutdown protocol is disabled. If a fire is detected, the fire alarm will still sound, but your electrical devices will remain in their current state (on or off). You will have full manual control over your appliances, but the system will not automatically intervene to turn them off. This mode should only be used temporarily or for maintenance purposes.</p>
                    </div>
                </div>
            </div>

            <!-- Fire Alarm History -->
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">ðŸ”¥ Fire Alarm History</h2>
                    <button id="refresh-alarm-history-btn-page" class="btn text-sm">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                
                <div class="chart-container mb-6" style="height: 250px;">
                    <h3 class="text-sm font-semibold mb-2 text-center">Weekly Alarm Summary</h3>
                    <canvas id="fireAlarmChart"></canvas>
                </div>

                <div id="alarm-history-container-page" class="space-y-3" style="max-height: 300px; overflow-y: auto;">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading alarm history...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Page -->
        <div id="page-control" class="space-y-6">
            <!-- Control Section -->
            <div class="card p-6">
                <div class="flex items-center justify-between mb-4">
    <h2 class="text-2xl font-bold">Control</h2>
    <button id="reconnect-btn" class="btn btn-sm text-xs">Refresh</button>
</div>
<div class="space-y-6">
    <!-- Dashboard Overview -->
    <div class="card p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Dashboard Overview</h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-3 gap-3">
            <!-- Firebase Status Box - Stretched -->
            <div id="firebase-status" class="col-span-full bg-gradient-to-br from-indigo-50 to-purple-100 p-4 rounded-xl flex items-center justify-center gap-2 text-sm font-semibold text-gray-600">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M17.15 11.23c-1.37-1.3-3.08-2.11-4.95-2.29V3.53a.85.85 0 00-.85-.85H8.76a.85.85 0 00-.85.85v1.27c-2.48.33-4.47 1.95-5.32 4.1a.85.85 0 00.32 1.05l1.62.97a.85.85 0 001.07-.15c.67-1.15 1.76-2.07 3.06-2.58a.85.85 0 00.58-.8v-.03c.3-.01.6-.02.9-.02 2.76 0 5 2.24 5 5s-2.24 5-5 5c-.3 0-.6-.01-.9-.02a.85.85 0 00-.58-.8V19.7a.85.85 0 00.85.85h2.59a.85.85 0 00.85-.85v-5.41c1.87-.18 3.58-.99 4.95-2.29a.85.85 0 00.22-1.07.84.84 0 00-.22-1.07zm-1.7 2.21c-.8.76-1.84 1.2-2.93 1.2a.85.85 0 00-.85.85v3.19h-2.59V14.6c-1.09 0-2.13-.44-2.93-1.2-.42-.4-.6-.97-.53-1.52.07-.55.35-1.02.78-1.35.8-.76 1.84-1.2 2.93-1.2a.85.85 0 00.85-.85V4.38h2.59V9.4c1.09 0 2.13.44 2.93 1.2.42.4.6.97.53 1.52-.07.55-.35 1.02-.78 1.35z"/></svg>
                <span id="firebase-status-text">Connecting to Firebase...</span>
            </div>
            <div id="mqtt-status" class="bg-gradient-to-br from-gray-50 to-gray-100 p-4 rounded-xl flex items-center gap-2 text-xs font-semibold text-red-500">
                <svg class="w-3 h-3" viewBox="0 0 12 12" fill="currentColor"><circle cx="6" cy="6" r="6"/></svg>
                <span>MQTT</span>
            </div>
            <div id="esp-status" class="bg-gradient-to-br from-gray-50 to-gray-100 p-4 rounded-xl flex items-center gap-2 text-xs font-semibold text-red-500">
                <svg id="esp-status-icon" class="w-3 h-3" viewBox="0 0 12 12" fill="currentColor"><circle cx="6" cy="6" r="6"/></svg>
                <span>ESP</span>
            </div>
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl">
                <p class="text-sm text-gray-600">Total Devices</p>
                <p id="dashboard-total-lights" class="text-2xl font-bold text-blue-600">4</p>
            </div>
            <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl">
                <p class="text-sm text-gray-600">Devices ON</p>
                <p id="dashboard-on-count" class="text-2xl font-bold text-green-600">0</p>
            </div>
            <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-xl">
                <p class="text-sm text-gray-600">Devices OFF</p>
                <p id="dashboard-off-count" class="text-2xl font-bold text-red-600">4</p>
            </div>
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl">
                <p class="text-sm text-gray-600">Status</p>
                <p id="dashboard-timer-status" class="text-sm font-semibold text-gray-700 mt-2">No Timer</p>
            </div>
        </div>
    </div>

                    <!-- Voice Control -->
                    <div class="card p-6 bg-gradient-to-br from-indigo-50 to-purple-50">
                        <div class="flex items-center mb-4">
                            <svg class="w-8 h-8 text-indigo-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                            </svg>
                            <h2 class="text-xl font-bold text-indigo-700">Voice Control</h2>
                        </div>
                        <button id="voice-btn" class="btn mb-2 w-full">ðŸŽ¤ Start Listening</button>
                        <p id="voice-status" class="text-sm text-indigo-600 min-h-[20px] mb-3"></p>
                        
                        <!-- Voice Commands Help -->
                        <details class="text-xs text-gray-600 mt-3">
                            <summary class="cursor-pointer hover:text-indigo-600 font-semibold">ðŸ“‹ Available Commands</summary>
                            <div class="mt-2 space-y-1 pl-4 border-l-2 border-indigo-200" style="word-break: break-word; overflow-wrap: break-word;">
                                <p><strong>Lights:</strong></p>
                                <p>â€¢ "Turn on all lights" / "Turn off all lights"</p>
                                <p>â€¢ "Turn on light 1" (or 2, 3, 4)</p>
                                <p>â€¢ "Turn off light 2" (or 1, 3, 4)</p>
                                <p class="mt-2"><strong>Fans:</strong></p>
                                <p>â€¢ "Turn on fan" / "Turn off fan"</p>
                                <p>â€¢ "Turn on fan 1" (or 2)</p>
                                <p>â€¢ "Set fan speed to 50 percent"</p>
                                <p>â€¢ "Set fan 1 speed to 75 percent"</p>
                                <p>â€¢ "Fan low" / "Fan medium" / "Fan high"</p>
                                <p>â€¢ "Fan 2 low" / "Fan 1 high"</p>
                                <p class="mt-2"><strong>Sensors:</strong></p>
                                <p>â€¢ "What is the temperature?"</p>
                                <p>â€¢ "Humidity" (asks for current humidity)</p>
                                <p class="mt-2"><strong>Alarm:</strong></p>
                                <p>â€¢ "Stop alarm" (stops fire alarm)</p>
                                <p class="mt-2"><strong>Navigation:</strong></p>
                                <p>â€¢ "Open [Control/Monitor/Analytics/Logs/Faults/Menu/Fire Alarm] page"</p>
                                <p>â€¢ "Go to [Control/Monitor/Analytics/Logs/Faults/Menu/Fire Alarm]"</p>
                                <p class="mt-2"><strong>Sensor Data:</strong></p>
                                <p>â€¢ "What is the gas level?"</p>
                                <p>â€¢ "Show me motion status"</p>
                                <p>â€¢ "What is the current power consumption?"</p>
                                <p>â€¢ "What is the current voltage?"</p>
                            </div>
                        </details>
                    </div>

                    <!-- Quick Actions -->
                    <div class="flex gap-4">
                        <button id="turn-all-on" class="btn flex-1">Turn All ON</button>
                        <button id="turn-all-off" class="btn bg-gray-600 hover:bg-gray-700 flex-1">Turn All OFF</button>
                    </div>

                    <!-- Device Cards -->
                    <div id="light-card-container" class="grid grid-cols-1 md:grid-cols-1 gap-6"></div>
                </div>
            </div>
        </div>

        <!-- Monitor Page -->
        <div id="page-monitor" class="hidden space-y-6">
             <!-- Gas Alarm Banner -->
            <div id="gas-alarm-banner" class="hidden bg-red-600 text-white p-6 rounded-2xl shadow-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-2xl font-bold flex items-center">
                            <svg class="w-8 h-8 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            GAS ALERT!
                        </h3>
                        <p id="gas-alarm-message" class="mt-2">High gas concentration detected. Please ventilate the area immediately.</p>
                    </div>
                    <button onclick="acknowledgeGasAlarm()" class="btn bg-white text-red-600 hover:bg-gray-100">
                        Acknowledge
                    </button>
                </div>
            </div>

            <!-- Monitor Section -->
            <div class="card p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Monitor</h2>
                <div class="space-y-6">
                    <!-- Real-time Sensor Cards -->
                    <div id="sensor-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
                        
                        <!-- Temperature Card -->
                        <div class="sensor-card">
                            <div class="sensor-icon text-red-500">ðŸŒ¡ï¸</div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">Temperature</h3>
                            <div class="sensor-value-big" id="sensor-temperature">--Â°C</div>
                            <div class="text-sm text-gray-600 mt-2">
                                Room Temperature
                                <span id="temp-trend" class="trend-indicator"></span>
                            </div>
                            <div class="text-xs text-gray-500 mt-2" id="temp-update">Last update: --</div>
                        </div>

                        <!-- Humidity Card -->
                        <div class="sensor-card">
                            <div class="sensor-icon text-blue-500">ðŸ’§</div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">Humidity</h3>
                            <div class="sensor-value-big" id="sensor-humidity">--%</div>
                            <div class="text-sm text-gray-600 mt-2">
                                Relative Humidity
                                <span id="humidity-trend" class="trend-indicator"></span>
                            </div>
                            <div class="text-xs text-gray-500 mt-2" id="humidity-update">Last update: --</div>
                        </div>

                        <!-- Gas Level Card -->
                        <div class="sensor-card" id="gas-level-card">
                            <div class="sensor-icon text-orange-500">ðŸ’¨</div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">Air Quality</h3>
                            <div class="sensor-value-big" id="sensor-gas">--%</div>
                            <div class="text-sm text-gray-600 mt-2">
                                Gas Level <span id="gas-raw" class="text-xs">(0/1024)</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-2" id="gas-update">Last update: --</div>
                        </div>

                        <!-- Motion Sensor Card -->
                        <div class="sensor-card">
                            <div class="sensor-icon" id="motion-icon">ðŸ‘¤</div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">Motion Sensor</h3>
                            <div class="text-2xl font-bold mt-4" id="sensor-motion" style="color: #10b981;">No Motion</div>
                            <div class="text-sm text-gray-600 mt-2">PIR HC-SR501</div>
                            <div class="text-xs text-gray-500 mt-2" id="motion-update">Last update: --</div>
                        </div>
                    </div>

                    <!-- Power Monitor Section (PZEM-004T) -->
                    <div class="card p-6 bg-gradient-to-br from-yellow-50 to-orange-50 mt-6">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">âš¡</span>
                                <div>
                                    <h2 class="text-xl font-bold text-gray-800">AC Power Monitor</h2>
                                    <p class="text-xs text-gray-500">(PZEM-004T)</p>
                                    <div class="flex items-center gap-2 mt-1">
                                        <div id="pzem-status" class="w-3 h-3 rounded-full bg-gray-400"></div>
                                        <span id="pzem-status-text" class="text-sm text-gray-600 font-semibold">Connecting...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center self-start md:self-center gap-2 bg-white px-3 py-2 rounded-lg shadow-sm power-price-input-container">
                                <label for="price-per-kwh" class="text-sm font-medium text-gray-600">Price/kWh:</label>
                                <input type="number" id="price-per-kwh" value="6.5" step="0.5" min="0" max="100"
                                       class="w-20 px-2 py-1 text-sm border-gray-300 rounded text-center font-semibold focus:ring-indigo-500 focus:border-indigo-500"
                                       onchange="calculateEnergyCost()">
                                <span class="text-sm font-bold text-gray-700">â‚¹</span>
                            </div>
                        </div>
                        <div id="power-monitor-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-white p-4 rounded-xl shadow-sm">
                                <p class="text-sm text-gray-600">Voltage</p>
                                <p id="pzem-voltage" class="text-2xl font-bold text-yellow-600">-- V</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm">
                                <p class="text-sm text-gray-600">Current</p>
                                <p id="pzem-current" class="text-2xl font-bold text-blue-600">-- A</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm">
                                <p class="text-sm text-gray-600">Active Power</p>
                                <p id="pzem-power" class="text-2xl font-bold text-green-600">-- W</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm">
                                <p class="text-sm text-gray-600">Apparent Power</p>
                                <p id="pzem-apparent-power" class="text-2xl font-bold text-cyan-600">-- VA</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm">
                                <p class="text-sm text-gray-600">Reactive Power</p>
                                <p id="pzem-reactive-power" class="text-2xl font-bold text-fuchsia-600">-- VAR</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm">
                                <p class="text-sm text-gray-600">Frequency</p>
                                <p id="pzem-frequency" class="text-2xl font-bold text-indigo-600">-- Hz</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm">
                                <p class="text-sm text-gray-600">Power Factor</p>
                                <p id="pzem-pf" class="text-2xl font-bold text-red-600">--</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm">
                                <p class="text-sm text-gray-600">Energy</p>
                                <p id="pzem-energy" class="text-2xl font-bold text-purple-600">-- kWh</p>
                            </div>
                        </div>
                        
                        <!-- Energy Cost Display -->
                        <div class="mt-4 bg-white rounded-xl p-4 shadow-sm">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                                <div class="border-r border-gray-200 last:border-r-0">
                                    <p class="text-xs text-gray-600 mb-1">Total Cost</p>
                                    <p id="total-energy-cost" class="text-2xl font-bold text-orange-600">â‚¹ 0.00</p>
                                    <p class="text-xs text-gray-500 mt-1">Based on consumed energy</p>
                                </div>
                                <div class="border-r border-gray-200 last:border-r-0">
                                    <p class="text-xs text-gray-600 mb-1">Estimated Daily Cost</p>
                                    <p id="daily-cost-estimate" class="text-2xl font-bold text-blue-600">â‚¹ 0.00</p>
                                    <p class="text-xs text-gray-500 mt-1">At current power</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-600 mb-1">Estimated Monthly Cost</p>
                                    <p id="monthly-cost-estimate" class="text-2xl font-bold text-purple-600">â‚¹ 0.00</p>
                                    <p class="text-xs text-gray-500 mt-1">At current power</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-xs text-gray-500 mt-4 text-center" id="pzem-update">Last update: --</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Page -->
        <div id="page-analytics" class="hidden space-y-6">
            <div class="card p-6">
                <h2 class="text-2xl font-bold text-gray-800">Analytics</h2>
            </div>
            
            <!-- Real-time Status Indicator -->
            <div class="card p-4 bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-500">
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="font-semibold text-green-700">Real-time Monitoring Active</span>
                    </div>
                    <span class="text-sm text-gray-600">All data updates automatically across all devices</span>
                </div>
            </div>
            
            <!-- Sensor Historical Data -->
            <div class="card p-6">
                <div class="flex flex-wrap justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">ðŸ“Š Sensor History</h2>
                    <div class="flex flex-wrap gap-2">
                        <button class="time-range-btn px-4 py-2 rounded-lg bg-indigo-600 text-white" data-range="1" onclick="changeSensorTimeRange(1)">1H</button>
                        <button class="time-range-btn px-4 py-2 rounded-lg bg-gray-200" data-range="6" onclick="changeSensorTimeRange(6)">6H</button>
                        <button class="time-range-btn px-4 py-2 rounded-lg bg-gray-200" data-range="24" onclick="changeSensorTimeRange(24)">24H</button>
                        <button class="time-range-btn px-4 py-2 rounded-lg bg-gray-200" data-range="168" onclick="changeSensorTimeRange(168)">7D</button>
                        <button class="time-range-btn px-4 py-2 rounded-lg bg-gray-200" data-range="8760" onclick="changeSensorTimeRange(8760)">365D</button>
                        <button class="time-range-btn px-4 py-2 rounded-lg bg-gray-200" data-range="-1" onclick="changeSensorTimeRange(-1)">ALL</button>
                        <button class="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700" onclick="exportSensorData()">ðŸ“¥ Excel</button>
                    </div>
                </div>
                
                <div class="chart-container mb-6">
                    <h3 class="text-sm font-semibold mb-2">ðŸŒ¡ï¸ Temperature History</h3>
                    <canvas id="tempHistoryChart"></canvas>
                </div>

                <div class="chart-container mb-6">
                    <h3 class="text-sm font-semibold mb-2">ðŸ’§ Humidity History</h3>
                    <canvas id="humidityHistoryChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3 class="text-sm font-semibold mb-2">ðŸ’¨ Gas Level History</h3>
                    <canvas id="gasHistoryChart"></canvas>
                </div>
            </div>

            <!-- PZEM Power Monitor Analytics -->
            <div class="card p-6">
                <div class="flex flex-wrap justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">âš¡ Power Monitor Analytics (PZEM-004T)</h2>
                    <div class="flex flex-wrap gap-2">
                        <button class="pzem-time-range-btn px-4 py-2 rounded-lg bg-indigo-600 text-white" data-range="1" onclick="changePZEMTimeRange(1)">1H</button>
                        <button class="pzem-time-range-btn px-4 py-2 rounded-lg bg-gray-200" data-range="6" onclick="changePZEMTimeRange(6)">6H</button>
                        <button class="pzem-time-range-btn px-4 py-2 rounded-lg bg-gray-200" data-range="24" onclick="changePZEMTimeRange(24)">24H</button>
                        <button class="pzem-time-range-btn px-4 py-2 rounded-lg bg-gray-200" data-range="168" onclick="changePZEMTimeRange(168)">7D</button>
                        <button class="pzem-time-range-btn px-4 py-2 rounded-lg bg-gray-200" data-range="720" onclick="changePZEMTimeRange(720)">30D</button>
                        <button class="pzem-time-range-btn px-4 py-2 rounded-lg bg-gray-200" data-range="8760" onclick="changePZEMTimeRange(8760)">365D</button>
                        <button class="pzem-time-range-btn px-4 py-2 rounded-lg bg-gray-200" data-range="-1" onclick="changePZEMTimeRange(-1)">ALL</button>
                        <button class="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700" onclick="exportPZEMData()">ðŸ“¥ Excel</button>
                    </div>
                </div>
                
                <div class="chart-container mb-6">
                    <h3 class="text-sm font-semibold mb-2">âš¡ Power Consumption (Watts)</h3>
                    <canvas id="powerHistoryChart"></canvas>
                </div>

                <div class="chart-container mb-6">
                    <h3 class="text-sm font-semibold mb-2">âš¡ Voltage (Volts)</h3>
                    <canvas id="voltageHistoryChart"></canvas>
                </div>

                <div class="chart-container mb-6">
                    <h3 class="text-sm font-semibold mb-2">âš¡ Current (Amperes)</h3>
                    <canvas id="currentHistoryChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3 class="text-sm font-semibold mb-2">âš¡ Energy Consumption (kWh)</h3>
                    <canvas id="energyHistoryChart"></canvas>
                </div>
            </div>

            <!-- PZEM Statistics -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card p-6">
                    <h3 class="text-sm font-semibold text-gray-600 mb-2">Peak Power</h3>
                    <div class="text-center">
                        <p id="pzem-peak-power" class="text-3xl font-bold text-red-600">-- W</p>
                        <p id="pzem-peak-time" class="text-xs text-gray-500 mt-1">--</p>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-sm font-semibold text-gray-600 mb-2">Average Power</h3>
                    <div class="text-center">
                        <p id="pzem-avg-power" class="text-3xl font-bold text-blue-600">-- W</p>
                        <p class="text-xs text-gray-500 mt-1">Last 24 hours</p>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-sm font-semibold text-gray-600 mb-2">Total Energy</h3>
                    <div class="text-center">
                        <p id="pzem-total-energy" class="text-3xl font-bold text-green-600">-- kWh</p>
                        <p id="pzem-energy-cost" class="text-xs text-gray-500 mt-1">â‚¹ --</p>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-sm font-semibold text-gray-600 mb-2">Total Runtime</h3>
                    <div class="text-center">
                        <p id="pzem-runtime" class="text-3xl font-bold text-purple-600">-- hrs</p>
                        <p class="text-xs text-gray-500 mt-1">Active time</p>
                    </div>
                </div>
            </div>

            <!-- Sensor Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="card p-6">
                    <h3 class="text-sm font-semibold text-gray-600 mb-2">Temperature Range (24h)</h3>
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-xs text-gray-500">Min</p>
                            <p id="temp-min" class="text-2xl font-bold text-blue-600">--Â°C</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Max</p>
                            <p id="temp-max" class="text-2xl font-bold text-red-600">--Â°C</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Avg</p>
                            <p id="temp-avg" class="text-2xl font-bold text-green-600">--Â°C</p>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-sm font-semibold text-gray-600 mb-2">Humidity Range (24h)</h3>
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-xs text-gray-500">Min</p>
                            <p id="humidity-min" class="text-2xl font-bold text-blue-600">--%</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Max</p>
                            <p id="humidity-max" class="text-2xl font-bold text-red-600">--%</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Avg</p>
                            <p id="humidity-avg" class="text-2xl font-bold text-green-600">--%</p>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-sm font-semibold text-gray-600 mb-2">Motion Events (24h)</h3>
                    <div class="text-center">
                        <p id="motion-count" class="text-5xl font-bold text-purple-600">0</p>
                        <p class="text-sm text-gray-600 mt-2">Detections</p>
                    </div>
                </div>
            </div>
            
            <!-- Device Usage Analytics -->
            <div class="card p-6">
                <h2 class="text-xl font-bold mb-4">Device Usage Analytics</h2>
                
                <!-- Device Timeline Charts -->
                <div class="mb-6">
                    <div class="flex flex-wrap justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Device Activity Timeline</h3>
                        <div class="flex flex-wrap gap-2">
                            <button class="device-time-btn px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition" data-range="1" onclick="changeDeviceTimeRange(1)">1H</button>
                            <button class="device-time-btn px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition" data-range="6" onclick="changeDeviceTimeRange(6)">6H</button>
                            <button class="device-time-btn px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition" data-range="24" onclick="changeDeviceTimeRange(24)">24H</button>
                            <button class="device-time-btn px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition" data-range="168" onclick="changeDeviceTimeRange(168)">7D</button>
                            <button class="device-time-btn px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition" data-range="720" onclick="changeDeviceTimeRange(720)">30D</button>
                            <button class="device-time-btn px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition" data-range="8760" onclick="changeDeviceTimeRange(8760)">365D</button>
                            <button class="device-time-btn px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition" data-range="-1" onclick="changeDeviceTimeRange(-1)">ALL</button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="chart-container">
                            <h3 class="text-sm font-semibold text-center mb-2">Lights Activity</h3>
                            <canvas id="lightsTimelineChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 class="text-sm font-semibold text-center mb-2">Fans Activity</h3>
                            <canvas id="fansTimelineChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="chart-container">
                        <h3 class="text-sm font-semibold text-center mb-2">Device Usage Distribution</h3>
                        <canvas id="pieChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="text-sm font-semibold text-center mb-2">Switch Count</h3>
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Page -->
        <div id="page-logs" class="hidden space-y-6">
            <div class="card p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                    <h2 class="text-2xl font-bold text-gray-800">Logs</h2>
                    <div class="flex flex-wrap gap-2">
                        <button id="export-logs-excel-btn" class="btn bg-green-600 hover:bg-green-700 text-sm">
                            <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                            Excel
                        </button>
                        <button id="export-logs-btn" class="btn bg-blue-500 hover:bg-blue-600 text-sm">
                            <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                            TXT
                        </button>
                        <button id="clear-logs-btn" class="btn bg-red-500 hover:bg-red-600 text-sm">Clear</button>
                    </div>
                </div>
                
                <div class="mb-4">
                    <input id="log-search" type="text" placeholder="Search logs..." class="w-full">
                </div>
                
                <div id="log-container" class="h-auto max-h-[600px] bg-gray-50 rounded-lg p-4 overflow-y-auto font-mono text-sm space-y-1"></div>
            </div>
        </div>

        <!-- Faults Page -->
        <div id="page-faults" class="hidden space-y-6">
            <div class="card p-6">
                <h2 class="text-2xl font-bold text-gray-800">Faults</h2>
            </div>

            <!-- Emergency Shutdown Banner -->
            <div id="emergency-shutdown-banner" class="hidden bg-red-800 text-white p-6 rounded-2xl shadow-xl animate-pulse">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-2xl font-bold flex items-center">
                            <svg class="w-8 h-8 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            EMERGENCY SHUTDOWN ACTIVATED
                        </h3>
                        <p id="emergency-reason" class="mt-2">A critical fault was detected. All devices have been turned off.</p>
                    </div>
                    <button onclick="stopFaultAlarm()" class="btn bg-white text-red-800 hover:bg-gray-100">
                        Reset System
                    </button>
                </div>
            </div>

            <!-- System Status -->
            <div class="card p-6">
                <h2 class="text-xl font-bold mb-4">System Status</h2>
                <div id="fault-system-status" class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4" role="alert">
                    <p class="font-bold">All Systems Normal</p>
                    <p>No faults detected. System is operating within safe parameters.</p>
                </div>
            </div>

            <!-- Fault Protection System Toggle and Settings -->
            <div class="card p-6">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <h2 class="text-xl font-bold text-gray-800">Fault Protection System</h2>
                    <label for="fault-protection-toggle" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="fault-protection-toggle" class="sr-only peer" checked>
                        <span class="w-14 h-8 bg-gray-300 rounded-full peer peer-checked:bg-green-500 transition-all duration-300" aria-hidden="true"></span>
                        <span class="absolute left-1 top-1 bg-white border-gray-300 border w-6 h-6 rounded-full transition-all duration-300 peer-checked:transform peer-checked:translate-x-full peer-checked:border-white" aria-hidden="true"></span>
                    </label>
                </div>

                <div id="fault-protection-explanation" class="mt-4 text-sm text-gray-700 space-y-3">
                    <div id="fault-protection-on-explanation" class="p-4 bg-green-50 border-l-4 border-green-500">
                        <h4 class="font-semibold text-green-800">Mechanism ON: Active Protection</h4>
                        <p>When fault protection is <strong>ON</strong>, the system actively monitors your home's electrical supply using the PZEM-004T sensor. If the voltage or current exceeds the predefined safe limits, the system will declare a fault, trigger an emergency shutdown of all connected appliances, and display a warning banner. This protects your devices from damage and prevents potential hazards. Manual control is disabled until the fault is cleared and the alarm is stopped.</p>
                    </div>
                    <div id="fault-protection-off-explanation" class="hidden p-4 bg-red-50 border-l-4 border-red-500">
                        <h4 class="font-semibold text-red-800">Mechanism OFF: Monitoring Only</h4>
                        <p>When fault protection is <strong>OFF</strong>, the system will continue to monitor voltage and current, but it will <strong>not</strong> automatically shut down appliances if a fault is detected. You will have full manual control, but your devices will not be protected from electrical abnormalities. This mode should only be used for maintenance or testing purposes.</p>
                    </div>
                </div>

                <div class="mt-6 pt-6 border-t">
                    <h3 class="text-lg font-semibold mb-4">Fault Thresholds</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="low-voltage-threshold" class="block text-sm font-medium">Low Voltage (V)</label>
                            <input type="number" id="low-voltage-threshold" value="200" class="mt-1 block w-full">
                        </div>
                        <div>
                            <label for="high-voltage-threshold" class="block text-sm font-medium">High Voltage (V)</label>
                            <input type="number" id="high-voltage-threshold" value="240" class="mt-1 block w-full">
                        </div>
                        <div>
                            <label for="high-current-threshold" class="block text-sm font-medium">High Current (A)</label>
                            <input type="number" id="high-current-threshold" value="5.0" step="0.1" class="mt-1 block w-full">
                        </div>
                    </div>
                    <button id="save-fault-thresholds" class="btn mt-4 w-full">Save Thresholds</button>
                </div>
                 <div class="mt-6 pt-6 border-t">
                    <h3 class="text-lg font-semibold mb-4">Fault Simulation</h3>
                    <div class="flex flex-wrap justify-center gap-2">
                        <button id="test-low-voltage" class="btn bg-blue-500 hover:bg-blue-600 text-sm">Test Low Voltage</button>
                        <button id="test-high-voltage" class="btn bg-yellow-500 hover:bg-yellow-600 text-sm">Test High Voltage</button>
                        <button id="test-high-current" class="btn bg-orange-500 hover:bg-orange-600 text-sm">Test High Current</button>
                        <button id="stop-fault-alarm" class="btn bg-gray-400 text-sm" disabled>Stop Alarm</button>
                    </div>
                </div>

                <div class="mt-6 pt-6 border-t">
                    <h3 class="text-lg font-semibold mb-4">Fault Statistics</h3>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="fault-stats-chart"></canvas>
                    </div>
                </div>
            </div>



<div class="flex flex-wrap gap-6">
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Voltage Limits</h3>
                    <div class="flex justify-around items-center">
                        <div>
                            <p class="text-sm text-gray-500">Min</p>
                            <p class="text-3xl font-bold text-blue-600">200 V</p>
                        </div>
                        <div id="pzem-voltage-fault" class="text-4xl font-bold text-green-600">-- V</div>
                        <div>
                            <p class="text-sm text-gray-500">Max</p>
                            <p class="text-3xl font-bold text-red-600">240 V</p>
                        </div>
                    </div>
                </div>
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Current Limit</h3>
                     <div class="flex justify-around items-center">
                        <div class="text-center">
                            <p class="text-sm text-gray-500">Max</p>
                            <p class="text-3xl font-bold text-red-600">5.0 A</p>
                        </div>
                        <div id="pzem-current-fault" class="text-4xl font-bold text-green-600">-- A</div>
                    </div>
                </div>
            </div>

            <!-- Fault History -->
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Fault History</h2>
                    <button id="clear-faults-btn" class="btn bg-red-500 hover:bg-red-600 text-sm">Clear History</button>
                </div>
                <div id="fault-log-container" class="h-auto bg-gray-50 rounded-lg p-4 overflow-y-auto font-mono text-sm space-y-1">
                     <div class="text-gray-500 text-center py-4">No faults recorded.</div>
                </div>
            </div>
        </div>

        <!-- Menu Page (formerly drawer) -->
        <div id="page-menu" class="hidden w-full max-w-6xl mx-auto p-4 space-y-6 pb-20">
            <div class="card p-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button onclick="showPage('control')" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Back to Control">
                            <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <h2 class="text-2xl font-bold text-gray-800">Menu</h2>
                    </div>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-md">
                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z"/>
                        </svg>
                        v3.0.0
                    </span>
                </div>
            </div>
            
            <div class="space-y-6">
                <div class="p-4 rounded-lg bg-gradient-to-br from-indigo-50 to-purple-50 text-center card">
                    <h1 class="text-2xl font-bold text-indigo-700">Smart Home</h1>
                    <p class="text-gray-600 text-sm mt-1" id="greeting-text-drawer">Welcome back!</p>
                     <div class="mt-2 text-indigo-900">
                        <div class="text-lg font-bold" id="current-time-drawer">00:00:00</div>
                        <div class="text-xs" id="current-date-drawer">Loading...</div>
                    </div>
                </div>

                <!-- Theme Toggle -->
                <div class="card p-4 flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold">Appearance</h3>
                        <p class="text-sm text-gray-500">Switch between Light and Dark theme for a comfortable experience.</p>
                    </div>
                    <div>
                        <label for="theme-toggle" class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="theme-toggle" class="sr-only">
                            <span id="theme-track" class="w-14 h-8 bg-gray-300 rounded-full transition-colors duration-300 dark:bg-gray-600"></span>
                            <span id="theme-thumb" class="absolute left-1 top-1 bg-white border w-6 h-6 rounded-full transition-transform duration-300"></span>
                        </label>
                    </div>
                </div>

                <!-- Profile Section -->
                <div class="accordion-item card">
                    <button class="accordion-toggle" data-accordion="profile">
                        <span>My Profile</span>
                        <svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="accordion-content" id="accordion-profile">
                    <div class="pt-3 pb-2">
                        <div class="flex flex-col items-center mb-4">
                            <!-- Profile Photo Uploader -->
                            <div class="relative group">
                                <img id="profile-photo" alt="Profile photo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect fill='%236366f1' width='100' height='100'/%3E%3Ctext x='50%25' y='50%25' font-size='40' fill='%23fff' text-anchor='middle' dy='.3em'%3EðŸ‘¤%3C/text%3E%3C/svg%3E" class="w-20 h-20 rounded-full border-4 border-indigo-500 object-cover">
                                <label for="photo-upload" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center rounded-full opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                </label>
                                <input type="file" id="photo-upload" class="hidden" accept="image/png, image/jpeg">
                            </div>

                            <!-- Display Name -->
                            <div id="profile-name-view" class="mt-2 text-center">
                                <h3 id="profile-display-name" class="text-lg font-bold text-indigo-700">Loading...</h3>
                            </div>
                            <div id="profile-name-edit" class="hidden mt-2 w-full max-w-xs">
                                <input type="text" id="profile-name-input" class="w-full text-center font-bold text-indigo-700">
                            </div>

                            <p id="profile-email" class="text-sm text-gray-600">Loading...</p>

                            <!-- Action Buttons -->
                            <div id="profile-buttons" class="mt-4 flex gap-2">
                                <button id="edit-profile-btn" class="btn text-sm py-1 px-3">Edit Profile</button>
                                <button id="save-profile-btn" class="hidden btn text-sm py-1 px-3">Save</button>
                                <button id="cancel-edit-profile-btn" class="hidden btn bg-gray-400 text-sm py-1 px-3">Cancel</button>
                            </div>
                             <div id="upload-progress-bar" class="hidden w-full max-w-xs bg-gray-200 rounded-full h-2.5 mt-2">
                                <div id="upload-progress" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>

                <!-- About Section -->
                <div class="accordion-item card">
                    <button class="accordion-toggle" data-accordion="about">
                        <span>ðŸ“– About</span>
                        <svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="accordion-content" id="accordion-about">
                        <div class="pt-3 pb-2 text-sm text-gray-700 space-y-4">
                            
                            <div class="p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border border-indigo-100 shadow-sm">
                                <h3 class="font-bold text-base text-indigo-700 mb-2">Smart Home Automation System</h3>
                                <p class="text-gray-600 text-xs">A comprehensive IoT-based home automation solution that enables remote monitoring and control of electrical appliances, environmental sensors, and power consumption from anywhere in the world.</p>
                            </div>
                            
                            <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                                <p class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    Key Features
                                </p>
                                <ul class="grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-600">
                                    <li class="flex items-center gap-2"><svg class="w-3 h-3 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Real-time Control</li>
                                    <li class="flex items-center gap-2"><svg class="w-3 h-3 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Power Monitoring</li>
                                    <li class="flex items-center gap-2"><svg class="w-3 h-3 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Sensor Readings</li>
                                    <li class="flex items-center gap-2"><svg class="w-3 h-3 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Voice Control</li>
                                    <li class="flex items-center gap-2"><svg class="w-3 h-3 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Analytics</li>
                                    <li class="flex items-center gap-2"><svg class="w-3 h-3 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Authentication</li>
                                </ul>
                            </div>

                            <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                                <p class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                                    Technology Stack
                                </p>
                                <div class="flex flex-wrap gap-2 text-xs">
                                    <span class="bg-gray-200 text-gray-700 px-2 py-1 rounded-full">ESP8266</span>
                                    <span class="bg-gray-200 text-gray-700 px-2 py-1 rounded-full">Arduino</span>
                                    <span class="bg-gray-200 text-gray-700 px-2 py-1 rounded-full">Firebase</span>
                                    <span class="bg-gray-200 text-gray-700 px-2 py-1 rounded-full">MQTT</span>
                                    <span class="bg-gray-200 text-gray-700 px-2 py-1 rounded-full">Tailwind CSS</span>
                                    <span class="bg-gray-200 text-gray-700 px-2 py-1 rounded-full">Chart.js</span>
                                </div>
                            </div>

                            <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                                <p class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                    Power Monitoring
                                </p>
                                <ul class="grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-600">
                                    <li class="flex items-center gap-2"><svg class="w-3 h-3 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Voltage</li>
                                    <li class="flex items-center gap-2"><svg class="w-3 h-3 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Current</li>
                                    <li class="flex items-center gap-2"><svg class="w-3 h-3 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Power</li>
                                    <li class="flex items-center gap-2"><svg class="w-3 h-3 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Energy</li>
                                </ul>
                            </div>

                            <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                                <p class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                                    Security Features
                                </p>
                                <ul class="grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-600">
                                    <li class="flex items-center gap-2"><svg class="w-3 h-3 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Authentication</li>
                                    <li class="flex items-center gap-2"><svg class="w-3 h-3 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Password Reset</li>
                                    <li class="flex items-center gap-2"><svg class="w-3 h-3 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Secure MQTT</li>
                                    <li class="flex items-center gap-2"><svg class="w-3 h-3 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Activity Logging</li>
                                </ul>
                            </div>
                            
                            <div class="pt-2 border-t border-gray-200 mt-4">
                                <p class="text-xs text-gray-500 italic text-center">Developed with â¤ï¸ for modern smart homes</p>
                                <p class="text-xs text-gray-500 text-center mt-1">Version 3.0.0 | December 2025</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Project Team Section -->
                <div class="accordion-item card">
                    <button class="accordion-toggle" data-accordion="team">
                        <span>ðŸ‘¥ Project Team</span>
                        <svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="accordion-content" id="accordion-team">
                        <div class="pt-3 pb-2 text-sm text-gray-700 space-y-4">
                            <!-- Team Member 1: Piku -->
                            <div class="flex items-center gap-3 p-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border border-indigo-100">
                                <div class="flex-shrink-0">
                                    <img src="./piku.jpg" alt="Piku Mandal" class="w-16 h-16 rounded-full object-cover border-2 border-indigo-300 shadow-md" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20width=%27100%27%20height=%27100%27%3E%3Crect%20fill=%27%236366f1%27%20width=%27100%27%20height=%27100%27/%3E%3Ctext%20x=%2750%25%27%20y=%2750%25%27%20font-size=%2740px%27%20fill=%27%23fff%27%20text-anchor=%27middle%27%20dy=%27.3em%27%3EP%3C/text%3E%3C/svg%3E';">
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-base text-indigo-700">Piku Mandal</h4>
                                    <p class="text-xs text-gray-600 mb-1"></p>
                                    <p class="text-xs text-gray-500 mb-1">B.Tech, Electrical Engineering</p>
                                    <div class="flex items-center gap-2 text-xs">
                                        <a href="mailto:pikumandal5233@gmail.com" class="text-indigo-600 hover:text-indigo-800 flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                                                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
                                            </svg>
                                            Email
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Team Member 2: Arnab -->
                            <div class="flex items-center gap-3 p-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border border-indigo-100">
                                <div class="flex-shrink-0">
                                    <img src="./arnab.jpg" alt="Arnab Mandal" class="w-16 h-16 rounded-full object-cover border-2 border-indigo-300 shadow-md" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20width=%27100%27%20height=%27100%27%3E%3Crect%20fill=%27%238b5cf6%27%20width=%27100%27%20height=%27100%27/%3E%3Ctext%20x=%2750%25%27%20y=%2750%25%27%20font-size=%2740px%27%20fill=%27%23fff%27%20text-anchor=%27middle%27%20dy=%27.3em%27%3EA%3C/text%3E%3C/svg%3E';">
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-base text-indigo-700">Arnab Mandal</h4>
                                    <p class="text-xs text-gray-600 mb-1"></p>
                                    <p class="text-xs text-gray-500 mb-1">Diploma, Electrical Engineering</p>
                                    <div class="flex items-center gap-2 text-xs">
                                        <a href="mailto:arnabmandal123123@gmail.com" class="text-indigo-600 hover:text-indigo-800 flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                                                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
                                            </svg>
                                            Email
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <div class="pt-2 border-t border-gray-200">
                                <p class="text-xs text-gray-500 italic text-center">Building the future of smart homes ðŸš€</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Feedback Section -->
                <div class="accordion-item card">
                    <button class="accordion-toggle" data-accordion="feedback">
                        <span>ðŸ’¬ Feedback</span>
                        <svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="accordion-content" id="accordion-feedback">
                        <div class="pt-3 pb-2">
                            <p class="text-sm text-gray-600 mb-3">We'd love to hear your thoughts! Share your feedback with us.</p>
                            
                            <form id="feedback-form" class="space-y-3">
                                <div>
                                <label for="feedback-name" class="block text-xs font-semibold mb-1 text-gray-700">Your Name</label>
                                    <input type="text" id="feedback-name" required placeholder="Enter your name" class="w-full text-sm">
                                </div>

                                <div>
                                    <label for="feedback-email" class="block text-xs font-semibold mb-1 text-gray-700">Your Email</label>
                                    <input type="email" id="feedback-email" required placeholder="your.email@example.com" class="w-full text-sm">
                                </div>

                                <div>
                                    <label for="feedback-subject" class="block text-xs font-semibold mb-1 text-gray-700">Subject</label>
                                    <select id="feedback-subject" class="w-full text-sm">
                                        <option value="General Feedback">General Feedback</option>
                                        <option value="Bug Report">Bug Report</option>
                                        <option value="Feature Request">Feature Request</option>
                                        <option value="Technical Support">Technical Support</option>
                                        <option value="Collaboration">Collaboration Inquiry</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>

                                <div>
                                    <label for="feedback-message" class="block text-xs font-semibold mb-1 text-gray-700">Message</label>
                                    <textarea id="feedback-message" rows="4" required placeholder="Share your thoughts, suggestions, or issues..." class="w-full text-sm resize-none"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-semibold mb-1 text-gray-700">Send To</label>
                                    <div class="flex gap-2">
                                        <label class="flex items-center gap-1 text-xs">
                                            <input type="checkbox" id="send-to-piku" checked class="w-3 h-3 text-indigo-600 rounded">
                                            <span class="text-gray-700">Piku</span>
                                        </label>
                                        <label class="flex items-center gap-1 text-xs">
                                            <input type="checkbox" id="send-to-arnab" checked class="w-3 h-3 text-purple-600 rounded">
                                            <span class="text-gray-700">Arnab</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn w-full text-sm py-2">
                                    <span class="flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                        </svg>
                                        Send Feedback via Gmail
                                    </span>
                                </button>
                            </form>
                            
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <p class="text-xs text-gray-500 text-center">Your feedback helps us improve! ðŸŒŸ</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Logs Button -->
                <button id="drawer-logs-btn" class="accordion-toggle w-full" style="justify-content: flex-start; gap: 0.5rem;">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span>Activity Logs</span>
                </button>

                <!-- Faults Button -->
                <button id="drawer-faults-btn" class="accordion-toggle w-full" style="justify-content: flex-start; gap: 0.5rem;">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <span>Faults & Status</span>
                </button>

                <!-- Fire Alarm Button -->
                <button id="drawer-fire-alarm-btn" class="accordion-toggle w-full" style="justify-content: flex-start; gap: 0.5rem;">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <span>Fire Alarm</span>
                </button>
            </div>

            <div class="p-4 border-t border-gray-200 card">
                <button id="logout-btn" class="w-full btn">Logout</button>
            </div>
        </div>

    
    <!-- Floating Voice Control Button -->
    <button id="floating-voice-btn" class="microphone-icon hidden">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
        </svg>
    </button>
    </main>


    <!-- Night Time Suggestion Banner -->
    <div id="night-suggestion-banner" class="hidden fixed bottom-20 left-1/2 -translate-x-1/2 w-11/12 max-w-md bg-gray-800 text-white p-4 rounded-lg shadow-lg z-50 flex justify-between items-center transition-all duration-300 transform opacity-0 translate-y-4">
        <p class="text-sm">It's getting dark. Turn on the lights?</p>
        <div class="flex gap-2">
            <button id="night-suggestion-yes" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded font-semibold text-xs">Yes, please</button>
            <button id="night-suggestion-no" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded font-semibold text-xs">No, thanks</button>
        </div>
    </div>

<script>
let isAlarmPlaying = false;
let isFaultAlarmPlaying = false;
let isSystemLocked = false;

// Global threshold values (synced from Firebase)
let currentThresholds = {
    lowVoltage: 200,
    highVoltage: 240,
    highCurrent: 5.0
};







// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyA8iM4CLqitmYsJ8gk4OZirnU4f1MVMOxQ",
    authDomain: "smart-home-automation-2d34d.firebaseapp.com",
    databaseURL: "https://smart-home-automation-2d34d-default-rtdb.firebaseio.com",
    projectId: "smart-home-automation-2d34d",
    storageBucket: "smart-home-automation-2d34d.firebasestorage.app",
    messagingSenderId: "217146632377",
    appId: "1:217146632377:web:21d9c2947220704e47d368"
};

let firebaseApp, db, auth, storage, realtimeDb;
let firebaseReady = false;

function initFirebase() {
    if (!window.firebaseModules) {
        setTimeout(initFirebase, 100);
        return;
    }
    
    const { initializeApp, getFirestore, getAuth, getStorage, getDatabase } = window.firebaseModules;
    
    try {
        firebaseApp = initializeApp(firebaseConfig);
        db = getFirestore(firebaseApp);
        auth = getAuth(firebaseApp);
        storage = getStorage(firebaseApp);
        realtimeDb = getDatabase(firebaseApp);  // Initialize Realtime Database
        
        // Set default persistence to LOCAL (stay logged in across page reloads)
        // Users can still choose session-only via "Remember Me" checkbox during login
        const { setPersistence, browserLocalPersistence } = window.firebaseModules;
        setPersistence(auth, browserLocalPersistence).catch(err => {
            console.warn("Could not set default persistence:", err);
        });
        
        firebaseReady = true;
        console.log("âœ… Firebase initialized (Firestore + Realtime Database)");
        showToast("Firebase connected successfully!", "success");
        console.log("ðŸ” Default persistence: LOCAL (stay logged in across reloads)");
        console.log("ðŸ”¥ initFirebase: realtimeDb initialized:", !!realtimeDb);
        window.dispatchEvent(new CustomEvent('firebaseReady'));
    } catch (error) {
        console.error("âŒ Firebase error:", error);
        console.log("ðŸ”¥ initFirebase: Error during initialization, realtimeDb state:", !!realtimeDb); // Add this line
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFirebase);
} else {
    initFirebase();
}

// Function to update the UI based on firebaseReady state
function updateFirebaseStatusUI() {
    const firebaseStatusDiv = document.getElementById('firebase-status');
    // Ensure elements exist before manipulating them
    if (!firebaseStatusDiv) {
        console.warn("Firebase status UI elements not found yet. Will attempt to update on DOMContentLoaded.");
        return;
    }

    if (firebaseReady) {
        firebaseStatusDiv.classList.remove('from-indigo-50', 'to-purple-100', 'text-gray-600', 'from-red-50', 'to-red-100', 'text-red-700');
        firebaseStatusDiv.classList.add('from-green-50', 'to-green-100', 'text-green-700');
        firebaseStatusDiv.innerHTML = `
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm4.207 7.793-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L11 13.586l4.293-4.293a1 1 0 011.414 1.414z"/>
            </svg>
            <span>Firebase Connected</span>
        `;
    } else {
        // Initial state or if connection fails, it will show "Connecting..." from HTML
        // If it was connected and then disconnected, this would show disconnected.
        firebaseStatusDiv.classList.remove('from-indigo-50', 'to-purple-100', 'text-gray-600', 'from-green-50', 'to-green-100', 'text-green-700');
        firebaseStatusDiv.classList.add('from-red-50', 'to-red-100', 'text-red-700');
        firebaseStatusDiv.innerHTML = `
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1s1 .45 1 1v4c0 .55-.45 1-1 1zm-1-9h2V7h-2v1z"/>
            </svg>
            <span>Firebase Disconnected</span>
        `;
    }
}

// Register the event listener for firebaseReady
document.addEventListener('firebaseReady', updateFirebaseStatusUI);

// Also update initial status if Firebase is already ready (for cases where DOMContentLoaded fires after firebaseReady)
document.addEventListener('DOMContentLoaded', () => {
    // Other DOMContentLoaded logic might be here...
    updateFirebaseStatusUI(); // Call it once the DOM is ready to catch the initial state
});

// MQTT Configuration
const MQTT_BROKER = "broker.hivemq.com";
const MQTT_PORT = 8884;
const NUM_LIGHTS = 4;
const MIN_VOLTAGE = 200;
const MAX_VOLTAGE = 240;
const MAX_CURRENT = 5.0;

let client = null;
let currentUser = null;
let logEntries = [];
let faultEntries = [];
let usageData = {};
let hourlyActivity = Array(24).fill(0);

// Track active timers and intervals for cleanup
const activeTimers = new Set();
const activeIntervals = new Set();
let isMqttConnecting = false; // Prevent duplicate connection attempts

// Local state cache for optimistic updates
const deviceStateCache = {
    lights: {},
    fans: {},
    lastUpdate: {}
};

// Connection quality tracking
let mqttLatency = 0;
let lastPingTime = 0;

// Throttle utility to prevent excessive updates and flickering
const throttle = (func, delay = 500) => {
    let lastCall = 0;
    return function(...args) {
        const now = Date.now();
        if (now - lastCall >= delay) {
            lastCall = now;
            return func.apply(this, args);
        }
    };
};

// Debounce utility for less critical updates
const debounce = (func, delay = 300) => {
    let timeoutId;
    return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
    };
};

// Sensor data variables
let tempHistoryChart, humidityHistoryChart, gasHistoryChart;
let powerHistoryChart, voltageHistoryChart, currentHistoryChart, energyHistoryChart;
let currentSensorTimeRange = 1; // hours
let currentPZEMTimeRange = 1; // hours
let previousSensorValues = { temperature: null, humidity: null };
let sensorDataCache = { temperature: [], humidity: [], gasLevel: [] };
let currentSensorValues = { temperature: 0, humidity: 0, gasLevel: 0, motion: false };

// Appliances configuration
const ICONS = {
    light: '<svg class="w-16 h-16 mx-auto appliance-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 21a2 2 0 01-2-2V17a2 2 0 012-2h6a2 2 0 012 2v2a2 2 0 01-2 2H9zM9 15V9a3 3 0 013-3h0a3 3 0 013 3v6M12 6V3m-4 3h8"></path></svg>',
    fan: '<svg class="w-16 h-16 mx-auto appliance-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="3"/><path d="M12 3v2m0 14v2m9-9h-2M5 12H3"/></svg>',
    other: '<svg class="w-16 h-16 mx-auto appliance-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>'
};

let appliances = [];
let smartLightStates = {};
let smartFanStates = {};

// Prevent multiple simultaneous loads
let isLoadingAppliances = false;

async function loadAppliances() {
    // Prevent duplicate calls
    if (isLoadingAppliances) {
        console.log("ðŸ”¥ loadAppliances: Already loading, skipping...");
        return;
    }
    
    isLoadingAppliances = true;
    
    try {
        console.log("ðŸ”¥ loadAppliances: Starting to load appliances.");
        
        if (!realtimeDb) {
            console.log("ðŸ”¥ loadAppliances: realtimeDb not ready, using default appliances.");
            // Fallback to default if DB not ready
            appliances = [
                { id: 1, name: 'Ceiling Light', type: 'light', deviceId: 1 },
                { id: 2, name: 'Table Lamp', type: 'light', deviceId: 2 },
                { id: 3, name: 'Fan 1', type: 'fan', deviceId: 1 },
                { id: 4, name: 'Fan 2', type: 'fan', deviceId: 2 }
            ];
            isLoadingAppliances = false;
            return;
        }
        
        const { dbRef, get, set } = window.firebaseModules;
        const appliancesRef = dbRef(realtimeDb, 'appliances');
        
        try {
            const snapshot = await get(appliancesRef);
            if (snapshot.exists()) {
                const appliancesData = snapshot.val();
                // Convert Firebase object to array, using Firebase keys as IDs
                const allAppliances = Object.entries(appliancesData).map(([key, value]) => ({
                    ...value,
                    id: parseInt(key) // Use Firebase key as the ID
                }));
                const lights = allAppliances.filter(a => a.type === 'light');
                const fans = allAppliances.filter(a => a.type === 'fan');
                
                appliances = lights.concat(fans.slice(0, 2)); // Keep only the first 2 fans
                console.log("Loaded and filtered appliances from Firebase:", appliances);
                console.log("ðŸ”¥ loadAppliances: Appliances loaded (from DB):", appliances);
                // Debug: Show each appliance structure
                appliances.forEach((app, index) => {
                    console.log(`ðŸ” Appliance ${index}: id=${app.id}, name="${app.name}", type="${app.type}", deviceId=${app.deviceId}`);
                });
            } else {
                // No appliances in DB, so set the default ones
                const defaultAppliances = [
                    { id: 1, name: 'Light 1', type: 'light', deviceId: 1 },
                    { id: 2, name: 'Light 2', type: 'light', deviceId: 2 },
                    { id: 3, name: 'Fan 1', type: 'fan', deviceId: 1 },
                    { id: 4, name: 'Fan 2', type: 'fan', deviceId: 2 }
                ];

                const appliancesData = {};
                defaultAppliances.forEach(app => {
                    appliancesData[app.id] = app;
                });

                await set(appliancesRef, appliancesData);
                appliances = defaultAppliances;
                console.log("Initialized default appliances in Firebase.");
                console.log("ðŸ”¥ loadAppliances: Appliances initialized (default):", appliances); // Add this line
            }
        } catch (error) {
            console.error("Error loading appliances:", error);
            // Fallback to default on error
            appliances = [
                { id: 1, name: 'Ceiling Light', type: 'light', deviceId: 1 },
                { id: 2, name: 'Table Lamp', type: 'light', deviceId: 2 },
                { id: 3, name: 'Fan 1', type: 'fan', deviceId: 1 },
                { id: 4, name: 'Fan 2', type: 'fan', deviceId: 2 }
            ];
        } finally {
            isLoadingAppliances = false;
        }
    } catch (error) {
        console.error('Unexpected error in loadAppliances:', error);
        isLoadingAppliances = false;
    }
    
    // Initialize usage data
    usageData = {};
    appliances.forEach(app => {
        usageData[app.name] = { onTime: 0, switches: 0, lastToggle: null };
    });
}

// Utility Functions
function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    const colors = {
        info: 'bg-blue-500',
        success: 'bg-green-500',
        warning: 'bg-yellow-500',
        error: 'bg-red-500'
    };
    toast.className = `${colors[type]} text-white px-3 py-1.5 rounded-lg shadow-lg text-xs font-medium max-w-sm`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

async function addLog(text, category = 'general') {
    try {
        if (!text) {
            console.warn('Empty log text provided');
            return;
        }
        
        const now = new Date();
        const timestamp = now.toLocaleTimeString();
        const timestampMs = now.getTime();
        const dateStr = now.toLocaleDateString();
        
        const userName = currentUser ? currentUser.email : 'System';
        
        const logEntry = { 
            time: timestamp,
            date: dateStr,
            text,
            user: userName,
            category,
            timestamp: timestampMs
        };
        
        logEntries.push(logEntry);
        renderLog(logEntry);
        
        // Save to Firebase immediately (non-blocking)
        if (window.firebaseModules && realtimeDb) {
            try {
                const { dbRef, push } = window.firebaseModules;
                const logsRef = dbRef(realtimeDb, 'logs');
                await push(logsRef, logEntry);
                console.log('âœ… Log saved:', text);
            } catch (error) {
                console.error('âŒ Error saving log to Firebase:', error);
                // Don't throw - logging failure shouldn't crash the app
            }
        }
    } catch (error) {
        console.error('Error in addLog:', error, { text, category });
    }
}

// Track device usage
async function trackDeviceUsage(deviceName, deviceType, action, value = null) {
    try {
        if (!deviceName || !deviceType || !action) {
            console.warn('Invalid trackDeviceUsage parameters');
            return;
        }
        const { dbRef, push } = window.firebaseModules;
        const usageRef = dbRef(realtimeDb, 'deviceUsage');
        const usageEntry = {
            deviceName,
            deviceType,
            action,
            value,
            timestamp: Date.now()
        };
        await push(usageRef, usageEntry);
    } catch (error) {
        console.error('Error tracking device usage:', error);
    }
}

function renderLog(entry = null) {
    const container = document.getElementById('log-container');
    if (!container) return;

    if (entry) {
        // Prepend a single new entry (show latest on top)
        const userBadge = entry.user ? `<span class="text-blue-600 font-semibold">[${entry.user}]</span>` : '';
        const categoryBadge = entry.category && entry.category !== 'general' 
            ? `<span class="text-purple-600">[${entry.category}]</span>` 
            : '';
        
        const newLog = document.createElement('div');
        newLog.className = 'hover:bg-gray-100 p-1 rounded';
        newLog.innerHTML = `
            <span class="text-cyan-600">[${entry.time}]</span> 
            ${userBadge} 
            ${categoryBadge} 
            ${entry.text}
        `;
        container.insertBefore(newLog, container.firstChild);

    } else {
        // Full re-render
        const search = document.getElementById('log-search')?.value.toLowerCase() || '';
        container.innerHTML = '';
        
        const filteredEntries = logEntries.filter(e => {
            const searchText = `${e.text} ${e.user || ''}`.toLowerCase();
            return searchText.includes(search);
        });
        
        if (filteredEntries.length === 0) {
            container.innerHTML = '<div class="text-gray-500 text-center py-4">No logs found</div>';
            return;
        }
        
        const fragment = document.createDocumentFragment();
        // logEntries already sorted by timestamp desc (latest first) from Firebase
        // No need to reverse - just iterate normally to show latest first
        filteredEntries.forEach(entry => {
            const userBadge = entry.user ? `<span class="text-blue-600 font-semibold">[${entry.user}]</span>` : '';
            const categoryBadge = entry.category && entry.category !== 'general' 
                ? `<span class="text-purple-600">[${entry.category}]</span>` 
                : '';
            
            const logElement = document.createElement('div');
            logElement.className = 'hover:bg-gray-100 p-1 rounded';
            logElement.innerHTML = `
                <span class="text-cyan-600">[${entry.time}]</span> 
                ${userBadge} 
                ${categoryBadge} 
                ${entry.text}
            `;
            fragment.appendChild(logElement);
        });
        container.appendChild(fragment);
    }
    
    // Keep scroll at top for latest logs
    container.scrollTop = 0;
}

// Update time
function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    const dateString = now.toLocaleDateString('en-US', { 
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
    });

    const timeEl = document.getElementById('current-time-drawer');
    const dateEl = document.getElementById('current-date-drawer');

    if (timeEl) timeEl.textContent = timeString;
    if (dateEl) dateEl.textContent = dateString;
}
setInterval(updateTime, 1000);
updateTime();

let espStatusTimer = null;
let isEspOnline = false; // Global variable to track ESP online status
let lastHeartbeatTime = 0; // Track last heartbeat received

function updateEspStatus(isOnline, source = 'unknown') {
    const wasOnline = isEspOnline;
    isEspOnline = isOnline; // Update the global status variable
    const espStatusDiv = document.getElementById('esp-status');
    
    if (isOnline) {
        // Only show toast on state change
        if (!wasOnline) {
            console.log(`âœ… ESP Online (source: ${source})`);
            showToast("ESP online!", "success");
        }
        espStatusDiv.innerHTML = `
            <svg id="esp-status-icon" class="w-3 h-3 text-green-500" viewBox="0 0 12 12" fill="currentColor"><circle cx="6" cy="6" r="6"/></svg>
            <span class="text-sm font-semibold text-green-500">ESP Online</span>
        `;
        // Reset the timer - timeout if no messages for 35s
        if(espStatusTimer) clearTimeout(espStatusTimer);
        espStatusTimer = setTimeout(() => {
            console.log('â° ESP timeout (no messages for 35s)');
            updateEspStatus(false, 'timeout');
        }, 15000); // 15 seconds timeout (optimized for 10s heartbeat)
        
        // Hide Monitor page offline overlays
        hideSensorOfflineOverlay();
        hidePZEMOfflineOverlay();
    } else {
        if (wasOnline) {
            console.log(`âŒ ESP Offline (source: ${source})`);
        }
        if(espStatusTimer) clearTimeout(espStatusTimer);
        espStatusDiv.innerHTML = `
            <svg id="esp-status-icon" class="w-3 h-3 text-red-500" viewBox="0 0 12 12" fill="currentColor"><circle cx="6" cy="6" r="6"/></svg>
            <span class="text-sm font-semibold text-red-500">ESP Offline</span>
        `;
        
        // Show Monitor page offline overlays
        showSensorOfflineOverlay();
        showPZEMOfflineOverlay();
    }
}
function startAlarm(skipFirebase = false) {
    if (isAlarmPlaying) return;
    isAlarmPlaying = true;

    // Show banner and other UI changes
    document.getElementById('flame-alarm-banner').classList.remove('hidden');
    const stopBtn = document.getElementById('stop-alarm-btn-page');
    if (stopBtn) stopBtn.disabled = false;

    const safetyToggle = document.getElementById('safety-mechanism-toggle');
    console.log("ðŸ”¥ Fire Alarm - Safety Toggle:", safetyToggle ? safetyToggle.checked : 'NOT FOUND');
    console.log("ðŸ”¥ Fire Alarm - ESP Online Status:", isEspOnline);
    
    if (safetyToggle && safetyToggle.checked) {
        // Turn off all appliances - check if ESP is online first
        if (isEspOnline) {
            console.log("âš ï¸ SHUTTING DOWN ALL APPLIANCES - FIRE ALARM ACTIVE");
            for (let i = 1; i <= NUM_LIGHTS; i++) {
                const topic = `homeautomation/project/light/${i}/set`;
                console.log(`ðŸ’¡ Publishing OFF to ${topic}`);
                publishMessage(topic, "OFF");
            }
            for (let i = 1; i <= 2; i++) { // Assuming 2 fans
                const topic = `homeautomation/project/fan/${i}/set`;
                console.log(`ðŸŒ¬ï¸ Publishing 0 to ${topic}`);
                publishMessage(topic, "0");
            }
            
            // Show appliances off message
            document.getElementById('fire-alarm-appliances-off').classList.remove('hidden');
            addLog("FIRE ALARM TRIGGERED! All appliances turned off due to safety mechanism.", 'alarm');
            showToast("FIRE ALARM! All appliances turned off.", "error");
        } else {
            // ESP is offline, cannot control appliances
            console.error("âŒ Cannot turn off appliances - ESP is offline!");
            addLog("FIRE ALARM TRIGGERED! Cannot turn off appliances - ESP is offline.", 'alarm');
            showToast("FIRE ALARM! WARNING: Cannot control appliances (ESP offline)", "error");
        }
    } else {
        console.warn("âš ï¸ Fire alarm triggered but safety mechanism is OFF");
        addLog("FIRE ALARM TRIGGERED! Safety mechanism is off, appliances not turned off.", 'alarm');
        showToast("FIRE ALARM! Manual control is active.", "warning");
    }

    if (!skipFirebase && realtimeDb) {
        const { dbRef, set } = window.firebaseModules;
        const alarmRef = dbRef(realtimeDb, 'alarm/flame');
        set(alarmRef, { status: 'DETECTED', timestamp: Date.now() });
    }
}

function stopAlarm(skipFirebase = false) {
    if (!isAlarmPlaying) return;
    isAlarmPlaying = false;

    // Hide banner and other UI changes
    document.getElementById('flame-alarm-banner').classList.add('hidden');
    const stopBtn = document.getElementById('stop-alarm-btn-page');
    if (stopBtn) stopBtn.disabled = true;

    // Hide appliances off message
    document.getElementById('fire-alarm-appliances-off').classList.add('hidden');

    addLog("Fire alarm stopped.", 'alarm');
    showToast("Fire alarm stopped.", "success");

    if (!skipFirebase && realtimeDb) {
        const { dbRef, set } = window.firebaseModules;
        const alarmRef = dbRef(realtimeDb, 'alarm/flame');
        set(alarmRef, { status: 'CLEAR', timestamp: Date.now() });
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const safetyToggle = document.getElementById('safety-mechanism-toggle');
    const safetyOnExplanation = document.getElementById('safety-on-explanation');
    const safetyOffExplanation = document.getElementById('safety-off-explanation');

    // Initial state based on checkbox
    if (safetyToggle.checked) {
        safetyOnExplanation.classList.remove('hidden');
        safetyOffExplanation.classList.add('hidden');
    } else {
        safetyOnExplanation.classList.add('hidden');
        safetyOffExplanation.classList.remove('hidden');
    }

    safetyToggle.addEventListener('change', () => {
        if (safetyToggle.checked) {
            safetyOnExplanation.classList.remove('hidden');
            safetyOffExplanation.classList.add('hidden');
            addLog("Fire safety mechanism has been turned ON.", 'security');
            showToast("Fire safety mechanism is now ON.", "info");
        } else {
            safetyOnExplanation.classList.add('hidden');
            safetyOffExplanation.classList.remove('hidden');
            addLog("Fire safety mechanism has been turned OFF.", 'security');
            showToast("Fire safety mechanism is now OFF.", "warning");
        }
        updateSystemLockState(); // Update lock state on change
    });
});

// MQTT Functions
function connectMqtt() {
    // Prevent duplicate connection attempts
    if (isMqttConnecting) {
        console.log('ðŸ”„ MQTT connection already in progress, skipping...');
        return;
    }
    
    // Disconnect existing client if present
    if (client && client.isConnected()) {
        console.log('ðŸ”„ Disconnecting existing MQTT client...');
        try {
            client.disconnect();
        } catch (e) {
            console.warn('Error disconnecting MQTT:', e);
        }
    }
    
    isMqttConnecting = true;
    client = new Paho.Client(MQTT_BROKER, MQTT_PORT, "WebClient_" + Date.now());
    
    client.onConnectionLost = (resp) => {
        console.log("âŒ MQTT Connection lost:", resp.errorMessage);
        document.getElementById('mqtt-status').innerHTML = `
            <svg class="w-3 h-3 text-red-500" viewBox="0 0 12 12" fill="currentColor"><circle cx="6" cy="6" r="6"/></svg>
            <span class="text-sm font-semibold text-red-500">MQTT Offline</span>
        `;
        // Clear ESP status when MQTT disconnects
        updateEspStatus(false, 'mqtt-disconnect');
        
        // Auto-reconnect after 5 seconds (only if not manually disconnecting)
        if (resp.errorCode !== 0) {
            console.log('ðŸ”„ Auto-reconnecting in 5 seconds...');
            const reconnectTimer = setTimeout(() => {
                activeTimers.delete(reconnectTimer);
                console.log('ðŸ”„ Attempting MQTT reconnection...');
                isMqttConnecting = false; // Reset state before reconnecting
                connectMqtt();
            }, 5000);
            activeTimers.add(reconnectTimer);
        } else {
            isMqttConnecting = false; // Reset on manual disconnect
        }
    };
    
    client.onMessageArrived = (message) => {
        try {
            if (!message || !message.destinationName) {
                console.warn('Invalid MQTT message received:', message);
                return;
            }
            
            const topic = message.destinationName;
            const payload = message.payloadString;
            const retained = message.retained;
            console.log("ðŸ“¨ MQTT:", topic, "=", payload, "(retained:", retained + ")");

        // Accept heartbeat OR device status messages (lights/fans) for ESP detection
        // Ignore retained messages to prevent false positives from broker
        if (!retained) {
            // Heartbeat messages (best)
            if (topic.includes("heartbeat")) {
                lastHeartbeatTime = Date.now();
                updateEspStatus(true, 'heartbeat');
                console.log('ðŸ’“ Heartbeat from ESP');
            }
            // Device status messages (fallback when no heartbeat)
            else if (topic.includes("/status") && (topic.includes("light") || topic.includes("fan"))) {
                lastHeartbeatTime = Date.now();
                updateEspStatus(true, 'device-status');
            }
        }
        
        // Handle light status updates - IMMEDIATE, NO DELAYS
        if (topic.includes("light") && topic.includes("/status")) {
            const match = topic.match(/light\/(\d+)\/status/);
            if (match) {
                const lightId = match[1];
                updateLightUI(lightId, payload);
            }
        }
        
        // Handle fan status updates - IMMEDIATE, NO DELAYS
        if (topic.includes("fan") && topic.includes("/status")) {
            const match = topic.match(/fan\/(\d+)\/status/);
            if (match) {
                const fanId = match[1];
                const speed = parseInt(payload);
                updateFanUI(fanId, speed);
            }
        }
        
        // Handle fire alarm
        if (topic.includes("alarm/flame")) {
            // Normalize common payloads: 'DETECTED' or '1' means alarm ON; 'CLEAR' or '0' means alarm OFF
            if (payload === "DETECTED" || payload === "1") {
                startAlarm(false); // Will save to Firebase internally
            } else if (payload === "CLEAR" || payload === "0") {
                stopAlarm(false); // Will save to Firebase internally
            }
        }
        
        // Handle DHT22 sensor data from MQTT
        if (topic.includes("sensor/status")) {
            try {
                const data = JSON.parse(payload);
                console.log("ðŸŒ¡ï¸ DHT22 Sensor Data:", data);
                // Update UI IMMEDIATELY - no Firebase blocking!
                updateSensorUI(data);
                // Save to Firebase history for charts
                if (realtimeDb) {
                    try {
                        const { dbRef, push } = window.firebaseModules;
                        const historyRef = dbRef(realtimeDb, 'sensors/history');
                        push(historyRef, {
                            temperature: data.temperature || 0,
                            humidity: data.humidity || 0,
                            gasLevel: data.gasLevel || 0,
                            timestamp: Date.now()
                        });
                    } catch (saveError) {
                        console.error('Error saving sensor data to Firebase:', saveError);
                    }
                }
            } catch (error) {
                console.error('Error processing sensor data:', error);
            }
        }
        // Handle energy monitoring data (PZEM-004T) from MQTT
        else if (topic.includes("energy/status")) {
            // Update UI IMMEDIATELY - no Firebase blocking!
            updateEnergyMonitor(payload);
            // Save to Firebase history for charts
            if (realtimeDb) {
                try {
                    const data = JSON.parse(payload);
                    const { dbRef, push } = window.firebaseModules;
                    const historyRef = dbRef(realtimeDb, 'powerMonitor/history');
                    push(historyRef, {
                        voltage: data.voltage || 0,
                        current: data.current || 0,
                        power: data.power || 0,
                        energy: data.energy || 0,
                        frequency: data.frequency || 0,
                        powerFactor: data.pf || 0,
                        timestamp: Date.now()
                    });
                } catch (error) {
                    console.error('Error saving PZEM data to Firebase:', error);
                }
            }
        }
        // Handle fault alarm
        else if (topic.includes("alarm/fault")) {
            if (!retained) { // Only handle new (non-retained) fault messages
                handleFaultMessage(payload);
            } else {
                console.log("Ignoring retained fault message from MQTT broker.");
            }
        }
    } catch (error) {
        console.error('Error processing MQTT message:', error, { topic: message?.destinationName, payload: message?.payloadString });
    }
};
    
    client.connect({
        timeout: 3,
        useSSL: true,
        keepAliveInterval: 20,
        onSuccess: () => {
            isMqttConnecting = false; // Reset connection state
            console.log("MQTT Connected");
            showToast("MQTT connected!", "success");
            const mqttStatus = document.getElementById('mqtt-status');
            if (mqttStatus) {
                mqttStatus.innerHTML = `
                    <svg class="w-3 h-3 text-green-500" viewBox="0 0 12 12" fill="currentColor"><circle cx="6" cy="6" r="6"/></svg>
                    <span class="text-sm font-semibold text-green-500">MQTT Online</span>
                `;
            }
            
            // Sync ESP hardware to match Firebase saved states
            if (window.pendingESPSync) {
                setTimeout(() => {
                    console.log('ðŸ”„ Syncing ESP hardware to match Firebase saved states...');
                    
                    // Sync lights
                    Object.entries(window.pendingESPSync.lights).forEach(([deviceId, status]) => {
                        publishMessage(`homeautomation/project/light/${deviceId}/set`, status, false);
                        console.log(`ðŸ”„ Sync Light ${deviceId} â†’ ${status}`);
                    });
                    
                    // Sync fans
                    Object.entries(window.pendingESPSync.fans).forEach(([deviceId, speed]) => {
                        publishMessage(`homeautomation/project/fan/${deviceId}/set`, speed.toString(), false);
                        console.log(`ðŸ”„ Sync Fan ${deviceId} â†’ ${speed}%`);
                    });
                    
                    window.pendingESPSync = null;
                }, 1000); // Wait 1 second for MQTT to fully establish
            }
            
            // Subscribe to topics
            for (let i = 1; i <= NUM_LIGHTS; i++) {
                client.subscribe(`homeautomation/project/light/${i}/status`);
                client.subscribe(`homeautomation/project/fan/${i}/status`);
            }
            client.subscribe("homeautomation/project/alarm/flame");
            client.subscribe("homeautomation/project/energy/status");
            client.subscribe("homeautomation/project/alarm/fault");
            client.subscribe("homeautomation/project/sensor/status"); // Subscribe to DHT22 sensor data
            client.subscribe("homeautomation/project/heartbeat"); // Subscribe to heartbeat for ESP status
            
            addLog("Connected to MQTT broker", 'system');
            showToast("Connected successfully", "success");
        },
        onFailure: (err) => {
            isMqttConnecting = false; // Reset connection state
            console.error("MQTT Connection failed:", err);
            addLog("MQTT connection failed", 'system');
            showToast("Connection failed", "error");
            
            const mqttStatus = document.getElementById('mqtt-status');
            if (mqttStatus) {
                mqttStatus.innerHTML = `
                    <svg class="w-3 h-3 text-red-500" viewBox="0 0 12 12" fill="currentColor"><circle cx="6" cy="6" r="6"/></svg>
                    <span class="text-sm font-semibold text-red-500">MQTT Failed</span>
                `;
            }
        }
    });
}

function publishMessage(topic, payload, retained = false) {
    if (!client || !client.isConnected()) {
        showToast("Not connected", "warning");
        return;
    }
    const message = new Paho.Message(payload);
    message.destinationName = topic;
    message.retained = retained;
    client.send(message);
}

function reconnect() {
    console.log('ðŸ”„ Manual reconnect requested');
    if (client) {
        try {
            if (client.isConnected()) {
                client.disconnect();
                console.log('ðŸ“¡ Disconnected existing MQTT client');
            }
        } catch (error) {
            console.error("Error disconnecting client:", error);
        }
    }
    showToast("Reconnecting to MQTT...", "info");
    // Clear ESP status during reconnection
    updateEspStatus(false, 'reconnecting');
    
    // Reconnect without reloading page to preserve authentication state
    setTimeout(() => {
        connectMqtt();
        // After reconnecting, request status from ESP to check if it's online
        setTimeout(() => {
            requestESPStatus();
            showToast("Reconnection complete", "success");
        }, 2000); // Wait for MQTT connection to be fully established
    }, 1000);
}

// Request status from ESP devices to detect if they're online
function requestESPStatus() {
    if (!client || !client.isConnected()) {
        console.log("Cannot request ESP status: MQTT not connected");
        return;
    }
    
    console.log("Requesting status from ESP devices...");
    // Request status from all lights and fans
    // ESP will respond with current state, which will trigger updateEspStatus(true)
    for (let i = 1; i <= NUM_LIGHTS; i++) {
        publishMessage(`homeautomation/project/light/${i}/get`, "status", false);
    }
    for (let i = 1; i <= 2; i++) {
        publishMessage(`homeautomation/project/fan/${i}/get`, "status", false);
    }
    // Also request energy status
    publishMessage("homeautomation/project/energy/get", "status", false);
    
    addLog("Requested status update from ESP", 'system');
}

document.addEventListener('DOMContentLoaded', () => {
    const reconnectBtn = document.getElementById('reconnect-btn');
    if(reconnectBtn) {
        reconnectBtn.addEventListener('click', reconnect);
    }

    // Add event listener for the fire alarm history refresh button
    const refreshHistoryBtn = document.getElementById('refresh-alarm-history-btn-page');
    if(refreshHistoryBtn) {
        refreshHistoryBtn.addEventListener('click', loadAlarmHistory);
    }
});

// --- Page Navigation ---
function showPage(pageName) {
    window.scrollTo(0, 0); // Scroll to the top of the page on navigation
    // Hide all pages
    ['control', 'monitor', 'analytics', 'logs', 'faults', 'menu', 'fire-alarm'].forEach(p => {
        const pageEl = document.getElementById(`page-${p}`);
        if (pageEl) pageEl.classList.add('hidden');
    });
    
    // Deactivate all nav tabs
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    
    // Show selected page
    const pageToShow = document.getElementById(`page-${pageName}`);
    if (pageToShow) {
        pageToShow.classList.remove('hidden');
    }
    
    // Activate the corresponding nav tab if it exists
    const tabToActivate = document.querySelector(`.nav-tab[data-page="${pageName}"]`);
    if (tabToActivate) {
        tabToActivate.classList.add('active');
    }

    // --- Page-specific logic ---
    if (pageName === 'fire-alarm') {
        loadAlarmHistory();
    }

    if (pageName === 'analytics') {
        isAnalyticsPageActive = true;
        
        // Initialize all charts if not already done
        initSensorCharts();
        initPZEMCharts();
        initCharts();

        // Force a resize after a short delay to ensure containers are visible
        setTimeout(() => {
            [
                tempHistoryChart, humidityHistoryChart, gasHistoryChart,
                powerHistoryChart, voltageHistoryChart, currentHistoryChart, energyHistoryChart,
                lightsTimelineChart, fansTimelineChart,
                pieChart, barChart
            ].forEach(chart => {
                if (chart) chart.resize();
            });
        }, 100);

        // Load initial data for all analytics sections
        loadSensorData(currentSensorTimeRange);
        loadPZEMData(currentPZEMTimeRange);
        loadDeviceUsageAnalytics(currentDeviceTimeRange);
        
        // Start real-time listeners for live updates
        console.log('ðŸ”´ Starting all real-time analytics listeners...');
        startSensorRealtimeListener(currentSensorTimeRange);
        startPZEMRealtimeListener(currentPZEMTimeRange);
        startDeviceUsageRealtimeListener(currentDeviceTimeRange);

    } else {
        // Stop analytics listeners if we are navigating away from the page
        if (isAnalyticsPageActive) {
            isAnalyticsPageActive = false;
            console.log('ðŸ›‘ Stopping all real-time analytics listeners...');
            stopSensorRealtimeListener();
            stopPZEMRealtimeListener();
            stopDeviceUsageRealtimeListener();
        }
    }

    // Load data for Logs and Faults pages (they share some data)
    if (pageName === 'logs') {
        loadLogsFromFirebase();
    }
    if (pageName === 'faults') {
        loadFaultHistory();
    }

    updateFloatingVoiceButtonVisibility();
}

document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => showPage(tab.dataset.page));
});

function updateLightUI(deviceId, status) {
    try {
        // Validate input
        if (deviceId === undefined || deviceId === null || status === undefined || status === null) {
            console.warn('Invalid updateLightUI parameters:', { deviceId, status });
            return;
        }
        
        console.log(`ðŸ’¡ updateLightUI: deviceId=${deviceId}, status=${status}`);
        
        // Find the light device with this deviceId
        const light = appliances.find(app => app.type === 'light' && app.deviceId == deviceId);
        if (!light) {
            console.warn(`âš ï¸ Light device not found for deviceId: ${deviceId}`);
            return;
        }
        
        const lightId = light.id;
        console.log(`ðŸ’¡ Found light: id=${lightId}, name=${light.name}`);
        
        const toggle = document.getElementById(`light-toggle-${lightId}`);
        const statusEl = document.getElementById(`status-badge-${lightId}`);
        const card = document.getElementById(`card-${lightId}`);
        const iconContainer = document.getElementById(`icon-container-${lightId}`);
        
        if (!toggle) {
            console.warn(`âš ï¸ Toggle element not found for light ${lightId}`);
            return;
        }
    
    const isOn = (status === "ON");
    toggle.checked = isOn;
    console.log(`âœ… Updated toggle for light ${lightId}: checked=${isOn}`);
    
    // Save state to Firebase for persistence
    if (realtimeDb && light) {
        try {
            const { dbRef, set } = window.firebaseModules;
            const stateRef = dbRef(realtimeDb, `deviceStates/light/${deviceId}`);
            set(stateRef, { status, timestamp: Date.now() });
        } catch (error) {
            console.error('Error saving light state to Firebase:', error);
        }
    }
    
    // Track device usage only if appliance name exists
    if (light && light.name) {
        trackDeviceUsage(light.name, 'light', status);
    }
    
    if (statusEl) {
        statusEl.textContent = status;
        statusEl.className = `status-badge absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 ${isOn ? 'status-online' : 'status-offline'}`;
    }
    
    if (card) {
        if (isOn) card.classList.add('card-on');
        else card.classList.remove('card-on');
    }
    
    if (iconContainer) {
        if (isOn) iconContainer.classList.add('icon-on');
        else iconContainer.classList.remove('icon-on');
    }
    
        updateDashboard();
    } catch (error) {
        console.error('Error in updateLightUI:', error, { deviceId, status });
    }
}

function updateFanUI(deviceId, speed) {
    // Find the fan device with this deviceId
    const fan = appliances.find(app => app.type === 'fan' && app.deviceId == deviceId);
    if (!fan) {
        // Silently ignore - device not configured in appliances array
        return;
    }
    
    const fanId = fan.id;
    const statusEl = document.getElementById(`status-badge-${fanId}`);
    const card = document.getElementById(`card-${fanId}`);
    const iconContainer = document.getElementById(`icon-container-${fanId}`);
    const slider = document.getElementById(`fan-slider-${fanId}`);
    const speedDisplay = document.getElementById(`fan-speed-${fanId}`);
    
    // Save state to Firebase for persistence
    if (realtimeDb && fan) {
        try {
            const { dbRef, set } = window.firebaseModules;
            const stateRef = dbRef(realtimeDb, `deviceStates/fan/${deviceId}`);
            set(stateRef, { speed, timestamp: Date.now() });
        } catch (error) {
            console.error('Error saving fan state to Firebase:', error);
        }
    }
    
    // Track device usage only if appliance name exists
    if (fan && fan.name) {
        trackDeviceUsage(fan.name, 'fan', speed > 0 ? 'ON' : 'OFF', speed);
    }
    
    if (statusEl) {
        statusEl.textContent = speed > 0 ? `${speed}%` : "OFF";
        statusEl.className = `status-badge absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 ${speed > 0 ? 'status-online' : 'status-offline'}`;
    }
    
    if (card) {
        if (speed > 0) card.classList.add('card-on');
        else card.classList.remove('card-on');
    }
    
    if (iconContainer) {
        if (speed > 0) iconContainer.classList.add('icon-on');
        else iconContainer.classList.remove('icon-on');
    }
    
    // Update slider and speed display
    if (slider) {
        slider.value = speed;
    }
    
    if (speedDisplay) {
        speedDisplay.textContent = `${speed}%`;
    }
    
    updateDashboard();
}

function updateDashboard() {
    let onCount = 0;
    let totalCount = 0;
    appliances.forEach(app => {
        totalCount++;
        if (app.type === 'light') {
            const toggle = document.getElementById(`light-toggle-${app.id}`);
            if (toggle && toggle.checked) onCount++;
        } else if (app.type === 'fan') {
            const slider = document.getElementById(`fan-slider-${app.id}`);
            if (slider && parseInt(slider.value) > 0) onCount++;
        }
    });
    
    document.getElementById('dashboard-total-lights').textContent = totalCount;
    document.getElementById('dashboard-on-count').textContent = onCount;
    document.getElementById('dashboard-off-count').textContent = totalCount - onCount;
    
    // Update timer status
    updateTimerStatusDisplay();
}

// NOTE: updatePZEMUI is now defined as throttled function later in the code (line ~5735)
// See: const updatePZEMUI = throttle(_updatePZEMUIInternal, 300);

// Energy Monitor Update from MQTT (legacy function for backwards compatibility)
function updateEnergyMonitor(payload) {
    console.log("ðŸ”‹ PZEM MQTT Data:", payload);
    try {
        const data = JSON.parse(payload);
        updatePZEMUI(data);
    } catch (error) {
        console.error('Error parsing PZEM MQTT data:', error);
        const pzemStatus = document.getElementById('pzem-status');
        const pzemStatusText = document.getElementById('pzem-status-text');
        if (pzemStatus) pzemStatus.className = 'w-3 h-3 rounded-full bg-red-500';
        if (pzemStatusText) {
            pzemStatusText.textContent = 'Error';
            pzemStatusText.className = 'text-sm text-red-600';
        }
    }
}

// Calculate energy costs and update UI
function calculateEnergyCost() {
    const pricePerKWh = parseFloat(document.getElementById('price-per-kwh')?.value) || 6.5;
    const energyEl = document.getElementById('pzem-energy');
    const powerEl = document.getElementById('pzem-power');
    
    if (!energyEl || !powerEl) return;
    
    const energyText = energyEl.textContent;
    const powerText = powerEl.textContent;
    
    const energy = parseFloat(energyText) || 0;
    const power = parseFloat(powerText) || 0;
    
    // Total cost based on consumed energy
    const totalCost = (energy * pricePerKWh).toFixed(2);
    
    // Estimated daily cost at current power level
    const dailyEnergy = (power / 1000) * 24; // kWh per day
    const dailyCost = (dailyEnergy * pricePerKWh).toFixed(2);
    
    // Estimated monthly cost
    const monthlyCost = (dailyCost * 30).toFixed(2);
    
    const totalCostEl = document.getElementById('total-energy-cost');
    const dailyCostEl = document.getElementById('daily-cost-estimate');
    const monthlyCostEl = document.getElementById('monthly-cost-estimate');
    
    if (totalCostEl) totalCostEl.textContent = 'â‚¹ ' + totalCost;
    if (dailyCostEl) dailyCostEl.textContent = 'â‚¹ ' + dailyCost;
    if (monthlyCostEl) monthlyCostEl.textContent = 'â‚¹ ' + monthlyCost;
}

function handleFaultMessage(reason) {
    try {
        const faultToggle = document.getElementById('fault-protection-toggle');
        if (faultToggle && !faultToggle.checked) {
            addLog(`Fault detected but protection is OFF: ${reason}`, 'fault');
            showToast(`FAULT: ${reason} (Protection OFF)`, 'warning');
            return; // Do not proceed if protection is off
        }

        // The only job of this function is to write the fault to Firebase.
        // The onValue listener for 'alarms/fault/current' will handle all UI updates.
        if (realtimeDb && window.firebaseModules) {
            const { dbRef, set, push } = window.firebaseModules;
            const faultAlarmRef = dbRef(realtimeDb, 'alarms/fault/current');
            set(faultAlarmRef, { active: true, reason: reason, timestamp: Date.now() }).catch(error => {
                console.error('Error writing fault to Firebase:', error);
            });

            // Also save to historical log
            const faultHistoryRef = dbRef(realtimeDb, 'faults/history');
            const faultEntry = {
                time: new Date().toLocaleString(),
                timestamp: Date.now(),
                text: reason
            };
            push(faultHistoryRef, faultEntry).catch(error => {
                console.error('Error saving fault history:', error);
            });
            addLog(`âš¡ FAULT TRIGGERED: ${reason}`, 'fault');
        } else {
            console.warn('Firebase not ready, cannot save fault');
        }
    } catch (error) {
        console.error('Error in handleFaultMessage:', error, { reason });
    }
}

async function loadFaultHistory() {
    const container = document.getElementById('fault-log-container');
    if (!container) return;
    container.innerHTML = '<div class="text-center text-gray-500 py-8"><p>Loading fault history...</p></div>';

    if (!realtimeDb) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8"><p>Realtime DB not initialized.</p></div>';
        return;
    }

    const { dbRef, get, query, orderByChild, limitToLast } = window.firebaseModules;
    const faultHistoryRef = dbRef(realtimeDb, 'faults/history');
    const q = query(faultHistoryRef, orderByChild('timestamp'), limitToLast(200));
    
    try {
        const snapshot = await get(q);
        if (snapshot.exists()) {
            const data = snapshot.val();
            faultEntries = Object.values(data).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            renderFaultLog();
            updateFaultStatsChart(faultEntries);
        } else {
            container.innerHTML = '<div class="text-gray-500 text-center py-4">No faults recorded.</div>';
            updateFaultStatsChart([]);
        }
    } catch (err) {
        console.error('Error loading fault history', err);
        container.innerHTML = '<div class="text-center text-red-500 py-8"><p>Error loading fault history.</p></div>';
    }
}

function renderFaultLog() {
    const container = document.getElementById('fault-log-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (faultEntries.length === 0) {
        container.innerHTML = '<div class="text-gray-500 text-center py-4">No faults recorded.</div>';
        return;
    }
    
    faultEntries.forEach(entry => {
        container.innerHTML += `
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-2 rounded mt-2">
                <span class="font-bold">[${entry.time}]</span> ${entry.text}
            </div>`;
    });
    
    container.scrollTop = container.scrollHeight;
}

document.addEventListener('DOMContentLoaded', () => {
    // ... other listeners
    const clearFaultsBtn = document.getElementById('clear-faults-btn');
    if(clearFaultsBtn) {
        clearFaultsBtn.addEventListener('click', async () => {
            if (confirm("Are you sure you want to clear the fault history? This action cannot be undone.")) {
                faultEntries = [];
                renderFaultLog();
                updateFaultStatsChart([]);
                addLog("Fault history cleared by user.", 'system');
                showToast("Fault history cleared.", "info");

                // Clear in Firebase
                if (realtimeDb) {
                    const { dbRef, set } = window.firebaseModules;
                    const faultHistoryRef = dbRef(realtimeDb, 'faults/history');
                    await set(faultHistoryRef, null);
                }
            }
        });
    }
});

function initFaultStatsChart() {
    const faultChartEl = document.getElementById('fault-stats-chart');
    if(!faultChartEl) return;
    const ctx = faultChartEl.getContext('2d');
    const faultStatsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Low Voltage', 'High Voltage', 'High Current'],
            datasets: [{
                label: 'Faults',
                data: [0, 0, 0],
                backgroundColor: [
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 206, 86, 0.7)',
                    'rgba(255, 99, 132, 0.7)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(255, 99, 132, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Fault Distribution'
                }
            }
        }
    });
    return faultStatsChart;
}

function updateFaultStatsChart(faults) {
    const chart = Chart.getChart('fault-stats-chart');
    if (!chart) return;

    let lowVoltage = 0;
    let highVoltage = 0;
    let highCurrent = 0;

    faults.forEach(fault => {
        if (fault.text.toLowerCase().includes('low voltage')) lowVoltage++;
        if (fault.text.toLowerCase().includes('high voltage')) highVoltage++;
        if (fault.text.toLowerCase().includes('high current')) highCurrent++;
    });

    chart.data.datasets[0].data = [lowVoltage, highVoltage, highCurrent];
    chart.update();
}

document.addEventListener('DOMContentLoaded', () => {
    const faultProtectionToggle = document.getElementById('fault-protection-toggle');
    const faultProtectionOnExplanation = document.getElementById('fault-protection-on-explanation');
    const faultProtectionOffExplanation = document.getElementById('fault-protection-off-explanation');
    const saveThresholdsBtn = document.getElementById('save-fault-thresholds');
    const lowVoltageInput = document.getElementById('low-voltage-threshold');
    const highVoltageInput = document.getElementById('high-voltage-threshold');
    const highCurrentInput = document.getElementById('high-current-threshold');

    if(faultProtectionToggle) {
        faultProtectionToggle.addEventListener('change', () => {
            if (faultProtectionToggle.checked) {
                faultProtectionOnExplanation.classList.remove('hidden');
                faultProtectionOffExplanation.classList.add('hidden');
                addLog("Fault protection has been turned ON.", 'security');
                showToast("Fault protection is now ON.", "info");
            } else {
                faultProtectionOnExplanation.classList.add('hidden');
                faultProtectionOffExplanation.classList.remove('hidden');
                addLog("Fault protection has been turned OFF.", 'security');
                showToast("Fault protection is now OFF.", "warning");
            }
            updateSystemLockState(); // Update lock state on change
        });
    }

    if(saveThresholdsBtn) {
        saveThresholdsBtn.addEventListener('click', async () => {
            const thresholds = {
                lowVoltage: parseFloat(lowVoltageInput.value),
                highVoltage: parseFloat(highVoltageInput.value),
                highCurrent: parseFloat(highCurrentInput.value)
            };

            if (realtimeDb) {
                const { dbRef, set } = window.firebaseModules;
                const thresholdsRef = dbRef(realtimeDb, 'faults/thresholds');
                try {
                    await set(thresholdsRef, thresholds);
                    addLog("Fault thresholds saved.", 'system');
                    showToast("Fault thresholds saved successfully!", "success");
                } catch (error) {
                    console.error("Error saving fault thresholds:", error);
                    showToast("Failed to save thresholds.", "error");
                }
            }
        });
    }
    
    if (realtimeDb) {
        const { dbRef, onValue } = window.firebaseModules;
        const thresholdsRef = dbRef(realtimeDb, 'faults/thresholds');
        onValue(thresholdsRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                // Update UI inputs
                lowVoltageInput.value = data.lowVoltage;
                highVoltageInput.value = data.highVoltage;
                highCurrentInput.value = data.highCurrent;
                
                // Sync to global variable for threshold checking
                currentThresholds.lowVoltage = data.lowVoltage;
                currentThresholds.highVoltage = data.highVoltage;
                currentThresholds.highCurrent = data.highCurrent;
                
                console.log("âœ… Thresholds synchronized:", currentThresholds);
                addLog("Fault thresholds synchronized across devices.", 'system');
            }
        });
    }

    document.getElementById('test-low-voltage')?.addEventListener('click', () => handleFaultMessage('Low Voltage Detected'));
    document.getElementById('test-high-voltage')?.addEventListener('click', () => handleFaultMessage('High Voltage Detected'));
    document.getElementById('test-high-current')?.addEventListener('click', () => handleFaultMessage('High Current Detected'));
    document.getElementById('stop-fault-alarm')?.addEventListener('click', () => {
        stopFaultAlarm();
    });
    
    initFaultStatsChart();
});

// Fire Alarm
let currentAlarmId = null;

// Robust alarm sound using a single AudioContext and persistent oscillators
function initAlarmSound() {
    try {
        if (window._alarmInit) return;
        window._alarmInit = true;

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) {
            console.warn('Web Audio API not supported');
            return;
        }

        const ctx = new AudioContext();
        window._alarmAudioCtx = ctx;
        window._alarmNodes = [];
        window._alarmHeartbeat = null;

    window.playSirenSound = function() {
        try {
            if (!ctx) return;
            if (ctx.state === 'suspended') ctx.resume().catch(()=>{});

            // If already playing, don't create new nodes
            if (window._alarmNodes.length > 0) return;

            const masterGain = ctx.createGain();
            masterGain.gain.value = 0.5;
            masterGain.connect(ctx.destination);

            // Wailing oscillator
            const osc = ctx.createOscillator();
            osc.type = 'sawtooth';
            osc.frequency.value = 600;

            const lfo = ctx.createOscillator();
            lfo.type = 'sine';
            lfo.frequency.value = 0.6;
            const lfoGain = ctx.createGain();
            lfoGain.gain.value = 300;
            lfo.connect(lfoGain);
            lfoGain.connect(osc.frequency);

            const oscGain = ctx.createGain();
            oscGain.gain.value = 0.9;
            osc.connect(oscGain);
            oscGain.connect(masterGain);

            // High urgency overlay
            const overlay = ctx.createOscillator();
            overlay.type = 'triangle';
            overlay.frequency.value = 1200;
            const overlayGain = ctx.createGain();
            overlayGain.gain.value = 0.12;
            overlay.connect(overlayGain);
            overlayGain.connect(masterGain);

            // Start nodes
            lfo.start();
            osc.start();
            overlay.start();

            // Save nodes for cleanup
            window._alarmNodes.push({ lfo, lfoGain, osc, oscGain, masterGain, overlay, overlayGain });

            // Heartbeat to resume context if suspended
            if (!window._alarmHeartbeat) {
                window._alarmHeartbeat = setInterval(() => {
                    if (ctx.state === 'suspended') ctx.resume().catch(()=>{});
                }, 1000);
                activeIntervals.add(window._alarmHeartbeat);
            }
        } catch (e) {
            console.error('Error starting siren', e);
        }
    };

    window.stopAlarmSound = function() {
        try {
            if (!window._alarmNodes || window._alarmNodes.length === 0) return;

            window._alarmNodes.forEach(n => {
                try { if (n.lfo && n.lfo.stop) n.lfo.stop(0); } catch(e){}
                try { if (n.osc && n.osc.stop) n.osc.stop(0); } catch(e){}
                try { if (n.overlay && n.overlay.stop) n.overlay.stop(0); } catch(e){}
                try { n.lfo && n.lfo.disconnect(); } catch(e){}
                try { n.lfoGain && n.lfoGain.disconnect(); } catch(e){}
                try { n.osc && n.osc.disconnect(); } catch(e){}
                try { n.oscGain && n.oscGain.disconnect(); } catch(e){}
                try { n.overlay && n.overlay.disconnect(); } catch(e){}
                try { n.overlayGain && n.overlayGain.disconnect(); } catch(e){}
                try { n.masterGain && n.masterGain.disconnect(); } catch(e){}
            });

            window._alarmNodes = [];
            if (window._alarmHeartbeat) {
                clearInterval(window._alarmHeartbeat);
                activeIntervals.delete(window._alarmHeartbeat);
                window._alarmHeartbeat = null;
            }
        } catch (e) {
            console.error('Error stopping siren', e);
        }
    };
    } catch (error) {
        console.error('Error initializing alarm sound:', error);
        window._alarmInit = false; // Reset on error
    }
}

// New sound for fault alarm
function initFaultAlarmSound() {
    try {
        if (window._faultAlarmInit) return;
        window._faultAlarmInit = true;

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) {
            console.warn('Web Audio API not supported');
            return;
        }

        const ctx = new AudioContext();
        window._faultAlarmAudioCtx = ctx;
        window._faultAlarmInterval = null;

    window.playFaultSound = function() {
        try {
            if (!ctx) return;
            if (ctx.state === 'suspended') ctx.resume().catch(()=>{});
            if (window._faultAlarmInterval) return; // Already playing

            window._faultAlarmInterval = setInterval(() => {
                if (ctx.state === 'suspended') ctx.resume().catch(()=>{});
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(880, ctx.currentTime); // A5
                gain.gain.setValueAtTime(0.5, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.2);
            }, 400);
            activeIntervals.add(window._faultAlarmInterval);

        } catch (e) {
            console.error('Error starting fault sound', e);
        }
    };

    window.stopFaultSound = function() {
        try {
            if (window._faultAlarmInterval) {
                clearInterval(window._faultAlarmInterval);
                activeIntervals.delete(window._faultAlarmInterval);
                window._faultAlarmInterval = null;
            }
        } catch (e) {
            console.error('Error stopping fault sound', e);
        }
    };
    } catch (error) {
        console.error('Error initializing fault alarm sound:', error);
        window._faultAlarmInit = false; // Reset on error
    }
}

// Save fire alarm to Firebase history (consistent path)
async function saveFireAlarmHistory(status) {
    if (!realtimeDb || !window.firebaseModules) {
        console.warn('Firebase not ready, cannot save alarm history');
        return;
    }
    
    try {
        const { dbRef, push, set } = window.firebaseModules;
        const alarmData = {
            type: 'fire',
            status: status, // 'detected' or 'stopped'
            timestamp: Date.now(),
            time: new Date().toLocaleString(),
            user: currentUser ? currentUser.email : 'System'
        };

        const historyRef = dbRef(realtimeDb, 'alarms/fire/history');
        const newAlarmRef = push(historyRef);
        await set(newAlarmRef, alarmData);

        // update current status
        const currentRef = dbRef(realtimeDb, 'alarms/fire/current');
        await set(currentRef, { active: status === 'detected', ...alarmData });

        console.log(`ðŸ”¥ Fire alarm ${status} saved to alarms/fire/history`);
        return newAlarmRef.key;
    } catch (e) {
        console.error('Error saving fire alarm history', e);
    }
}

function startAlarm(skipFirebaseUpdate = false) {
    if (isAlarmPlaying) return;
    isAlarmPlaying = true;
    updateSystemLockState(); // Update lock state

    // visual
    const banner = document.getElementById('flame-alarm-banner');
    if (banner) banner.classList.remove('hidden');

    // enable page stop buttons
    ['stop-alarm-btn', 'stop-alarm-btn-page'].forEach(id => {
        const el = document.getElementById(id);
        if (el) { el.disabled = false; el.classList.remove('bg-gray-400'); el.classList.add('bg-red-600','hover:bg-red-700'); }
    });

    // audio
    initAlarmSound();
    if (window.playSirenSound) window.playSirenSound();

    // persist in DB (unless this action already came from DB)
    if (!skipFirebaseUpdate) {
        saveFireAlarmHistory('detected').then(id => currentAlarmId = id);
    }

    addLog('ðŸš¨ FIRE ALARM TRIGGERED!', 'alarm');
    showToast('ðŸ”¥ FIRE DETECTED!', 'error');

    // title blink
    if (!window._alarmTitleInterval) {
        const originalTitle = document.title || 'Smart Home Automation';
        window._alarmTitleInterval = setInterval(() => {
            if (isAlarmPlaying) document.title = document.title === originalTitle ? 'ðŸ”¥ FIRE ALARM! ðŸ”¥' : originalTitle;
            else { document.title = originalTitle; clearInterval(window._alarmTitleInterval); window._alarmTitleInterval = null; }
        }, 1000);
    }
}

function stopAlarm(skipFirebaseUpdate = false) {
    if (!isAlarmPlaying) return;
    isAlarmPlaying = false;
    updateSystemLockState(); // Update lock state

    // visual
    const banner = document.getElementById('flame-alarm-banner');
    if (banner) banner.classList.add('hidden');

    // disable stop buttons
    ['stop-alarm-btn', 'stop-alarm-btn-page'].forEach(id => {
        const el = document.getElementById(id);
        if (el) { el.disabled = true; el.classList.add('bg-gray-400'); el.classList.remove('bg-red-600','hover:bg-red-700'); }
    });

    // stop audio
    try { if (window.stopAlarmSound) window.stopAlarmSound(); } catch(e) { console.error(e); }

    // save to DB unless this stop was triggered by DB listener
    if (!skipFirebaseUpdate) saveFireAlarmHistory('stopped');

    addLog('âœ“ Fire alarm stopped', 'alarm');
    showToast('Alarm stopped', 'success');

    // reset title
    document.title = 'Smart Home Automation';
}

function startFaultAlarm(reason, skipFirebaseUpdate = false) {
    if (isFaultAlarmPlaying) return;
    isFaultAlarmPlaying = true;
    updateSystemLockState(); // Update lock state

    // Visual
    const banner = document.getElementById('fault-alarm-banner');
    const bannerContent = document.getElementById('fault-banner-content');
    if (banner && bannerContent) {
        bannerContent.innerHTML = `âš¡ ${reason.toUpperCase()}! âš¡`;
        banner.classList.remove('hidden');
    }

    // Enable stop button
    const stopBtn = document.getElementById('stop-fault-alarm');
    if (stopBtn) {
        stopBtn.disabled = false;
        stopBtn.classList.remove('bg-gray-400');
        stopBtn.classList.add('bg-red-600', 'hover:bg-red-700');
    }

    // Audio
    initFaultAlarmSound();
    if (window.playFaultSound) window.playFaultSound();

    // persist in DB (unless this action already came from DB)
    if (!skipFirebaseUpdate && realtimeDb) {
        const { dbRef, set } = window.firebaseModules;
        const faultAlarmRef = dbRef(realtimeDb, 'alarms/fault/current');
        set(faultAlarmRef, { active: true, reason: reason, timestamp: Date.now() });
    }

    addLog(`ðŸš¨ FAULT ALARM: ${reason}`, 'fault');
    showToast(`FAULT DETECTED: ${reason}`, 'error');
}

function resetEmergency() {
    const banner = document.getElementById('emergency-shutdown-banner');
    if (banner) {
        banner.classList.add('hidden');
    }

    const statusDiv = document.getElementById('fault-system-status');
    if (statusDiv) {
        statusDiv.className = 'bg-green-100 border-l-4 border-green-500 text-green-700 p-4';
        statusDiv.innerHTML = '<p class="font-bold">All Systems Normal</p><p>No faults detected. System is operating within safe parameters.</p>';
    }
}

function stopFaultAlarm(skipFirebaseUpdate = false) {
    if (!isFaultAlarmPlaying) return;
    isFaultAlarmPlaying = false;

    // Visual
    const banner = document.getElementById('fault-alarm-banner');
    if (banner) banner.classList.add('hidden');

    // Disable stop button
    const stopBtn = document.getElementById('stop-fault-alarm');
    if (stopBtn) {
        stopBtn.disabled = true;
        stopBtn.classList.add('bg-gray-400');
        stopBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
    }

    // Stop audio
    if (window.stopFaultSound) window.stopFaultSound();

    // save to DB unless this stop was triggered by DB listener
    if (!skipFirebaseUpdate && realtimeDb) {
        const { dbRef, set } = window.firebaseModules;
        const faultAlarmRef = dbRef(realtimeDb, 'alarms/fault/current');
        set(faultAlarmRef, { active: false, timestamp: Date.now() });
    }

    addLog('âœ“ Fault alarm stopped', 'fault');
    showToast('Fault alarm stopped', 'success');

    // Also reset the other banner and status
    resetEmergency();
    updateSystemLockState(); // Update lock state
}

function updateSystemLockState() {
    const fireSafetyToggle = document.getElementById('safety-mechanism-toggle');
    const faultSafetyToggle = document.getElementById('fault-protection-toggle');

    const isFireLockActive = isAlarmPlaying && fireSafetyToggle && fireSafetyToggle.checked;
    const isFaultLockActive = isFaultAlarmPlaying && faultSafetyToggle && faultSafetyToggle.checked;

    const shouldLock = isFireLockActive || isFaultLockActive;

    const controlsContainer = document.getElementById('light-card-container');
    const allControlsPage = document.getElementById('page-control'); // Or a more global container
    if (!controlsContainer || !allControlsPage) return;

    if (shouldLock && !isSystemLocked) {
        // --- LOCK THE SYSTEM ---
        isSystemLocked = true;
        console.log("SYSTEM LOCK: ENGAGED");
        addLog("System locked. All devices disabled.", "security");
        showToast("Safety Lock Engaged: Controls Disabled", "warning");

        // Disable UI
        allControlsPage.style.pointerEvents = 'none';
        allControlsPage.style.opacity = '0.6';

        // Forcibly turn off all devices - check ESP online status
        if (isEspOnline) {
            console.log("âš ï¸ SYSTEM LOCK: Turning off all appliances");
            appliances.forEach(app => {
                if (app.type === 'light') {
                    const topic = `homeautomation/project/light/${app.deviceId}/set`;
                    console.log(`ðŸ’¡ LOCK: Publishing OFF to ${topic}`);
                    publishMessage(topic, "OFF");
                } else if (app.type === 'fan') {
                    const topic = `homeautomation/project/fan/${app.deviceId}/set`;
                    console.log(`ðŸŒ¬ï¸ LOCK: Publishing 0 to ${topic}`);
                    publishMessage(topic, "0");
                }
            });
        } else {
            console.error("âŒ SYSTEM LOCK: Cannot turn off appliances - ESP is offline");
            showToast("WARNING: Cannot control appliances (ESP offline)", "error");
        }
        
    } else if (!shouldLock && isSystemLocked) {
        // --- UNLOCK THE SYSTEM ---
        isSystemLocked = false;
        console.log("SYSTEM LOCK: DISENGAGED");
        addLog("System unlocked. Controls enabled.", "security");
        showToast("Safety Lock Disengaged: Controls Enabled", "success");

        // Re-enable UI
        allControlsPage.style.pointerEvents = 'auto';
        allControlsPage.style.opacity = '1';
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// Load Fire Alarm History (robust)
async function loadAlarmHistory() {
    const container = document.getElementById('alarm-history-container-page');
    if (!container) return;
    container.innerHTML = '<div class="text-center text-gray-500 py-8"><p>Loading alarm history...</p></div>';

    if (!realtimeDb) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8"><p>Realtime DB not initialized.</p></div>';
        return;
    }

    const { dbRef, get, query, orderByChild, limitToLast } = window.firebaseModules;
    const possiblePaths = ['alarms/fire/history', 'alarms/history'];
    const allItems = [];
    
    try {
        for (const p of possiblePaths) {
            const ref = dbRef(realtimeDb, p);
            const q = query(ref, orderByChild('timestamp'), limitToLast(200));
            const snap = await get(q);
            if (snap && snap.exists()) {
                snap.forEach(child => {
                    const item = child.val();
                    item._key = child.key; 
                    allItems.push(item);
                });
            }
        }

        if (fireAlarmHistoryChart) {
            fireAlarmHistoryChart.destroy();
        }

        if (allItems.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8"><p>No alarm history found.</p></div>';
            // Still show an empty chart
            const ctx = document.getElementById('fireAlarmChart').getContext('2d');
            fireAlarmHistoryChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'No data to display' } } }
            });
            return;
        }

        const uniqueItems = Array.from(new Map(allItems.map(item => [item._key, item])).values());
        uniqueItems.sort((a,b) => (b.timestamp||0) - (a.timestamp||0));
        
        const itemsToDisplay = uniqueItems.slice(0, 200);

        // Process data for the chart
        const last7Days = [...Array(7)].map((_, i) => {
            const d = new Date();
            d.setDate(d.getDate() - i);
            return d.toLocaleDateString('en-CA'); // YYYY-MM-DD format
        }).reverse();

        const alarmCounts = last7Days.map(day => {
            return itemsToDisplay.filter(item => {
                if (!item.timestamp) return false;
                const itemDate = new Date(item.timestamp).toLocaleDateString('en-CA');
                const isDetected = (item.status || item.action || 'detected') === 'detected' || (item.status || item.action || 'detected') === true || (item.status || item.action || 'detected') === 'start' || (item.status || item.action || 'detected') === 'DETECTED';
                return itemDate === day && isDetected;
            }).length;
        });

        const labels = last7Days.map(day => {
            const d = new Date(day);
            return d.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' });
        });
        
        const ctx = document.getElementById('fireAlarmChart').getContext('2d');
        fireAlarmHistoryChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Fire Alarms',
                    data: alarmCounts,
                    backgroundColor: 'rgba(239, 68, 68, 0.6)',
                    borderColor: 'rgba(220, 38, 38, 1)',
                    borderWidth: 1,
                    borderRadius: 5,
                    hoverBackgroundColor: 'rgba(220, 38, 38, 0.8)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
                    x: { grid: { display: false } }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.7)',
                        titleFont: { size: 14 },
                        bodyFont: { size: 12 },
                        callbacks: {
                            label: function(context) {
                                return `Alarms: ${context.parsed.y}`;
                            }
                        }
                    }
                }
            }
        });

        container.innerHTML = itemsToDisplay.map(entry => {
            const ts = entry.timestamp ? new Date(entry.timestamp).toLocaleString() : 'Unknown time';
            const status = entry.status || entry.action || 'detected';
            const isDetected = (status === 'detected' || status === true || status === 'start' || status === 'DETECTED');
            const label = isDetected ? 'Fire Alarm Triggered' : 'Fire Alarm Stopped';
            const colorBg = isDetected ? 'bg-red-100' : 'bg-green-100';
            const iconBg = isDetected ? 'bg-red-500' : 'bg-green-500';
            const icon = isDetected ? 'ðŸ”¥' : 'âœ…';
            const note = entry.note ? `<div class="text-sm text-gray-600">${escapeHtml(entry.note)}</div>` : '';
            return `
                <div class="border-b py-3 ${colorBg}">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-semibold text-sm">${label}</div>
                            <div class="text-xs text-gray-500">${ts}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center ${iconBg} text-white">${icon}</div>
                        </div>
                    </div>
                    ${note}
                </div>
            `;
        }).join('');
    } catch (err) {
        console.error('Error loading alarm history', err);
        container.innerHTML = '<div class="text-center text-red-500 py-8"><p>Error loading alarm history.</p></div>';
    }
}

// Helper function to format duration
function formatDuration(seconds) {
    if (seconds < 60) {
        return `${Math.round(seconds)}s`;
    } else if (seconds < 3600) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.round(seconds % 60);
        return `${mins}m ${secs}s`;
    } else {
        const hours = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        return `${hours}h ${mins}m`;
    }
}

// Voice Control with Feedback
let recognition;

// Runtime getter for speech synthesis - prefers native Web Speech API but falls back to AndroidTTS bridge
function getSynthesis() {
    try {
        // Try AndroidTTS first (native Android) - more reliable in Android WebView
        if (window.AndroidTTS && typeof window.AndroidTTS.speak === 'function') {
            console.log('ðŸ”Š Using AndroidTTS for speech synthesis');
            return {
                speak: function(text) { 
                    try { 
                        console.log('ðŸ”Š AndroidTTS speaking:', text);
                        window.AndroidTTS.speak(text); 
                    } catch(e) { 
                        console.error('AndroidTTS.speak failed', e); 
                    } 
                },
                cancel: function() { try { window.AndroidTTS.cancel(); } catch(e) {} },
                isSpeaking: function() { 
                    try { 
                        return !!window.AndroidTTS && window.AndroidTTS.isSpeaking && window.AndroidTTS.isSpeaking() === true; 
                    } catch(e) { 
                        return false; 
                    } 
                }
            };
        }
        
        // Fallback to Web Speech API if available
        if (window.speechSynthesis && typeof window.speechSynthesis.speak === 'function') {
            console.log('ðŸ”Š Using Web Speech API for speech synthesis');
            return {
                speak: function(text) {
                    try {
                        window.speechSynthesis.cancel();
                        const u = new SpeechSynthesisUtterance(text);
                        u.rate = 0.85; // Slower for natural, clear speech
                        u.pitch = 1.0;
                        u.volume = 1.0;
                        u.lang = 'en-US';
                        console.log('ðŸ”Š Web Speech API speaking:', text);
                        window.speechSynthesis.speak(u);
                    } catch (e) { 
                        console.error('Web TTS speak failed', e); 
                    }
                },
                cancel: function() { try { window.speechSynthesis.cancel(); } catch(e){} },
                isSpeaking: function() { 
                    try { 
                        return !!window.speechSynthesis && window.speechSynthesis.speaking; 
                    } catch(e) { 
                        return false; 
                    } 
                }
            };
        }
    } catch (e) {
        console.error('getSynthesis error', e);
    }

    console.warn('âš ï¸ No TTS engine available');
    return {
        speak: function(text) { console.warn('No TTS available for:', text); },
        cancel: function() {},
        isSpeaking: function() { return false; }
    };
}

// Voice feedback function uses runtime getter
function speak(text) {
    try {
        const synth = getSynthesis();
        synth.speak(text); // getSynthesis already handles utterance creation
        console.log(`ðŸ”Š Speaking: "${text}"`);
    } catch (e) {
        console.warn('speak() failed', e);
    }
}

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    
    const floatingVoiceBtn = document.getElementById('floating-voice-btn');
    if (floatingVoiceBtn) {
        floatingVoiceBtn.addEventListener('click', () => {
            const synth = getSynthesis();
            if (synth.isSpeaking()) {
                try { synth.cancel(); } catch(e){}
            }
            recognition.start();
        });
    }

    recognition.onstart = () => {
        document.getElementById('voice-status').textContent = "ðŸŽ¤ Listening...";
        document.getElementById('voice-btn').textContent = "Listening...";
        document.getElementById('voice-btn').disabled = true;
        if (floatingVoiceBtn) floatingVoiceBtn.classList.add('listening'); // Add listening class
    };
    
    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.toLowerCase();
        const confidence = event.results[0][0].confidence;
        console.log(`ðŸŽ¤ Heard: "${transcript}" (confidence: ${(confidence * 100).toFixed(1)}%)`);
        
        document.getElementById('voice-status').textContent = `Heard: "${transcript}"`;
        
        let commandExecuted = false;
        let responseText = "";

        // Helper function to find device by name (fuzzy matching)
        const findDeviceByName = (name, type = null) => {
            if (!name) return null;
            const searchName = name.toLowerCase().trim();
            
            // Try exact match first
            let device = appliances.find(app => 
                (!type || app.type === type) && 
                app.name.toLowerCase() === searchName
            );
            
            // Try partial match
            if (!device) {
                device = appliances.find(app => 
                    (!type || app.type === type) && 
                    (app.name.toLowerCase().includes(searchName) || searchName.includes(app.name.toLowerCase()))
                );
            }
            
            return device;
        };
        
        // Helper function to extract device name from transcript
        const extractDeviceName = (transcript, action) => {
            // Remove common command words
            let devicePart = transcript.replace(action, '').trim();
            devicePart = devicePart.replace(/^(the|my|)\s*/i, '');
            devicePart = devicePart.replace(/\s+(please|now)$/i, '');
            return devicePart.trim();
        };

        // NEW LOGIC: If system is locked, only allow "stop alarm" command
        if (isSystemLocked) {
            if (transcript.includes("stop alarm") || transcript.includes("silence alarm")) {
                if (isAlarmPlaying) {
                    stopAlarm();
                    responseText = "Fire alarm stopped";
                    commandExecuted = true;
                }
                if (isFaultAlarmPlaying) {
                    stopFaultAlarm();
                    responseText = (responseText ? responseText + " and " : "") + "Fault alarm stopped";
                    commandExecuted = true;
                }
                if (!commandExecuted) { // No alarms were playing despite the command
                    responseText = "No active alarms to stop";
                    commandExecuted = true;
                }
            } else {
                responseText = "System is currently locked due to an active alarm. Only 'stop alarm' command is allowed.";
                showToast(responseText, "warning");
                speak(responseText);
                addLog(`Voice: Blocked command "${transcript}" while system locked`, 'voice-command');
                return; // Stop further processing of this command
            }
        }
        
        // Original command processing continues here for unlocked system or "stop alarm" while locked

        // All lights control
        if (transcript.includes("turn on all") || transcript.includes("all lights on") || transcript.includes("switch on all")) {
            for (let i = 1; i <= NUM_LIGHTS; i++) {
                publishMessage(`homeautomation/project/light/${i}/set`, "ON");
            }
            addLog("Voice: Turn ON all lights", 'voice-command');
            responseText = "Turning on all lights";
            speak(responseText);
            commandExecuted = true;
            
        } else if (transcript.includes("turn off all") || transcript.includes("all lights off") || transcript.includes("switch off all")) {
            for (let i = 1; i <= NUM_LIGHTS; i++) {
                publishMessage(`homeautomation/project/light/${i}/set`, "OFF");
            }
            addLog("Voice: Turn OFF all lights", 'voice-command');
            responseText = "Turning off all lights";
            speak(responseText);
            commandExecuted = true;
            
        } 
        // Individual light control - Support both numbered and named devices
        else if ((transcript.match(/turn on|switch on|enable|start|on/) && (transcript.includes("light") || transcript.includes("lamp"))) ||
                 (transcript.includes("light") && transcript.includes("on") && !transcript.includes("off"))) {
            let device = null;
            
            // Try numbered command first (e.g., "turn on light 1")
            const numMatch = transcript.match(/(?:light|lamp)\s*([1-4])/);
            if (numMatch) {
                const lightNum = parseInt(numMatch[1]);
                device = appliances.find(app => app.type === 'light' && app.deviceId === lightNum);
            }
            
            // If not found, try device name matching
            if (!device) {
                const deviceName = extractDeviceName(transcript, /turn on|switch on|enable|start|on|light|lamp/g);
                device = findDeviceByName(deviceName, 'light');
            }
            
            if (device) {
                publishMessage(`homeautomation/project/light/${device.deviceId}/set`, "ON");
                addLog(`Voice: Turn ON ${device.name}`, 'voice-command');
                responseText = `Turning on ${device.name}`;
                speak(responseText);
                commandExecuted = true;
            }
            
        } else if ((transcript.match(/turn off|switch off|disable|stop|off/) && (transcript.includes("light") || transcript.includes("lamp"))) ||
                   (transcript.includes("light") && transcript.includes("off") && !transcript.includes(" on"))) {
            let device = null;
            
            // Try numbered command first
            const numMatch = transcript.match(/(?:light|lamp)\s*([1-4])/);
            if (numMatch) {
                const lightNum = parseInt(numMatch[1]);
                device = appliances.find(app => app.type === 'light' && app.deviceId === lightNum);
            }
            
            // If not found, try device name matching
            if (!device) {
                const deviceName = extractDeviceName(transcript, /turn off|switch off|disable|stop|off|light|lamp/g);
                device = findDeviceByName(deviceName, 'light');
            }
            
            if (device) {
                publishMessage(`homeautomation/project/light/${device.deviceId}/set`, "OFF");
                addLog(`Voice: Turn OFF ${device.name}`, 'voice-command');
                responseText = `Turning off ${device.name}`;
                speak(responseText);
                commandExecuted = true;
            }
        }
        // Fan control with speed
        else if (transcript.match(/set fan.*speed|fan.*speed.*to|fan.*percent/)) {
            let device = null;
            
            // Extract fan number from transcript
            const fanMatch = transcript.match(/fan\s*([1-2])/);
            let speedMatch = transcript.match(/(\d+)\s*(?:percent|%)/);
            
            if (fanMatch) {
                const fanNum = parseInt(fanMatch[1]);
                device = appliances.find(app => app.type === 'fan' && app.deviceId === fanNum);
            } else {
                // Try to match by device name
                const deviceName = extractDeviceName(transcript, /set|speed|to|percent|%/g);
                device = findDeviceByName(deviceName, 'fan');
            }
            
            let speed = speedMatch ? parseInt(speedMatch[1]) : null;
            
            if (device && speed !== null) {
                // Clamp speed between 0-100
                speed = Math.max(0, Math.min(100, speed));
                publishMessage(`homeautomation/project/fan/${device.deviceId}/set`, speed.toString());
                addLog(`Voice: Set ${device.name} to ${speed}%`, 'voice-command');
                responseText = `Setting ${device.name} to ${speed} percent`;
                speak(responseText);
                commandExecuted = true;
            } else if (device && speed === null) {
                responseText = `Please specify the speed percentage for ${device.name}`;
                speak(responseText);
                commandExecuted = true;
            }
        }
        // Fan speed presets with device name support
        else if (transcript.match(/fan.*(low|slow)/)) {
            let device = null;
            const fanMatch = transcript.match(/fan\s*([1-2])/);
            
            if (fanMatch) {
                const fanNum = parseInt(fanMatch[1]);
                device = appliances.find(app => app.type === 'fan' && app.deviceId === fanNum);
            } else {
                const deviceName = extractDeviceName(transcript, /low|slow/g);
                device = findDeviceByName(deviceName, 'fan');
                // Fallback to first fan if no specific device found
                if (!device) device = appliances.find(app => app.type === 'fan');
            }
            
            if (device) {
                publishMessage(`homeautomation/project/fan/${device.deviceId}/set`, "25");
                addLog(`Voice: Set ${device.name} to low speed`, 'voice-command');
                responseText = `Setting ${device.name} to low speed`;
                speak(responseText);
                commandExecuted = true;
            }
            
        } else if (transcript.match(/fan.*(medium|mid)/)) {
            let device = null;
            const fanMatch = transcript.match(/fan\s*([1-2])/);
            
            if (fanMatch) {
                const fanNum = parseInt(fanMatch[1]);
                device = appliances.find(app => app.type === 'fan' && app.deviceId === fanNum);
            } else {
                const deviceName = extractDeviceName(transcript, /medium|mid/g);
                device = findDeviceByName(deviceName, 'fan');
                if (!device) device = appliances.find(app => app.type === 'fan');
            }
            
            if (device) {
                publishMessage(`homeautomation/project/fan/${device.deviceId}/set`, "50");
                addLog(`Voice: Set ${device.name} to medium speed`, 'voice-command');
                responseText = `Setting ${device.name} to medium speed`;
                speak(responseText);
                commandExecuted = true;
            }
            
        } else if (transcript.match(/fan.*(high|fast|max|full)/)) {
            let device = null;
            const fanMatch = transcript.match(/fan\s*([1-2])/);
            
            if (fanMatch) {
                const fanNum = parseInt(fanMatch[1]);
                device = appliances.find(app => app.type === 'fan' && app.deviceId === fanNum);
            } else {
                const deviceName = extractDeviceName(transcript, /high|fast|max|full/g);
                device = findDeviceByName(deviceName, 'fan');
                if (!device) device = appliances.find(app => app.type === 'fan');
            }
            
            if (device) {
                publishMessage(`homeautomation/project/fan/${device.deviceId}/set`, "100");
                addLog(`Voice: Set ${device.name} to high speed`, 'voice-command');
                responseText = `Setting ${device.name} to high speed`;
                speak(responseText);
                commandExecuted = true;
            }
        }
        // Fan on/off with device name support
        else if ((transcript.match(/turn on|switch on|start|enable|on/) && transcript.includes("fan")) ||
                 (transcript.includes("fan") && transcript.includes("on") && !transcript.includes("off"))) {
            let device = null;
            const fanMatch = transcript.match(/fan\s*([1-2])/);
            
            if (fanMatch) {
                const fanNum = parseInt(fanMatch[1]);
                device = appliances.find(app => app.type === 'fan' && app.deviceId === fanNum);
            } else {
                const deviceName = extractDeviceName(transcript, /turn on|switch on|start|enable|on|fan/g);
                device = findDeviceByName(deviceName, 'fan');
                if (!device) device = appliances.find(app => app.type === 'fan');
            }
            
            if (device) {
                publishMessage(`homeautomation/project/fan/${device.deviceId}/set`, "75");
                addLog(`Voice: Turn ON ${device.name}`, 'voice-command');
                responseText = `Turning on ${device.name}`;
                speak(responseText);
                commandExecuted = true;
            }
            
        } else if ((transcript.match(/turn off|switch off|stop|disable|off/) && transcript.includes("fan")) ||
                   (transcript.includes("fan") && transcript.includes("off") && !transcript.includes(" on"))) {
            let device = null;
            const fanMatch = transcript.match(/fan\s*([1-2])/);
            
            if (fanMatch) {
                const fanNum = parseInt(fanMatch[1]);
                device = appliances.find(app => app.type === 'fan' && app.deviceId === fanNum);
            } else {
                const deviceName = extractDeviceName(transcript, /turn off|switch off|stop|disable|off|fan/g);
                device = findDeviceByName(deviceName, 'fan');
                if (!device) device = appliances.find(app => app.type === 'fan');
            }
            
            if (device) {
                publishMessage(`homeautomation/project/fan/${device.deviceId}/set`, "0");
                addLog(`Voice: Turn OFF ${device.name}`, 'voice-command');
                responseText = `Turning off ${device.name}`;
                speak(responseText);
                commandExecuted = true;
            }
        }
        // Temperature and sensor queries
        else if (transcript.includes("what is the temperature") || transcript.includes("temperature")) {
            const tempElement = document.getElementById('sensor-temperature');
            if (tempElement && tempElement.textContent && tempElement.textContent !== '--Â°C') {
                const temp = tempElement.textContent;
                responseText = `The current temperature is ${temp}`;
                console.log(`ðŸŒ¡ï¸ Temperature: ${temp}`);
            } else {
                responseText = "Temperature data is not available yet";
                console.warn("âš ï¸ Temperature element not found or no data");
            }
            speak(responseText);
            commandExecuted = true;
            
        } else if (transcript.includes("humidity")) {
            const humElement = document.getElementById('sensor-humidity');
            if (humElement && humElement.textContent && humElement.textContent !== '--%') {
                const humidity = humElement.textContent;
                responseText = `The current humidity is ${humidity}`;
                console.log(`ðŸ’§ Humidity: ${humidity}`);
            } else {
                responseText = "Humidity data is not available yet";
                console.warn("âš ï¸ Humidity element not found or no data");
            }
            speak(responseText);
            commandExecuted = true;
        }

        // Page Navigation
        else if (transcript.includes("open") || transcript.includes("go to") || transcript.includes("show me page")) {
            let page = "";
            if (transcript.includes("control")) page = "control";
            else if (transcript.includes("monitor")) page = "monitor";
            else if (transcript.includes("analytics")) page = "analytics";
            else if (transcript.includes("logs")) page = "logs";
            else if (transcript.includes("faults")) page = "faults";
            else if (transcript.includes("menu")) page = "menu";
            else if (transcript.includes("fire alarm") || transcript.includes("fire-alarm")) page = "fire-alarm";

            if (page) {
                showPage(page);
                addLog(`Voice: Navigated to ${page} page`, 'voice-command');
                responseText = `Opening ${page} page`;
                speak(responseText);
                commandExecuted = true;
            } else {
                responseText = "Sorry, I can only open control, monitor, analytics, logs, faults, menu, or fire alarm pages.";
                commandExecuted = true;
            }
        }
        // Sensor Data Query
        else if (transcript.includes("gas") && (transcript.includes("level") || transcript.includes("what") || transcript.includes("show"))) {
            const gasElement = document.getElementById('sensor-gas');
            if (gasElement && gasElement.textContent && gasElement.textContent !== '--%') {
                const gas = gasElement.textContent;
                responseText = `The current gas level is ${gas}`;
                console.log(`ðŸ’¨ Gas: ${gas}`);
            } else {
                responseText = "Gas level data is not available yet";
                console.warn("âš ï¸ Gas element not found or no data");
            }
            speak(responseText);
            commandExecuted = true;
        }
        else if (transcript.includes("motion") && (transcript.includes("status") || transcript.includes("detect") || transcript.includes("any"))) {
            const motionElement = document.getElementById('sensor-motion');
            if (motionElement && motionElement.textContent) {
                const motionStatus = motionElement.textContent;
                responseText = `Motion status: ${motionStatus}`;
                console.log(`ðŸ‘¤ Motion: ${motionStatus}`);
            } else {
                responseText = "Motion sensor data is not available yet";
                console.warn("âš ï¸ Motion element not found or no data");
            }
            speak(responseText);
            commandExecuted = true;
        }
        else if (transcript.includes("power") && (transcript.includes("consumption") || transcript.includes("usage") || transcript.includes("using"))) {
            const powerElement = document.getElementById('pzem-power');
            if (powerElement && powerElement.textContent && powerElement.textContent !== '-- W') {
                const power = powerElement.textContent;
                responseText = `The current power consumption is ${power}`;
                console.log(`âš¡ Power: ${power}`);
            } else {
                responseText = "Power consumption data is not available yet";
                console.warn("âš ï¸ Power element not found or no data");
            }
            speak(responseText);
            commandExecuted = true;
        }
        else if (transcript.includes("voltage") || (transcript.includes("volt") && (transcript.includes("what") || transcript.includes("current")))) {
            const voltageElement = document.getElementById('pzem-voltage');
            if (voltageElement && voltageElement.textContent && voltageElement.textContent !== '-- V') {
                const voltage = voltageElement.textContent;
                responseText = `The current voltage is ${voltage}`;
                console.log(`âš¡ Voltage: ${voltage}`);
            } else {
                responseText = "Voltage data is not available yet";
                console.warn("âš ï¸ Voltage element not found or no data");
            }
            speak(responseText);
            commandExecuted = true;
        }
        else if (transcript.includes("current") && (transcript.includes("amp") || transcript.includes("draw"))) {
            const currentElement = document.getElementById('pzem-current');
            if (currentElement && currentElement.textContent && currentElement.textContent !== '-- A') {
                const current = currentElement.textContent;
                responseText = `The current draw is ${current}`;
                console.log(`âš¡ Current: ${current}`);
            } else {
                responseText = "Current data is not available yet";
                console.warn("âš ï¸ Current element not found or no data");
            }
            speak(responseText);
            commandExecuted = true;
        }
        else if (transcript.includes("energy") && (transcript.includes("total") || transcript.includes("consumed") || transcript.includes("used"))) {
            const energyElement = document.getElementById('pzem-energy');
            if (energyElement && energyElement.textContent && energyElement.textContent !== '-- kWh') {
                const energy = energyElement.textContent;
                responseText = `The total energy consumed is ${energy}`;
                console.log(`âš¡ Energy: ${energy}`);
            } else {
                responseText = "Energy data is not available yet";
                console.warn("âš ï¸ Energy element not found or no data");
            }
            speak(responseText);
            commandExecuted = true;
        }
        
        // Provide feedback only if no response was already given
        if (commandExecuted && responseText) {
            showToast(responseText, "success");
        } else if (!commandExecuted) {
            responseText = "Sorry, I didn't understand that command";
            speak(responseText);
            showToast(responseText, "error");
            addLog(`Voice: Unknown command - "${transcript}"`, 'voice-command');
        }
    };
    
    recognition.onerror = (event) => {
        console.error("Voice recognition error:", event.error);
        let errorMsg = "Voice recognition error";
        
        switch(event.error) {
            case 'no-speech':
                errorMsg = "No speech detected. Please try again.";
                break;
            case 'audio-capture':
                errorMsg = "Microphone not available. Please check permissions.";
                break;
            case 'not-allowed':
                errorMsg = "Microphone permission denied. Please enable in browser settings.";
                break;
            case 'network':
                errorMsg = "Network error. Please check your connection.";
                break;
            case 'aborted':
                errorMsg = "Voice recognition aborted.";
                break;
            default:
                errorMsg = `Voice error: ${event.error}`;
        }
        
        document.getElementById('voice-status').textContent = errorMsg;
        showToast(errorMsg, "error");
        speak(errorMsg);
        
        // Reset button
        document.getElementById('voice-btn').textContent = "Start Listening";
        document.getElementById('voice-btn').disabled = false;
        if (floatingVoiceBtn) floatingVoiceBtn.classList.remove('listening'); // Remove listening class on error
    };
    
    recognition.onend = () => {
        console.log("Voice recognition ended");
        document.getElementById('voice-btn').textContent = "Start Listening";
        document.getElementById('voice-btn').disabled = false;
        if (floatingVoiceBtn) floatingVoiceBtn.classList.remove('listening'); // Remove listening class on end
        
        setTimeout(() => {
            if (document.getElementById('voice-status').textContent.includes("Heard:")) {
                document.getElementById('voice-status').textContent = "";
            }
        }, 3000);
    };
} else {
    console.warn("Speech recognition not supported in this browser");
    document.getElementById('voice-status').textContent = "Voice control not supported in this browser";
}

function createDeviceCard(app) {
    const isLight = app.type === 'light';
    
    return `
        <div id="card-${app.id}" class="card p-6">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <h3 id="app-name-${app.id}" class="text-xl font-bold">${app.name}</h3>
                    <button id="edit-name-btn-${app.id}" onclick="toggleNameEdit(${app.id}, '${app.name}')" class="text-gray-500 hover:text-indigo-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                    </button>
                </div>
                ${isLight ? `
                <label class="toggle-switch">
                    <input type="checkbox" class="toggle-checkbox" id="light-toggle-${app.id}" data-id="${app.id}">
                    <span class="toggle-track"></span>
                    <span class="toggle-thumb"></span>
                </label>
                ` : `
                <span class="text-2xl font-bold" id="fan-speed-${app.id}">0%</span>
                `}
            </div>
            <div class="relative mb-4">
                <span id="status-badge-${app.id}" class="status-badge absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 status-offline">OFF</span>
                <span id="icon-container-${app.id}" data-type="${app.type}">${ICONS[app.type]}</span>
            </div>
            ${!isLight ? `
            <input type="range" min="0" max="100" value="0" class="slider-control w-full" id="fan-slider-${app.id}" data-id="${app.id}">
            <div class="flex gap-2 mt-4">
                <button class="btn flex-1" onclick="setFanSpeed(${app.id}, 75)">ON</button>
                <button class="btn bg-gray-600 hover:bg-gray-700 flex-1" onclick="setFanSpeed(${app.id}, 0)">OFF</button>
            </div>
            <!-- Smart Fan Speed Control -->
            <div class="mt-4 pt-4 border-t border-gray-200">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-sm font-semibold text-gray-700">Smart Speed Control</h4>
                    <label class="toggle-switch">
                        <input type="checkbox" id="smart-fan-toggle-${app.id}" class="toggle-checkbox">
                        <div class="toggle-track"></div>
                        <div class="toggle-thumb"></div>
                    </label>
                </div>
                <div id="smart-fan-controls-${app.id}" class="hidden space-y-3">
                    <div class="flex justify-around text-center text-xs">
                        <div>
                            <p class="font-semibold">Temp</p>
                            <p id="fan-temp-${app.id}">--Â°C</p>
                        </div>
                        <div>
                            <p class="font-semibold">Humidity</p>
                            <p id="fan-humidity-${app.id}">--%</p>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 italic text-center">System is learning your preferences...</p>
                </div>
            </div>
            ` : `
            <!-- Smart Lighting Section -->
            <div class="mt-4 pt-4 border-t border-gray-200">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <h4 class="text-sm font-semibold text-gray-700">Smart Lighting</h4>
                        <details class="relative">
                            <summary class="cursor-pointer text-gray-500 hover:text-indigo-600">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </summary>
                            <div class="absolute z-10 w-64 p-3 bg-white rounded-lg shadow-lg border text-xs text-gray-600 -translate-x-1/2 left-1/2 mt-2">
                                Automatically turns the light on when motion is detected at night (6 PM - 6 AM) and off otherwise.
                            </div>
                        </details>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="smart-light-toggle-${app.id}" class="toggle-checkbox">
                        <div class="toggle-track"></div>
                        <div class="toggle-thumb"></div>
                    </label>
                </div>
            </div>
            `}

            <!-- Timer Section -->
            <div class="mt-4 pt-4 border-t border-gray-200">
                <button class="accordion-toggle" data-accordion="timer-section-${app.id}">
                    <span>Manage Timers</span>
                    <svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="accordion-timer-section-${app.id}" class="accordion-content pt-3" style="max-height: 0px;">
                    <div id="timer-list-${app.id}" class="space-y-2 mb-4">
                        <!-- Timer items will be injected here -->
                    </div>
                    <div class="space-y-2">
                        <h4 class="text-sm font-semibold text-gray-700">Add New Timer</h4>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Time</label>
                            <input type="time" id="new-timer-time-${app.id}" class="w-full">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Action</label>
                            <select id="new-timer-action-${app.id}" class="w-full">
                                <option value="ON">Turn ON</option>
                                <option value="OFF">Turn OFF</option>
                            </select>
                        </div>
                        <button class="btn w-full mt-3" onclick="addTimer(${app.id})">Add Timer</button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

async function addTimer(appId) {
    if (!realtimeDb) {
        showToast("Database not ready", "error");
        return;
    }

    const { dbRef, push, serverTimestamp } = window.firebaseModules;
    const time = document.getElementById(`new-timer-time-${appId}`).value;
    const action = document.getElementById(`new-timer-action-${appId}`).value;

    if (!time) {
        showToast("Please set a time for the timer.", "error");
        return;
    }

    const appliance = appliances.find(a => a.id == appId);
    if (!appliance) {
        return;
    }

    const timerData = { 
        time, 
        action, 
        enabled: true, 
        createdAt: serverTimestamp() 
    };
    const timersRef = dbRef(realtimeDb, `timers/${appId}`);
    
    try {
        await push(timersRef, timerData);
        showToast("Timer added successfully!", "success");
        addLog(`Timer for ${appliance.name} added: ${action} at ${time}`, 'timer');
    } catch (error) {
        console.error("Error adding timer:", error);
        showToast("Failed to add timer.", "error");
    }
}

async function deleteTimer(appId, timerId) {
    if (!realtimeDb) {
        showToast("Database not ready", "error");
        return;
    }
    const { dbRef, remove } = window.firebaseModules;
    const timerRef = dbRef(realtimeDb, `timers/${appId}/${timerId}`);
    try {
        await remove(timerRef);
        showToast("Timer deleted.", "success");
    } catch (error) {
        console.error("Error deleting timer:", error);
        showToast("Failed to delete timer.", "error");
    }
}

async function updateTimerEnabled(appId, timerId, enabled) {
    if (!realtimeDb) {
        showToast("Database not ready", "error");
        return;
    }
    const { dbRef, update } = window.firebaseModules;
    const timerRef = dbRef(realtimeDb, `timers/${appId}/${timerId}`);
    try {
        await update(timerRef, { enabled });
    } catch (error) {
        console.error("Error updating timer:", error);
        showToast("Failed to update timer.", "error");
    }
}

function startTimerScheduler() {
    setInterval(checkTimers, 60000); // Check every minute
    checkTimers(); // also check now
    console.log("â° Timer scheduler started.");
}

async function updateTimerStatusDisplay() {
    if (!realtimeDb) return;
    const { dbRef, get } = window.firebaseModules;
    const timersRef = dbRef(realtimeDb, 'timers');
    try {
        const snapshot = await get(timersRef);
        const statusEl = document.getElementById('dashboard-timer-status');
        if (!statusEl) return;
        
        if (snapshot.exists()) {
            const allTimers = snapshot.val();
            let activeTimerCount = 0;
            
            for (const appId in allTimers) {
                const applianceTimers = allTimers[appId];
                if (!applianceTimers || typeof applianceTimers !== 'object') continue;
                
                for (const timerId in applianceTimers) {
                    const timerData = applianceTimers[timerId];
                    if (timerData && timerData.enabled === true) {
                        activeTimerCount++;
                    }
                }
            }
            
            console.log('ðŸ”” Active timers found:', activeTimerCount);
            
            if (activeTimerCount > 0) {
                statusEl.textContent = `${activeTimerCount} Active Timer${activeTimerCount > 1 ? 's' : ''}`;
                statusEl.className = 'text-sm font-semibold text-green-600 mt-2';
            } else {
                statusEl.textContent = 'No Timer';
                statusEl.className = 'text-sm font-semibold text-gray-700 mt-2';
            }
        } else {
            console.log('ðŸ”” No timers in Firebase');
            statusEl.textContent = 'No Timer';
            statusEl.className = 'text-sm font-semibold text-gray-700 mt-2';
        }
    } catch (error) {
        console.error("Error updating timer status:", error);
    }
}

async function checkTimers() {
    if (!realtimeDb) return;
    const { dbRef, get } = window.firebaseModules;
    const timersRef = dbRef(realtimeDb, 'timers');
    try {
        const snapshot = await get(timersRef);
        if (snapshot.exists()) {
            const allTimers = snapshot.val();
            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');

            for (const appId in allTimers) {
                const applianceTimers = allTimers[appId];
                const appliance = appliances.find(a => a.id == appId);
                if (!appliance) continue;

                for (const timerId in applianceTimers) {
                    const timerData = applianceTimers[timerId];
                    if (timerData.enabled && timerData.time === currentTime) {
                        if (appliance.type === 'light') {
                            publishMessage(`homeautomation/project/light/${appliance.deviceId}/set`, timerData.action);
                        } else if (appliance.type === 'fan') {
                            const speed = timerData.action === 'ON' ? 75 : 0;
                            setFanSpeed(appliance.id, speed);
                        }
                        addLog(`Timer ${timerData.action} for ${appliance.name}`, 'timer');
                    }
                }
            }
        }
    } catch (error) {
        console.error("Error checking timers:", error);
    }
}

function startSmartLightingScheduler() {
    setInterval(checkSmartLighting, 5000); // Check every 5 seconds
    checkSmartLighting(); // also check now
    console.log("ðŸ’¡ Smart Lighting scheduler started.");
}

function startSmartFanScheduler() {
    setInterval(checkSmartFanControl, 10000); // Check every 10 seconds
    checkSmartFanControl(); // also check now
    console.log("ðŸŒ€ Smart Fan scheduler started.");
}

function checkSmartLighting() {
    const motionStatusEl = document.getElementById('sensor-motion');
    if (!motionStatusEl) return;

    const motionDetected = motionStatusEl.textContent.includes('Motion Detected');
    const now = new Date();
    const hour = now.getHours();
    const isNight = hour < 6 || hour >= 18;

    appliances.forEach(app => {
        if (app.type === 'light') {
            // Read state from global smartLightStates object instead of DOM
            const isSmartLightingEnabled = smartLightStates[app.id]; 

            if (isSmartLightingEnabled) { // Use the state from Firebase
                const lightToggle = document.getElementById(`light-toggle-${app.id}`);
                const isLightOn = lightToggle.checked; // Still check actual light state from UI

                if (motionDetected && isNight) {
                    if (!isLightOn) {
                        publishMessage(`homeautomation/project/light/${app.deviceId}/set`, "ON");
                        addLog(`Smart Lighting: Turned ON ${app.name}`, 'smart-control');
                    }
                } else {
                    if (isLightOn) {
                        publishMessage(`homeautomation/project/light/${app.deviceId}/set`, "OFF");
                        addLog(`Smart Lighting: Turned OFF ${app.name}`, 'smart-control');
                    }
                    }
            }
        }
    });
}

function checkSmartFanControl() {
    const currentTemp = currentSensorValues.temperature;
    if (!currentTemp) return; // No temperature data yet

    appliances.forEach(app => {
        if (app.type === 'fan') {
            const isSmartFanEnabled = smartFanStates[app.id];

            if (isSmartFanEnabled) {
                let targetSpeed = 0;
                if (currentTemp >= 30) {
                    targetSpeed = 100; // High speed
                } else if (currentTemp >= 25) {
                    targetSpeed = 75;  // Medium-high speed
                } else if (currentTemp >= 22) {
                    targetSpeed = 50;  // Medium speed
                } else {
                    targetSpeed = 0;   // Off
                }

                // Get current fan speed from UI or internal state (assuming UI is leading)
                const fanSlider = document.getElementById(`fan-slider-${app.id}`);
                const currentSpeed = fanSlider ? parseInt(fanSlider.value) : 0;

                if (currentSpeed !== targetSpeed) {
                    setFanSpeed(app.id, targetSpeed);
                    addLog(`Smart Fan: Adjusted ${app.name} to ${targetSpeed}% (Temp: ${currentTemp}Â°C)`, 'smart-control');
                }
            }
        }
    });
}

async function loadTimers() {
    if (!realtimeDb) return;
    const { dbRef, onValue } = window.firebaseModules;
    
    appliances.forEach(app => {
        const timersRef = dbRef(realtimeDb, `timers/${app.id}`);
        onValue(timersRef, (snapshot) => {
            const timerListEl = document.getElementById(`timer-list-${app.id}`);
            if (!timerListEl) return;
            
            timerListEl.innerHTML = ''; // Clear the list
            
            if (snapshot.exists()) {
                const timers = snapshot.val();
                for (const timerId in timers) {
                    const timer = timers[timerId];
                    const timerEl = document.createElement('div');
                    timerEl.className = 'flex items-center justify-between bg-gray-100 p-2 rounded-lg';
                    timerEl.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="font-semibold">${timer.time}</span>
                            <span class="text-sm ${timer.action === 'ON' ? 'text-green-600' : 'text-red-600'}">${timer.action}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="toggle-switch" style="width: 42px; height: 24px;">
                                <input type="checkbox" onchange="updateTimerEnabled(${app.id}, '${timerId}', this.checked)" class="toggle-checkbox" ${timer.enabled ? 'checked' : ''}>
                                <div class="toggle-track" style="border-radius: 12px;"></div>
                                <span class="toggle-thumb" style="width: 20px; height: 20px; top: 2px; left: 2px;"></span>
                            </label>
                            <button onclick="deleteTimer(${app.id}, '${timerId}')" class="text-gray-500 hover:text-red-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    `;
                    timerListEl.appendChild(timerEl);
                }
            } else {
                timerListEl.innerHTML = '<p class="text-xs text-gray-500 text-center">No timers set for this device.</p>';
            }
        });
    });
}

async function updateSmartLightToggleState(appId, enabled) {
    if (!realtimeDb) {
        showToast("Database not ready", "error");
        return;
    }
    const { dbRef } = window.firebaseModules;
    const smartLightRef = dbRef(realtimeDb, `smartControls/lights/${appId}/enabled`);
    try {
        await window.firebaseModules.set(smartLightRef, enabled);
        const appliance = appliances.find(a => a.id == appId);
        const action = enabled ? "enabled" : "disabled";
        showToast(`Smart Lighting for ${appliance.name} ${action}!`, "success");
        addLog(`Smart Lighting for ${appliance.name} ${action}`, 'smart-control');
    } catch (error) {
        console.error("Error updating smart light state:", error);
        showToast("Failed to update smart light state.", "error");
    }
}

async function updateSmartFanToggleState(appId, enabled) {
    if (!realtimeDb) {
        showToast("Database not ready", "error");
        return;
    }
    const { dbRef } = window.firebaseModules;
    const smartFanRef = dbRef(realtimeDb, `smartControls/fans/${appId}/enabled`);
    try {
        await window.firebaseModules.set(smartFanRef, enabled);
        const appliance = appliances.find(a => a.id == appId);
        const action = enabled ? "enabled" : "disabled";
        showToast(`Smart Fan Control for ${appliance.name} ${action}!`, "success");
        addLog(`Smart Fan Control for ${appliance.name} ${action}`, 'smart-control');
    } catch (error) {
        console.error("Error updating smart fan state:", error);
        showToast("Failed to update smart fan state.", "error");
    }
}

function loadSmartLightToggleStates() {
    if (!realtimeDb) return;
    const { dbRef, onValue } = window.firebaseModules;

    appliances.forEach(app => {
        if (app.type === 'light') {
            const smartLightRef = dbRef(realtimeDb, `smartControls/lights/${app.id}/enabled`);
            onValue(smartLightRef, (snapshot) => {
                const smartToggleEl = document.getElementById(`smart-light-toggle-${app.id}`);
                
                const enabled = snapshot.val(); // Get the raw value from Firebase
                // Update global state
                smartLightStates[app.id] = (enabled !== null) ? enabled : false; // Store state in global object

                if (!smartToggleEl) return;

                if (enabled !== null) { // Check if value exists
                    smartToggleEl.checked = enabled;
                } else {
                    // If no value in DB, default to unchecked (disabled)
                    smartToggleEl.checked = false;
                }
            });
        }
    });
}

function loadSmartFanToggleStates() {
    if (!realtimeDb) return;
    const { dbRef, onValue } = window.firebaseModules;

    appliances.forEach(app => {
        if (app.type === 'fan') {
            const smartFanRef = dbRef(realtimeDb, `smartControls/fans/${app.id}/enabled`);
            onValue(smartFanRef, (snapshot) => {
                const smartToggleEl = document.getElementById(`smart-fan-toggle-${app.id}`);
                
                const enabled = snapshot.val(); // Get the raw value from Firebase
                // Update global state
                smartFanStates[app.id] = (enabled !== null) ? enabled : false; // Store state in global object

                if (!smartToggleEl) return;

                if (enabled !== null) { // Check if value exists
                    smartToggleEl.checked = enabled;
                } else {
                    // If no value in DB, default to unchecked (disabled)
                    smartToggleEl.checked = false;
                }
            });
        }
    });
}

function toggleNameEdit(appId, currentName) {
    const nameEl = document.getElementById(`app-name-${appId}`);
    const editBtn = document.getElementById(`edit-name-btn-${appId}`);
    const isEditing = editBtn.dataset.editing === 'true';

    if (isEditing) {
        // Save the name
        const inputEl = document.getElementById(`edit-name-input-${appId}`);
        const newName = inputEl.value.trim();
        
        // Validate name
        if (!newName) {
            showToast("Name cannot be empty", "error");
            return;
        }

        // Update UI
        nameEl.textContent = newName;
        editBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>`;
        editBtn.dataset.editing = 'false';

        // Save to appliances array and Firebase
        updateApplianceName(appId, newName);
    } else {
        // Get the current name dynamically from the appliances array instead of parameter
        const appliance = appliances.find(a => a.id == appId);
        const actualCurrentName = appliance ? appliance.name : currentName;
        
        // Enter edit mode
        nameEl.innerHTML = `<input type="text" id="edit-name-input-${appId}" value="${actualCurrentName}" class="text-xl font-bold bg-transparent border-b-2 border-indigo-500" maxlength="30">`;
        editBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`; // Checkmark icon
        editBtn.dataset.editing = 'true';
        document.getElementById(`edit-name-input-${appId}`).focus();
    }
}

async function updateApplianceName(appId, newName) {
    // Update in-memory appliances array
    const appliance = appliances.find(a => a.id == appId);
    if (appliance) {
        const oldName = appliance.name;
        appliance.name = newName;
        addLog(`Appliance name updated from "${oldName}" to "${newName}"`, 'system');
        showToast("Appliance name updated!", "success");

        // Update in Firebase for persistence
        if (realtimeDb) {
            try {
                const { dbRef, update, get } = window.firebaseModules;
                const applianceRef = dbRef(realtimeDb, `appliances/${appId}`);
                await update(applianceRef, { name: newName });
                
                // Verify the update was successful
                const snapshot = await get(applianceRef);
                if (snapshot.exists()) {
                    console.log(`âœ… Verified Firebase update for appliance ${appId}:`, snapshot.val());
                }
                
                addLog(`Appliance name synced to Firebase`, 'system');
                
                // Update the name in the UI directly without recreating cards
                const nameElement = document.getElementById(`app-name-${appId}`);
                if (nameElement) {
                    nameElement.textContent = newName;
                }
            } catch (error) {
                console.error("Error updating appliance name in Firebase:", error);
                showToast("Failed to sync name change.", "error");
            }
        }
    }
}

function setFanSpeed(fanId, speed) {
    if (!isEspOnline) {
        showToast("ESP is offline. Cannot control appliances.", "error");
        // Optionally, revert the UI state for the fan slider here if needed
        return;
    }
    // Find the fan device to get its deviceId
    const fan = appliances.find(app => app.id === fanId && app.type === 'fan');
    if (!fan) {
        console.error(`âŒ Fan with id ${fanId} not found`);
        return;
    }

    const deviceId = fan.deviceId;
    console.log(`ðŸŒ€ Setting fan ${fanId} (device ${deviceId}) to speed: ${speed}`);
    
    const topic = `homeautomation/project/fan/${deviceId}/set`;
    console.log(`ðŸ“¤ Publishing to topic: ${topic}, payload: ${speed}`);
    publishMessage(topic, speed.toString());
    addLog(`Set ${fan.name} to ${speed}%`, 'device-control');

    // Update UI toast to notify user
    if (speed > 0) {
        showToast(`${fan.name} set to ${speed}%`, 'success');
    } else {
        showToast(`${fan.name} turned OFF`, 'info');
    }
}

async function renderDevices() {
    const container = document.getElementById('light-card-container');
    container.innerHTML = appliances.map(createDeviceCard).join('');

    // Load saved states from Firebase and sync ESP to match
    const loadedStates = { lights: {}, fans: {} };
    
    if (realtimeDb) {
        try {
            const { dbRef, get } = window.firebaseModules;
            
            // Load light states
            for (const app of appliances.filter(a => a.type === 'light')) {
                const stateRef = dbRef(realtimeDb, `deviceStates/light/${app.deviceId}`);
                const snapshot = await get(stateRef);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    updateLightUI(app.deviceId, data.status);
                    loadedStates.lights[app.deviceId] = data.status;
                    console.log(`ðŸ“‚ Loaded saved state for Light ${app.deviceId}: ${data.status}`);
                }
            }
            
            // Load fan states
            for (const app of appliances.filter(a => a.type === 'fan')) {
                const stateRef = dbRef(realtimeDb, `deviceStates/fan/${app.deviceId}`);
                const snapshot = await get(stateRef);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    updateFanUI(app.deviceId, data.speed);
                    loadedStates.fans[app.deviceId] = data.speed;
                    console.log(`ðŸ“‚ Loaded saved state for Fan ${app.deviceId}: ${data.speed}%`);
                }
            }
            
            // Schedule ESP sync after MQTT connects
            window.pendingESPSync = loadedStates;
        } catch (error) {
            console.error('Error loading device states from Firebase:', error);
        }
    }

    // Add event listeners
    appliances.forEach(app => {
        if (app.type === 'light') {
            const toggle = document.getElementById(`light-toggle-${app.id}`);
            toggle.addEventListener('change', (e) => {
                if (!isEspOnline) {
                    showToast("ESP is offline. Cannot control appliances.", "error");
                    e.target.checked = !e.target.checked; // Revert the toggle state
                    return;
                }
                const state = e.target.checked ? "ON" : "OFF";
                
                // Send command to ESP immediately
                publishMessage(`homeautomation/project/light/${app.deviceId}/set`, state);
                addLog(`${app.name} turned ${state}`, 'device-control');
                
                // MQTT will update UI via status message - no manual UI update to avoid conflicts
            });

            // Add event listener for smart lighting toggle
            const smartLightToggle = document.getElementById(`smart-light-toggle-${app.id}`);
            if (smartLightToggle) {
                smartLightToggle.addEventListener('change', (e) => {
                    updateSmartLightToggleState(app.id, e.target.checked);
                });
            }
        } else if (app.type === 'fan') {
            const slider = document.getElementById(`fan-slider-${app.id}`);
            if (!slider) {
                console.error(`âŒ Slider not found for fan ${app.id}`);
                return;
            }
            console.log(`âœ… Fan ${app.id} slider found, attaching listeners`);

            slider.addEventListener('input', (e) => {
                const speed = e.target.value;
                console.log(`ðŸŽšï¸ Slider input - Fan ${app.id}: ${speed}%`);
                document.getElementById(`fan-speed-${app.id}`).textContent = `${speed}%`;
            });

            slider.addEventListener('change', (e) => {
                const speed = e.target.value;
                console.log(`ðŸŽšï¸ Slider change - Fan ${app.id}: ${speed}%`);
                setFanSpeed(app.id, parseInt(speed));
            });

            // Smart fan controls
            const smartFanToggle = document.getElementById(`smart-fan-toggle-${app.id}`);
            const smartFanControls = document.getElementById(`smart-fan-controls-${app.id}`);
            if (smartFanToggle) {
                // Set initial state from global smartFanStates
                smartFanToggle.checked = smartFanStates[app.id] || false;

                if (smartFanToggle.checked) {
                    smartFanControls.classList.remove('hidden');
                } else {
                    smartFanControls.classList.add('hidden');
                }
                
                smartFanToggle.addEventListener('change', (e) => {
                    updateSmartFanToggleState(app.id, e.target.checked); // Update Firebase
                    if (e.target.checked) {
                        smartFanControls.classList.remove('hidden');
                    } else {
                        smartFanControls.classList.add('hidden');
                    }
                });
            }
        }
    });

    // Attach accordion toggle listeners for any dynamically created accordions inside device cards
    // This fixes the Manage Timers section not opening because the static DOMContentLoaded handler ran earlier
    const dynamicToggles = container.querySelectorAll('.accordion-toggle');
    dynamicToggles.forEach(toggle => {
        if (toggle.dataset.bound === 'true') return; // already bound
        toggle.dataset.bound = 'true';

        toggle.addEventListener('click', () => {
            const content = document.getElementById(`accordion-${toggle.dataset.accordion}`);
            if (!content) return;
            const isOpen = content.style.maxHeight && content.style.maxHeight !== '0px';

            // Close all other accordion contents (keep original behavior)
            document.querySelectorAll('.accordion-content').forEach(c => c.style.maxHeight = '0px');
            document.querySelectorAll('.accordion-toggle svg').forEach(s => s.classList.remove('rotate-180'));

            if (!isOpen) {
                content.style.maxHeight = content.scrollHeight + 'px';
                const svg = toggle.querySelector('svg');
                if (svg) svg.classList.add('rotate-180');
            } else {
                const svg = toggle.querySelector('svg');
                if (svg) svg.classList.remove('rotate-180');
                content.style.maxHeight = '0px';
            }
        });
    });
}

function listenToUserProfile(userId) {
    if (!realtimeDb) return;
    const { dbRef, onValue, get, set } = window.firebaseModules;
    const userRef = dbRef(realtimeDb, `users/${userId}`);

    onValue(userRef, async (snapshot) => {
        if (snapshot.exists()) {
            const userData = snapshot.val();
            updateProfileUI(userData);
        } else {
            // User profile doesn't exist in RTDB, create it from Auth data
            const authUser = auth.currentUser;
            if (authUser) {
                const newUserProfile = {
                    displayName: authUser.displayName || "New User",
                    email: authUser.email,
                    photoURL: authUser.photoURL || `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect fill='%236366f1' width='100' height='100'/%3E%3Ctext x='50%25' y='50%25' font-size='40' fill='%23fff' text-anchor='middle' dy='.3em'%3E${(authUser.displayName || 'U').charAt(0).toUpperCase()}%3C/text%3E%3C/svg%3E`
                };
                await set(userRef, newUserProfile);
                // onValue will be triggered again automatically by the set,
                // so no need to call updateProfileUI here.
            }
        }
    });
}

function updateProfileUI(userData) {
    if (!userData) return;

    const placeholderSvg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect fill='%236366f1' width='100' height='100'/%3E%3Ctext x='50%25' y='50%25' font-size='40' fill='%23fff' text-anchor='middle' dy='.3em'%3E${(userData.displayName || 'U').charAt(0).toUpperCase()}%3C/text%3E%3C/svg%3E`;

    // Update display name
    const displayNameEl = document.getElementById('profile-display-name');
    if (displayNameEl) displayNameEl.textContent = userData.displayName;

    // Update email
    const emailEl = document.getElementById('profile-email');
    if (emailEl) emailEl.textContent = userData.email;

    // Update photo
    const photoEl = document.getElementById('profile-photo');
    if (photoEl) {
        photoEl.src = userData.photoURL || placeholderSvg;
    }
    
    // Also update the greeting text in the drawer/menu
    const greetingEl = document.getElementById('greeting-text-drawer');
    if (greetingEl) greetingEl.textContent = `Welcome, ${userData.displayName}!`;
}

// Function to update visibility of the floating voice button
function updateFloatingVoiceButtonVisibility() {
    const mainApp = document.getElementById('main-app');
    const authContainer = document.getElementById('auth-container');
    const floatingVoiceBtn = document.getElementById('floating-voice-btn');

    if (!mainApp || !authContainer || !floatingVoiceBtn) return;

    // Show button only if main-app is visible and auth-container is hidden (user logged in)
    if (!mainApp.classList.contains('hidden') && authContainer.classList.contains('hidden')) {
        floatingVoiceBtn.classList.remove('hidden');
    } else {
        floatingVoiceBtn.classList.add('hidden');
    }
}

async function saveProfile(newName, photoFile) {
    const { getStorage, ref, uploadBytes, getDownloadURL } = window.firebaseModules;
    const { updateProfile } = window.firebaseModules;
    const { dbRef, update } = window.firebaseModules;

    const user = auth.currentUser;
    if (!user) return;

    let photoDownloadURL = null;
    const progressBarContainer = document.getElementById('upload-progress-bar');
    const progressBar = document.getElementById('upload-progress');

    try {
        // Step 1: Upload photo if it exists
        if (photoFile) {
            progressBarContainer.classList.remove('hidden');
            progressBar.style.width = '20%'; // Initial progress

            const storageRef = ref(getStorage(), `profile-photos/${user.uid}`);
            
            await uploadBytes(storageRef, photoFile);
            progressBar.style.width = '70%';

            photoDownloadURL = await getDownloadURL(storageRef);
            progressBar.style.width = '100%';
        }

        // Step 2: Prepare data for updates
        const updates = {};
        const authUpdates = {};

        if (newName && newName !== user.displayName) {
            updates.displayName = newName;
            authUpdates.displayName = newName;
        }

        if (photoDownloadURL) {
            updates.photoURL = photoDownloadURL;
            authUpdates.photoURL = photoDownloadURL;
        }

        // Step 3: Perform updates if there's anything to update
        if (Object.keys(updates).length > 0) {
            // Update Firebase Auth
            await updateProfile(user, authUpdates);
            
            // Update Realtime Database (this will trigger UI updates on all clients)
            const userRef = dbRef(realtimeDb, `users/${user.uid}`);
            await update(userRef, updates);
            
            showToast("Profile updated successfully!", "success");
            addLog("User profile updated.", "auth");
        } else {
            showToast("No changes to save.", "info");
        }

    } catch (error) {
        console.error("Error updating profile:", error);
        showToast("Failed to update profile. " + error.message, "error");
        addLog(`Profile update failed: ${error.message}`, "error");
    } finally {
        // Hide progress bar
        setTimeout(() => {
            progressBarContainer.classList.add('hidden');
            progressBar.style.width = '0%';
        }, 1000);
    }
}


// Initialize Charts
let pieChart, barChart, lightsTimelineChart, fansTimelineChart, fireAlarmHistoryChart;
let currentDeviceTimeRange = 6; // Default 6 hours

// Real-time listeners for analytics
let pzemDataListener = null;
let deviceUsageListener = null;
let sensorDataListener = null;
let isAnalyticsPageActive = false;

// Professional color palette for charts
const chartColors = {
    // Vibrant, distinguishable colors for devices
    primary: [
        '#FF6384',  // Pink-Red
        '#36A2EB',  // Blue
        '#FFCE56',  // Yellow
        '#4BC0C0',  // Teal
        '#9966FF',  // Purple
        '#FF9F40',  // Orange
        '#FF6384',  // Pink
        '#C9CBCF'   // Grey
    ],
    // Gradient colors for bars
    gradient: [
        'rgba(255, 99, 132, 0.8)',   // Red gradient
        'rgba(54, 162, 235, 0.8)',   // Blue gradient
        'rgba(255, 206, 86, 0.8)',   // Yellow gradient
        'rgba(75, 192, 192, 0.8)',   // Teal gradient
        'rgba(153, 102, 255, 0.8)',  // Purple gradient
        'rgba(255, 159, 64, 0.8)',   // Orange gradient
        'rgba(231, 76, 60, 0.8)',    // Red gradient
        'rgba(46, 204, 113, 0.8)'    // Green gradient
    ],
    // Border colors (darker versions)
    borders: [
        '#FF6384',
        '#36A2EB',
        '#FFCE56',
        '#4BC0C0',
        '#9966FF',
        '#FF9F40',
        '#E74C3C',
        '#2ECC71'
    ]
};

function initCharts() {
    const deviceNames = appliances.map(a => a.name);
    
    // Enhanced Pie Chart with better colors and labels
    const pieCanvas = document.getElementById('pieChart');
    if (!pieCanvas) {
        console.warn('pieChart canvas not found');
        return;
    }
    
    // Destroy existing chart if it exists
    if (pieChart) {
        pieChart.destroy();
        pieChart = null;
    }
    
    const pieCtx = pieCanvas.getContext('2d');
    pieChart = new Chart(pieCtx, {
        type: 'doughnut',  // Changed to doughnut for modern look
        data: {
            labels: deviceNames,
            datasets: [{
                data: new Array(appliances.length).fill(0),
                backgroundColor: chartColors.primary.slice(0, appliances.length),
                borderColor: '#ffffff',
                borderWidth: 3,
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12,
                            weight: '600'
                        },
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${label}: ${value} times (${percentage}%)`;
                        }
                    },
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    cornerRadius: 8
                }
            }
        }
    });
    
    // Enhanced Bar Chart with gradient colors
    const barCtx = document.getElementById('barChart').getContext('2d');
    barChart = new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: deviceNames,
            datasets: [{
                label: 'Switch Count',
                data: new Array(appliances.length).fill(0),
                backgroundColor: chartColors.gradient.slice(0, appliances.length),
                borderColor: chartColors.borders.slice(0, appliances.length),
                borderWidth: 2,
                borderRadius: 6,
                barThickness: 50
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: { 
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        font: { size: 12, weight: '600' },
                        stepSize: 1
                    },
                    title: {
                        display: true,
                        text: 'Number of Switches',
                        font: { size: 13, weight: 'bold' }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 12, weight: '600' }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            return `Switched: ${context.parsed.y} times`;
                        }
                    }
                }
            }
        }
    });
    
    // Enhanced Lights Timeline Chart
    const lightsCtx = document.getElementById('lightsTimelineChart').getContext('2d');
    lightsTimelineChart = new Chart(lightsCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'hour',
                        displayFormats: {
                            hour: 'HH:mm',
                            minute: 'HH:mm'
                        },
                        tooltipFormat: 'MMM dd, HH:mm:ss'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        font: { size: 11, weight: '600' }
                    },
                    title: {
                        display: true,
                        text: 'Time',
                        font: { size: 12, weight: 'bold' }
                    }
                },
                y: { 
                    beginAtZero: true,
                    max: 1,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return value === 1 ? 'ON' : 'OFF';
                        },
                        font: { size: 12, weight: '600' }
                    },
                    title: {
                        display: true,
                        text: 'Light Status',
                        font: { size: 12, weight: 'bold' }
                    }
                }
            },
            plugins: {
                legend: { 
                    position: 'top',
                    labels: {
                        padding: 10,
                        font: { size: 12, weight: '600' },
                        usePointStyle: true,
                        pointStyle: 'rectRounded'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    cornerRadius: 8,
                    titleFont: { size: 13, weight: 'bold' },
                    bodyFont: { size: 12 },
                    callbacks: {
                        label: function(context) {
                            const status = context.parsed.y === 1 ? 'ON' : 'OFF';
                            return `${context.dataset.label}: ${status}`;
                        }
                    }
                }
            }
        }
    });
    
    // Enhanced Fans Timeline Chart
    const fansCtx = document.getElementById('fansTimelineChart').getContext('2d');
    fansTimelineChart = new Chart(fansCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'hour',
                        displayFormats: {
                            hour: 'HH:mm',
                            minute: 'HH:mm'
                        },
                        tooltipFormat: 'MMM dd, HH:mm:ss'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        font: { size: 11, weight: '600' }
                    },
                    title: {
                        display: true,
                        text: 'Time',
                        font: { size: 12, weight: 'bold' }
                    }
                },
                y: { 
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        stepSize: 25,
                        callback: function(value) {
                            return value + '%';
                        },
                        font: { size: 12, weight: '600' }
                    },
                    title: {
                        display: true,
                        text: 'Fan Speed',
                        font: { size: 12, weight: 'bold' }
                    }
                }
            },
            plugins: {
                legend: { 
                    position: 'top',
                    labels: {
                        padding: 10,
                        font: { size: 12, weight: '600' },
                        usePointStyle: true,
                        pointStyle: 'rectRounded'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    cornerRadius: 8,
                    titleFont: { size: 13, weight: 'bold' },
                    bodyFont: { size: 12 },
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y}%`;
                        }
                    }
                }
            }
        }
    });
    
    // Heatmap
    const heatmap = document.getElementById('heatmap');
    if (heatmap) {
        for (let i = 0; i < 24; i++) {
            const cell = document.createElement('div');
            cell.className = 'h-8 bg-gray-200 rounded';
            cell.title = `${i}:00`;
            heatmap.appendChild(cell);
        }
    } else {
        console.warn('Heatmap element not found');
    }
}



// ========== SENSOR FUNCTIONS ==========

// Initialize Firebase Realtime Database listeners for sensors
function startSensorListeners() {
    if (!realtimeDb) {
        console.warn("âš ï¸ Realtime Database not initialized");
        return;
    }
    
    const { dbRef, onValue } = window.firebaseModules;
    
    console.log("ðŸ“¡ Starting sensor listeners...");
    
    // Listen for current sensor data
    const sensorsRef = dbRef(realtimeDb, 'sensors/current');
    onValue(sensorsRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            console.log("ðŸ“Š Sensor data received:", data);
            // Only update UI if ESP is online OR if data is very fresh (< 30s)
            const dataAge = Date.now() - (data.timestamp || 0);
            if (isEspOnline || dataAge < 30000) {
                updateSensorUI(data);
            } else {
                console.log(`âš ï¸ Ignoring stale sensor data (age: ${(dataAge/1000).toFixed(0)}s, ESP offline)`);
                showSensorOfflineOverlay();
            }
        }
    });
    
    // Listen for gas alarm
    const gasAlarmRef = dbRef(realtimeDb, 'alarms/gas');
    onValue(gasAlarmRef, (snapshot) => {
        const data = snapshot.val();
        if (data && data.active === true) {
            showGasAlarm(data);
        } else {
            hideGasAlarm();
        }
    });
    
    // Listen for fire alarm (sync across all devices)
    const fireAlarmRef = dbRef(realtimeDb, 'alarms/fire/current');
    onValue(fireAlarmRef, (snapshot) => {
        const data = snapshot.val();
        if (data && data.active === true) {
            // Validate timestamp to prevent stale alarms from triggering
            const alarmAge = data.timestamp ? (Date.now() - data.timestamp) : Infinity;
            const MAX_ALARM_AGE = 5 * 60 * 1000; // 5 minutes
            
            if (alarmAge > MAX_ALARM_AGE) {
                console.log("âš ï¸ Ignoring stale fire alarm from Firebase (age: " + Math.floor(alarmAge/1000) + "s)");
                // Clear stale alarm from database
                const { set } = window.firebaseModules;
                set(fireAlarmRef, { active: false, timestamp: Date.now(), cleared: 'stale' });
                return;
            }
            
            console.log("ðŸ”¥ Fire alarm detected from Firebase (age: " + Math.floor(alarmAge/1000) + "s)");
            // Only start alarm if not already playing (prevent loop)
            if (!isAlarmPlaying) {
                startAlarm(true); // Pass true to skip Firebase update
            }
        } else if (data && data.active === false) {
            // Only stop alarm if currently playing (prevent loop)
            if (isAlarmPlaying) {
                console.log("âœ… Fire alarm cleared from Firebase");
                stopAlarm(true); // Pass true to skip Firebase update
            }
        }
    });

    // Listen for FAULT alarm (sync across all devices)
    const faultAlarmRef = dbRef(realtimeDb, 'alarms/fault/current');
    onValue(faultAlarmRef, (snapshot) => {
        const data = snapshot.val();
        if (data && data.active === true) {
            const reason = data.reason || 'Unknown Fault';
            console.log(`âš¡ Fault alarm detected from Firebase: ${reason}`);

            // --- Update All UIs from this single source of truth ---

            // 1. Update prominent banner with reason
            const banner = document.getElementById('fault-alarm-banner');
            const bannerContent = document.getElementById('fault-banner-content');
            if (banner && bannerContent) {
                bannerContent.innerHTML = `âš¡ ${reason.toUpperCase()}! âš¡`;
            }

            // 2. Show on-page "EMERGENCY SHUTDOWN" banner and update its reason
            const emergencyBanner = document.getElementById('emergency-shutdown-banner');
            if (emergencyBanner) {
                document.getElementById('emergency-reason').textContent = `Reason: ${reason}`;
                emergencyBanner.classList.remove('hidden');
            }

            // 3. Update the on-page system status display
            const statusDiv = document.getElementById('fault-system-status');
            if (statusDiv) {
                statusDiv.className = 'bg-red-100 border-l-4 border-red-500 text-red-700 p-4';
                statusDiv.innerHTML = `<p class="font-bold">EMERGENCY SHUTDOWN</p><p>${reason}</p>`;
            }

            // 4. Start the alarm sound and lock the system (if not already active)
            if (!isFaultAlarmPlaying) {
                startFaultAlarm(reason, true); // true = skip writing back to firebase
            }
        } else {
            // Fault is not active, reset all UIs
            if (isFaultAlarmPlaying) {
                stopFaultAlarm(true); // true = skip writing back to firebase
            }
        }
    });
    
    // Listen for PZEM power monitor data
    const pzemRef = dbRef(realtimeDb, 'powerMonitor/current');
    onValue(pzemRef, (snapshot) => {
        const data = snapshot.val();
        
        if (!data) {
            // No data in Firebase - show "No Load" state
            console.log("âš¡ No PZEM data in Firebase");
            updatePZEMUI({
                voltage: 0,
                current: 0,
                power: 0,
                energy: 0,
                frequency: 0,
                powerFactor: 0,
                lastUpdate: '--'
            });
            return;
        }
        
        console.log("âš¡ PZEM data received:", data);
        
        // Check if data is fresh (within last 30 seconds)
        const now = Date.now();
        const dataAge = now - (data.timestamp || 0);
        const isDataFresh = dataAge < 30000; // 30 seconds
        
        // Only show data if ESP is online OR data is very fresh
        if (!isEspOnline && !isDataFresh) {
            console.log(`âš ï¸ Ignoring stale PZEM data (age: ${(dataAge/1000).toFixed(0)}s, ESP offline)`);
            showPZEMOfflineOverlay();
            return;
        }
        
        // Show real values if data is fresh AND current is flowing
        if (isDataFresh && data.current > 0.01) {
            updatePZEMUI(data);
        } else {
            // Show "No Load" state (old data or no current)
            console.log(`âšª PZEM: No Load (current: ${data.current}, age: ${(dataAge/1000).toFixed(0)}s)`);
            updatePZEMUI({
                voltage: 0,
                current: 0,
                power: 0,
                energy: data.energy || 0, // Keep energy value
                frequency: 0,
                powerFactor: 0,
                lastUpdate: data.lastUpdate || '--'
            });
        }
    });
}

// Update sensor UI with real-time data (internal function)
function _updateSensorUIInternal(data) {
    // Validate and update global currentSensorValues
    currentSensorValues.temperature = (data.temperature !== undefined && data.temperature !== null) ? data.temperature : currentSensorValues.temperature;
    currentSensorValues.humidity = (data.humidity !== undefined && data.humidity !== null) ? data.humidity : currentSensorValues.humidity;
    currentSensorValues.gasLevel = (data.gasLevel !== undefined && data.gasLevel !== null) ? data.gasLevel : currentSensorValues.gasLevel;
    currentSensorValues.motion = (data.motion !== undefined && data.motion !== null) ? data.motion : currentSensorValues.motion;

    // Temperature - validate before displaying
    if (data.temperature !== undefined && data.temperature !== null && !isNaN(data.temperature)) {
        const tempValue = parseFloat(data.temperature);
        document.getElementById('sensor-temperature').textContent = tempValue.toFixed(1) + 'Â°C';
        updateSensorTrend('temp', tempValue);
    }
    
    // Humidity - validate before displaying
    if (data.humidity !== undefined && data.humidity !== null && !isNaN(data.humidity)) {
        const humValue = parseFloat(data.humidity);
        document.getElementById('sensor-humidity').textContent = humValue.toFixed(1) + '%';
        updateSensorTrend('humidity', humValue);
    }
    
    // Gas Level (ESP sends raw 0-1024)
    if (data.gasLevel !== undefined) {
        const gasPercent = (data.gasLevel / 1024 * 100).toFixed(1);
        document.getElementById('sensor-gas').textContent = gasPercent + '%';
        document.getElementById('gas-raw').textContent = `(${data.gasLevel}/1024)`;
        
        // Change card color based on level
        const gasCard = document.getElementById('gas-level-card');
        if (data.gasAlarm === true) {
            gasCard.classList.add('gas-alarm-active');
        } else {
            gasCard.classList.remove('gas-alarm-active');
        }
    }
    
    // Motion
    if (data.motion !== undefined) {
        const motionIcon = document.getElementById('motion-icon');
        const motionStatus = document.getElementById('sensor-motion');
        
        if (data.motion === true || data.motion === 1) {
            motionIcon.textContent = 'ðŸš¶';
            motionIcon.classList.add('motion-pulse');
            motionStatus.textContent = 'Motion Detected!';
            motionStatus.style.color = '#ef4444';
        } else {
            motionIcon.textContent = 'ðŸ‘¤';
            motionIcon.classList.remove('motion-pulse');
            motionStatus.textContent = 'No Motion';
            motionStatus.style.color = '#10b981';
        }
    }
    
    // Update timestamps
    const updateTime = data.lastUpdate || new Date().toLocaleTimeString();
    document.getElementById('temp-update').textContent = 'Last update: ' + updateTime;
    document.getElementById('humidity-update').textContent = 'Last update: ' + updateTime;
    document.getElementById('gas-update').textContent = 'Last update: ' + updateTime;
    document.getElementById('motion-update').textContent = 'Last update: ' + updateTime;
}

// Throttled version to prevent excessive DOM updates (max once per 100ms for responsiveness)
const updateSensorUI = throttle(_updateSensorUIInternal, 100);

// Show "ESP Offline" overlay on sensor grid
function showSensorOfflineOverlay() {
    let overlay = document.getElementById('sensor-offline-overlay');
    if (!overlay) {
        // Create overlay if it doesn't exist
        const sensorGrid = document.getElementById('sensor-grid');
        if (!sensorGrid) return;
        
        overlay = document.createElement('div');
        overlay.id = 'sensor-offline-overlay';
        overlay.className = 'absolute inset-0 bg-gray-900 bg-opacity-75 rounded-2xl flex flex-col items-center justify-center z-10';
        overlay.innerHTML = `
            <div class="text-center p-6">
                <div class="text-6xl mb-4">ðŸ“¡</div>
                <h3 class="text-2xl font-bold text-white mb-2">ESP Offline</h3>
                <p class="text-gray-300">Sensor data unavailable</p>
                <p class="text-sm text-gray-400 mt-2">Waiting for ESP connection...</p>
            </div>
        `;
        
        // Make sensor grid container relative for absolute positioning
        sensorGrid.style.position = 'relative';
        sensorGrid.appendChild(overlay);
    }
    overlay.style.display = 'flex';
}

// Hide sensor offline overlay
function hideSensorOfflineOverlay() {
    const overlay = document.getElementById('sensor-offline-overlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

// Show "ESP Offline" overlay on PZEM monitor
function showPZEMOfflineOverlay() {
    let overlay = document.getElementById('pzem-offline-overlay');
    if (!overlay) {
        // Create overlay if it doesn't exist
        const pzemGrid = document.getElementById('power-monitor-grid');
        if (!pzemGrid) return;
        
        overlay = document.createElement('div');
        overlay.id = 'pzem-offline-overlay';
        overlay.className = 'absolute inset-0 bg-gray-900 bg-opacity-75 rounded-2xl flex flex-col items-center justify-center z-10';
        overlay.innerHTML = `
            <div class="text-center p-6">
                <div class="text-6xl mb-4">âš¡</div>
                <h3 class="text-2xl font-bold text-white mb-2">ESP Offline</h3>
                <p class="text-gray-300">Power monitor data unavailable</p>
                <p class="text-sm text-gray-400 mt-2">Waiting for ESP connection...</p>
            </div>
        `;
        
        // Make PZEM container relative for absolute positioning
        pzemGrid.parentElement.style.position = 'relative';
        pzemGrid.parentElement.appendChild(overlay);
    }
    overlay.style.display = 'flex';
}

// Hide PZEM offline overlay
function hidePZEMOfflineOverlay() {
    const overlay = document.getElementById('pzem-offline-overlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

// Update PZEM power monitor UI with real-time data (internal function)
function _updatePZEMUIInternal(data) {
    console.log('ðŸ“Š _updatePZEMUIInternal called with:', data);
    
    // Check if ESP is online - only show real data when ESP is connected
    if (!isEspOnline) {
        console.log('âš ï¸ ESP offline, showing overlay');
        // Show "ESP Offline" overlay on PZEM monitor
        showPZEMOfflineOverlay();
        return;
    }
    
    // ESP is online - hide offline overlay and show real data
    hidePZEMOfflineOverlay();
    
    // Check if current is flowing (real-time load)
    const isLoadConnected = data.current !== undefined && data.current > 0.01;
    console.log('ðŸ”Œ Load connected:', isLoadConnected, '| Current:', data.current);
    
    // Update status indicator based on current flow (with null checks)
    const statusDot = document.getElementById('pzem-status');
    const statusText = document.getElementById('pzem-status-text');
    
    if (statusDot && statusText) {
        if (isLoadConnected) {
            statusDot.className = 'w-3 h-3 rounded-full bg-green-500';
            statusText.textContent = 'Active';
            statusText.className = 'text-sm text-green-600 font-semibold';
        } else {
            statusDot.className = 'w-3 h-3 rounded-full bg-gray-400';
            statusText.textContent = 'No Load';
            statusText.className = 'text-sm text-gray-600 font-semibold';
        }
    }
    
    // Voltage - ALWAYS show if available (changed from load-dependent)
    const voltageEl = document.getElementById('pzem-voltage');
    if (voltageEl) {
        if (data.voltage !== undefined && data.voltage > 0) {
            voltageEl.textContent = data.voltage.toFixed(1) + ' V';
            console.log('âœ… Voltage updated:', voltageEl.textContent);
        } else {
            voltageEl.textContent = '-- V';
            console.log('âš ï¸ No voltage data');
        }
    } else {
        console.error('âŒ pzem-voltage element NOT FOUND!');
    }
    
    // Current - Show real-time value or zero
    const currentEl = document.getElementById('pzem-current');
    if (currentEl) {
        if (data.current !== undefined) {
            currentEl.textContent = data.current.toFixed(2) + ' A';
            console.log('âœ… Current updated:', currentEl.textContent);
        } else {
            currentEl.textContent = '0.00 A';
        }
    } else {
        console.error('âŒ pzem-current element NOT FOUND!');
    }
    
    // Power - Show value even if zero
    const powerEl = document.getElementById('pzem-power');
    if (powerEl) {
        if (data.power !== undefined) {
            powerEl.textContent = Math.round(data.power) + ' W';
            console.log('âœ… Power updated:', powerEl.textContent);
        } else {
            powerEl.textContent = '0 W';
        }
    } else {
        console.error('âŒ pzem-power element NOT FOUND!');
    }
    
    // Energy - ALWAYS show (accumulated consumption)
    const energyEl = document.getElementById('pzem-energy');
    if (energyEl && data.energy !== undefined) {
        energyEl.textContent = data.energy.toFixed(2) + ' kWh';
        console.log('âœ… Energy updated:', energyEl.textContent);
    } else if (!energyEl) {
        console.error('âŒ pzem-energy element NOT FOUND!');
    }
    
    // Frequency - ALWAYS show if available
    const freqEl = document.getElementById('pzem-frequency');
    if (freqEl) {
        if (data.frequency !== undefined && data.frequency > 0) {
            freqEl.textContent = data.frequency.toFixed(1) + ' Hz';
            console.log('âœ… Frequency updated:', freqEl.textContent);
        } else {
            freqEl.textContent = '-- Hz';
        }
    } else {
        console.error('âŒ pzem-frequency element NOT FOUND!');
    }
    
    // Power Factor - Show if available
    const pfEl = document.getElementById('pzem-pf');
    if (pfEl) {
        // MQTT sends 'pf' field, check both pf and powerFactor for compatibility
        const pf = data.pf !== undefined ? data.pf : data.powerFactor;
        if (pf !== undefined && pf !== null && pf > 0) {
            pfEl.textContent = pf.toFixed(2);
        } else {
            pfEl.textContent = '--';
        }
    }

    // --- New Power Calculations ---
    const apparentPowerEl = document.getElementById('pzem-apparent-power');
    const reactivePowerEl = document.getElementById('pzem-reactive-power');

    if (isLoadConnected) {
        const voltage = data.voltage || 0;
        const current = data.current || 0;
        const activePower = data.power || 0;

        const apparentPower = voltage * current;
        let reactivePower = 0;
        // Ensure apparent power is greater than active power to avoid NaN from sqrt of a negative number
        if (apparentPower > activePower) {
            reactivePower = Math.sqrt(Math.pow(apparentPower, 2) - Math.pow(activePower, 2));
        }
        
        if (apparentPowerEl) apparentPowerEl.textContent = apparentPower.toFixed(1) + ' VA';
        if (reactivePowerEl) reactivePowerEl.textContent = reactivePower.toFixed(1) + ' VAR';
    } else {
        if (apparentPowerEl) apparentPowerEl.textContent = '0 VA';
        if (reactivePowerEl) reactivePowerEl.textContent = '0 VAR';
    }
    
    // Calculate energy costs
    calculateEnergyCost(data);
    
    // Check thresholds and trigger fault alarms if needed (only if fault protection is enabled)
    const faultProtectionToggle = document.getElementById('fault-protection-toggle');
    if (faultProtectionToggle && faultProtectionToggle.checked && isLoadConnected) {
        const voltage = data.voltage || 0;
        const current = data.current || 0;
        
        // Check voltage thresholds
        if (voltage > 0 && voltage < currentThresholds.lowVoltage) {
            console.warn(`âš¡ LOW VOLTAGE DETECTED: ${voltage}V < ${currentThresholds.lowVoltage}V`);
            handleFaultMessage(`Low Voltage Detected: ${voltage.toFixed(1)}V`);
        } else if (voltage > currentThresholds.highVoltage) {
            console.warn(`âš¡ HIGH VOLTAGE DETECTED: ${voltage}V > ${currentThresholds.highVoltage}V`);
            handleFaultMessage(`High Voltage Detected: ${voltage.toFixed(1)}V`);
        }
        
        // Check current threshold
        if (current > currentThresholds.highCurrent) {
            console.warn(`âš¡ HIGH CURRENT DETECTED: ${current}A > ${currentThresholds.highCurrent}A`);
            handleFaultMessage(`High Current Detected: ${current.toFixed(2)}A`);
        }
    }
    
    // Update timestamp
    const updateEl = document.getElementById('pzem-update');
    if (updateEl) {
        const updateTime = data.lastUpdate || new Date().toLocaleTimeString();
        updateEl.textContent = 'Last update: ' + updateTime;
    }
}

// Throttled version to prevent excessive DOM updates (max once per 100ms for responsiveness)
const updatePZEMUI = throttle(_updatePZEMUIInternal, 100);

// Calculate energy cost based on consumed energy and current power
function calculateEnergyCost(data) {
    const priceInput = document.getElementById('price-per-kwh');
    if (!priceInput) return;
    
    const pricePerKwh = parseFloat(priceInput.value) || 6.5;
    
    // Total cost based on consumed energy (kWh)
    const totalCostEl = document.getElementById('total-energy-cost');
    if (totalCostEl && data && data.energy !== undefined) {
        const totalCost = data.energy * pricePerKwh;
        totalCostEl.textContent = 'â‚¹ ' + totalCost.toFixed(2);
    }
    
    // Estimated daily and monthly costs based on current power consumption
    const dailyCostEl = document.getElementById('daily-cost-estimate');
    const monthlyCostEl = document.getElementById('monthly-cost-estimate');
    
    if (dailyCostEl && monthlyCostEl && data && data.power !== undefined) {
        const currentPowerKW = data.power / 1000; // Convert W to kW
        const dailyEnergy = currentPowerKW * 24; // kWh per day if running 24h
        const monthlyEnergy = dailyEnergy * 30; // kWh per month
        
        const dailyCost = dailyEnergy * pricePerKwh;
        const monthlyCost = monthlyEnergy * pricePerKwh;
        
        dailyCostEl.textContent = 'â‚¹ ' + dailyCost.toFixed(2);
        monthlyCostEl.textContent = 'â‚¹ ' + monthlyCost.toFixed(2);
    }
}

// Update trend indicators
function updateSensorTrend(type, value) {
    const trendElement = document.getElementById(type + '-trend');
    const previous = previousSensorValues[type];
    
    if (previous !== null) {
        const diff = value - previous;
        if (Math.abs(diff) < 0.1) {
            trendElement.innerHTML = 'âž¡ï¸ Stable';
            trendElement.className = 'trend-indicator trend-stable';
        } else if (diff > 0) {
            trendElement.innerHTML = 'â¬†ï¸ +' + diff.toFixed(1);
            trendElement.className = 'trend-indicator trend-up';
        } else {
            trendElement.innerHTML = 'â¬‡ï¸ ' + diff.toFixed(1);
            trendElement.className = 'trend-indicator trend-down';
        }
    }
    
    previousSensorValues[type] = value;
}

// Show gas alarm
function showGasAlarm(data) {
    const banner = document.getElementById('gas-alarm-banner');
    const message = document.getElementById('gas-alarm-message');
    
    const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleString() : new Date().toLocaleString();
    
    message.innerHTML = `
        ${data.message || 'High gas concentration detected. Please ventilate the area immediately.'}<br>
        <small class="text-sm">Level: ${data.level}/1024 | Time: ${timestamp}</small>
    `;
    
    banner.classList.remove('hidden');
    addLog("ðŸš¨ GAS ALARM: Level " + data.level, 'alarm');
}

// Hide gas alarm
function hideGasAlarm() {
    document.getElementById('gas-alarm-banner').classList.add('hidden');
}

// Acknowledge gas alarm
function acknowledgeGasAlarm() {
    hideGasAlarm();
    addLog("âœ“ Gas alarm acknowledged", 'alarm');
}

// Initialize sensor charts
function initSensorCharts() {
    // Destroy existing charts before creating new ones
    if (tempHistoryChart) {
        tempHistoryChart.destroy();
        tempHistoryChart = null;
    }
    if (humidityHistoryChart) {
        humidityHistoryChart.destroy();
        humidityHistoryChart = null;
    }
    if (gasHistoryChart) {
        gasHistoryChart.destroy();
        gasHistoryChart = null;
    }
    
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: true,
        interaction: {
            mode: 'index',
            intersect: false
        },
        plugins: {
            legend: { 
                display: true,
                position: 'top',
                labels: {
                    font: { size: 12, weight: '600' },
                    padding: 10
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                cornerRadius: 8,
                titleFont: { size: 13, weight: 'bold' },
                bodyFont: { size: 12 }
            }
        },
        scales: {
            x: { 
                type: 'time',
                time: {
                    unit: 'minute',
                    displayFormats: {
                        minute: 'HH:mm',
                        hour: 'HH:mm',
                        day: 'MMM dd'
                    },
                    tooltipFormat: 'MMM dd, HH:mm:ss'
                },
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                    font: { size: 11, weight: '600' }
                },
                title: {
                    display: true,
                    text: 'Time',
                    font: { size: 12, weight: 'bold' }
                }
            },
            y: { 
                display: true,
                grid: {
                    color: 'rgba(0, 0, 0, 0.08)'
                },
                ticks: {
                    font: { size: 11, weight: '600' }
                }
            }
        }
    };
    
    // Temperature Chart
    const tempCanvas = document.getElementById('tempHistoryChart');
    if (tempCanvas) {
        const tempCtx = tempCanvas.getContext('2d');
        tempHistoryChart = new Chart(tempCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Temperature (Â°C)',
                    data: [],
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: chartOptions
        });
    } else {
        console.warn("Canvas for tempHistoryChart not found.");
    }
    
    // Humidity Chart
    const humidCanvas = document.getElementById('humidityHistoryChart');
    if (humidCanvas) {
        const humidCtx = humidCanvas.getContext('2d');
        humidityHistoryChart = new Chart(humidCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Humidity (%)',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: chartOptions
        });
    } else {
        console.warn("Canvas for humidityHistoryChart not found.");
    }
    
    // Gas Chart
    const gasCanvas = document.getElementById('gasHistoryChart');
    if (gasCanvas) {
        const gasCtx = gasCanvas.getContext('2d');
        gasHistoryChart = new Chart(gasCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Gas Level (%)',
                    data: [],
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: chartOptions
        });
    } else {
        console.warn("Canvas for gasHistoryChart not found.");
    }
}

// Load sensor historical data
async function loadSensorData(hours) {
    if (!realtimeDb) {
        console.warn("âš ï¸ Realtime Database not initialized");
        return;
    }
    
    const { dbRef, get } = window.firebaseModules;
    
    try {
        console.log(`ðŸ” Loading sensor data for last ${hours} hours...`);
        
        // First, try to get ALL history data without query (for debugging)
        const historyRef = dbRef(realtimeDb, 'sensors/history');
        const snapshot = await get(historyRef);
        
        if (snapshot.exists()) {
            const data = snapshot.val();
            const dataArray = Object.values(data);
            console.log(`ðŸ“¦ Total records in database: ${dataArray.length}`);
            
            // Validate and normalize timestamps
            const MIN_VALID_TIMESTAMP = new Date('2020-01-01').getTime();
            const now = Date.now();
            
            const validatedData = dataArray
                .map(d => {
                    if (!d.timestamp) return null;
                    let ts = d.timestamp;
                    if (ts < 10000000000) ts *= 1000;
                    if (ts < MIN_VALID_TIMESTAMP || ts > now + 86400000) return null;
                    return { ...d, timestamp: ts };
                })
                .filter(d => d !== null);
            
            console.log(`âœ… Validated ${validatedData.length} records (removed ${dataArray.length - validatedData.length} invalid)`);
            if (validatedData.length > 0) {
                console.log(`ðŸ“Š First valid record:`, validatedData[0]);
                console.log(`ðŸ“Š Last valid record:`, validatedData[validatedData.length - 1]);
            }
            
            // Filter by time range manually
            let filteredData;
            if (hours === -1) {
                filteredData = validatedData;
                console.log(`ðŸ” Time range: ALL time data`);
            } else {
                const startTime = now - (hours * 60 * 60 * 1000);
                console.log(`ðŸ” Time range: ${new Date(startTime).toLocaleString()} to ${new Date(now).toLocaleString()}`);
                filteredData = validatedData.filter(d => d.timestamp >= startTime && d.timestamp <= now);
            }
            
            console.log(`âœ… Filtered ${filteredData.length} records for ${hours}h range`);
            
            if (filteredData.length > 0) {
                const sortedData = filteredData.sort((a, b) => a.timestamp - b.timestamp);
                updateSensorCharts(sortedData, hours);
                calculateSensorStats(sortedData);
            } else {
                console.log('âš ï¸ No data in selected time range');
                updateSensorCharts([], hours);
            }
        } else {
            console.log('âš ï¸ No sensor history found in database');
            console.log('ðŸ’¡ Historical data will appear after 1 minute of running');
            updateSensorCharts([]);
        }
    } catch (error) {
        console.error('âŒ Error loading sensor data:', error);
        updateSensorCharts([]);
    }
}

// Start real-time sensor data listener
function startSensorRealtimeListener(hours = currentSensorTimeRange) {
    if (!realtimeDb) {
        console.warn("âš ï¸ Realtime Database not initialized");
        return;
    }
    
    // Stop existing listener if any
    if (sensorDataListener) {
        sensorDataListener();
        sensorDataListener = null;
    }
    
    const { dbRef, onValue } = window.firebaseModules;
    
    try {
        console.log(`ðŸ”´ Starting real-time sensor listener for ${hours}h...`);
        
        const historyRef = dbRef(realtimeDb, 'sensors/history');
        
        sensorDataListener = onValue(historyRef, (snapshot) => {
            if (snapshot.exists() && isAnalyticsPageActive) {
                const data = snapshot.val();
                const dataArray = Object.values(data);
                
                // Filter by time range
                const now = Date.now();
                let filteredData;
                if (hours === -1) {
                    // ALL time - no filtering
                    filteredData = dataArray;
                } else {
                    const startTime = now - (hours * 60 * 60 * 1000);
                    filteredData = dataArray.filter(d => d.timestamp >= startTime && d.timestamp <= now);
                }
                
                console.log(`ðŸ“Š Real-time sensor update: ${filteredData.length} records`);
                
                if (filteredData.length > 0) {
                    const sortedData = filteredData.sort((a, b) => a.timestamp - b.timestamp);
                    updateSensorCharts(sortedData);
                    calculateSensorStats(sortedData);
                }
            }
        }, (error) => {
            console.error('âŒ Real-time sensor listener error:', error);
        });
        
        console.log('âœ… Real-time sensor listener started');
    } catch (error) {
        console.error('âŒ Error starting sensor listener:', error);
    }
}

// Stop real-time sensor listener
function stopSensorRealtimeListener() {
    if (sensorDataListener) {
        console.log('ðŸ›‘ Stopping real-time sensor listener...');
        sensorDataListener();
        sensorDataListener = null;
    }
}


// Update sensor charts with data
function updateSensorCharts(dataArray, hours = currentSensorTimeRange) {
    let labels = [];
    let tempData = [];
    let humidData = [];
    let gasData = [];
    
    // Determine appropriate time unit
    let timeUnit = 'minute';
    if (hours === -1 || hours > 720) {
        timeUnit = 'day';
    } else if (hours > 168) {
        timeUnit = 'day';
    } else if (hours > 24) {
        timeUnit = 'hour';
    }
    
    if (dataArray && dataArray.length > 0) {
        labels = dataArray.map(d => new Date(d.timestamp));
        tempData = dataArray.map(d => d.temperature || 0);
        humidData = dataArray.map(d => d.humidity || 0);
        gasData = dataArray.map(d => (d.gasLevel / 1024 * 100) || 0);
    } else {
        labels = [new Date()];
        tempData = [0];
        humidData = [0];
        gasData = [0];
    }
    
    // Update charts with dynamic time unit
    if (tempHistoryChart) {
        tempHistoryChart.data.labels = labels;
        tempHistoryChart.data.datasets[0].data = tempData;
        if (tempHistoryChart.options.scales && tempHistoryChart.options.scales.x && tempHistoryChart.options.scales.x.time) {
            tempHistoryChart.options.scales.x.time.unit = timeUnit;
        }
        tempHistoryChart.update('none');
    }
    
    if (humidityHistoryChart) {
        humidityHistoryChart.data.labels = labels;
        humidityHistoryChart.data.datasets[0].data = humidData;
        if (humidityHistoryChart.options.scales && humidityHistoryChart.options.scales.x && humidityHistoryChart.options.scales.x.time) {
            humidityHistoryChart.options.scales.x.time.unit = timeUnit;
        }
        humidityHistoryChart.update('none');
    }
    
    if (gasHistoryChart) {
        gasHistoryChart.data.labels = labels;
        gasHistoryChart.data.datasets[0].data = gasData;
        if (gasHistoryChart.options.scales && gasHistoryChart.options.scales.x && gasHistoryChart.options.scales.x.time) {
            gasHistoryChart.options.scales.x.time.unit = timeUnit;
        }
        gasHistoryChart.update('none');
    }
}

// Calculate sensor statistics
function calculateSensorStats(dataArray) {
    if (!dataArray || dataArray.length === 0) {
        // Set to default values
        document.getElementById('temp-min').textContent = '--Â°C';
        document.getElementById('temp-max').textContent = '--Â°C';
        document.getElementById('temp-avg').textContent = '--Â°C';
        document.getElementById('humidity-min').textContent = '--%';
        document.getElementById('humidity-max').textContent = '--%';
        document.getElementById('humidity-avg').textContent = '--%';
        document.getElementById('motion-count').textContent = '0';
        return;
    }
    
    // Filter out invalid temperature readings (0 or unrealistic values)
    const temps = dataArray
        .map(d => parseFloat(d.temperature))
        .filter(t => !isNaN(t) && t > 0 && t < 60); // Valid range: 0-60Â°C
    
    // Filter out invalid humidity readings (0 or > 100)
    const humids = dataArray
        .map(d => parseFloat(d.humidity))
        .filter(h => !isNaN(h) && h > 0 && h <= 100); // Valid range: 0-100%
    
    if (temps.length > 0) {
        const tempMin = Math.min(...temps);
        const tempMax = Math.max(...temps);
        const tempAvg = temps.reduce((a, b) => a + b, 0) / temps.length;
        
        document.getElementById('temp-min').textContent = tempMin.toFixed(1) + 'Â°C';
        document.getElementById('temp-max').textContent = tempMax.toFixed(1) + 'Â°C';
        document.getElementById('temp-avg').textContent = tempAvg.toFixed(1) + 'Â°C';
    } else {
        document.getElementById('temp-min').textContent = '--Â°C';
        document.getElementById('temp-max').textContent = '--Â°C';
        document.getElementById('temp-avg').textContent = '--Â°C';
    }
    
    if (humids.length > 0) {
        const humidMin = Math.min(...humids);
        const humidMax = Math.max(...humids);
        const humidAvg = humids.reduce((a, b) => a + b, 0) / humids.length;
        
        document.getElementById('humidity-min').textContent = humidMin.toFixed(1) + '%';
        document.getElementById('humidity-max').textContent = humidMax.toFixed(1) + '%';
        document.getElementById('humidity-avg').textContent = humidAvg.toFixed(1) + '%';
    } else {
        document.getElementById('humidity-min').textContent = '--%';
        document.getElementById('humidity-max').textContent = '--%';
        document.getElementById('humidity-avg').textContent = '--%';
    }
    
    // Motion count - count motion events (when motion = true or 1)
    const motionEvents = dataArray.filter(d => d.motion === true || d.motion === 1 || d.motion === '1');
    document.getElementById('motion-count').textContent = motionEvents.length;
}

// Load logs from Firebase
async function loadLogsFromFirebase() {
    try {
        const { dbRef, get } = window.firebaseModules;
        const logsRef = dbRef(realtimeDb, 'logs');
        const snapshot = await get(logsRef);
        
        if (snapshot.exists()) {
            const data = snapshot.val();
            // Sort by timestamp descending (latest first)
            logEntries = Object.values(data).sort((a, b) => b.timestamp - a.timestamp);
            renderLog();
            console.log(`ðŸ“ Loaded ${logEntries.length} logs from Firebase`);
        }
    } catch (error) {
        console.error('Error loading logs:', error);
    }
}

// Load device usage analytics
async function loadDeviceUsageAnalytics(hours = currentDeviceTimeRange) {
    try {
        const { dbRef, get } = window.firebaseModules;
        const usageRef = dbRef(realtimeDb, 'deviceUsage');
        const snapshot = await get(usageRef);
        
        if (!snapshot.exists()) {
            console.log('No device usage data yet');
            return;
        }
        
        const data = snapshot.val();
        const usageArray = Object.values(data);
        
        // Filter by time range
        const now = Date.now();
        let filteredData;
        if (hours === -1) {
            // ALL time - no filtering
            filteredData = usageArray;
        } else {
            const startTime = now - (hours * 60 * 60 * 1000);
            filteredData = usageArray.filter(d => d.timestamp >= startTime && d.timestamp <= now);
        }
        
        console.log(`ðŸ“Š Loaded ${filteredData.length} device usage records for ${hours}h range`);
        
        // Count actions per device
        const deviceCounts = {};
        
        filteredData.forEach(entry => {
            if (!deviceCounts[entry.deviceName]) {
                deviceCounts[entry.deviceName] = 0;
            }
            deviceCounts[entry.deviceName]++;
        });
        
        // Update charts
        updateDeviceUsageCharts(deviceCounts, filteredData);
        updateDeviceTimelineCharts(filteredData);
        
    } catch (error) {
        console.error('Error loading device usage:', error);
    }
}

// Start real-time device usage listener
function startDeviceUsageRealtimeListener(hours = currentDeviceTimeRange) {
    if (!realtimeDb) {
        console.warn("âš ï¸ Realtime Database not initialized");
        return;
    }
    
    // Stop existing listener if any
    if (deviceUsageListener) {
        deviceUsageListener();
        deviceUsageListener = null;
    }
    
    const { dbRef, onValue } = window.firebaseModules;
    
    try {
        console.log(`ðŸ”´ Starting real-time device usage listener for ${hours}h...`);
        
        const usageRef = dbRef(realtimeDb, 'deviceUsage');
        
        deviceUsageListener = onValue(usageRef, (snapshot) => {
            if (snapshot.exists() && isAnalyticsPageActive) {
                const data = snapshot.val();
                const usageArray = Object.values(data);
                
                // Filter by time range
                const now = Date.now();
                let filteredData;
                if (hours === -1) {
                    // ALL time - no filtering
                    filteredData = usageArray;
                } else {
                    const startTime = now - (hours * 60 * 60 * 1000);
                    filteredData = usageArray.filter(d => d.timestamp >= startTime && d.timestamp <= now);
                }
                
                console.log(`ðŸ“Š Real-time device usage update: ${filteredData.length} records`);
                
                // Count actions per device
                const deviceCounts = {};
                filteredData.forEach(entry => {
                    if (!deviceCounts[entry.deviceName]) {
                        deviceCounts[entry.deviceName] = 0;
                    }
                    deviceCounts[entry.deviceName]++;
                });
                
                // Update charts
                updateDeviceUsageCharts(deviceCounts, filteredData);
                updateDeviceTimelineCharts(filteredData);
            }
        }, (error) => {
            console.error('âŒ Real-time device usage listener error:', error);
        });
        
        console.log('âœ… Real-time device usage listener started');
    } catch (error) {
        console.error('âŒ Error starting device usage listener:', error);
    }
}

// Stop real-time device usage listener
function stopDeviceUsageRealtimeListener() {
    if (deviceUsageListener) {
        console.log('ðŸ›‘ Stopping real-time device usage listener...');
        deviceUsageListener();
        deviceUsageListener = null;
    }
}


// Update device usage charts
function updateDeviceUsageCharts(deviceCounts, usageArray) {
    const deviceNames = Object.keys(deviceCounts);
    const counts = Object.values(deviceCounts);
    
    // Update Pie Chart (Device Usage)
    if (pieChart) {
        pieChart.data.labels = deviceNames;
        pieChart.data.datasets[0].data = counts;
        pieChart.update();
    }
    
    // Update Bar Chart (Switch Count)
    if (barChart) {
        barChart.data.labels = deviceNames;
        barChart.data.datasets[0].data = counts;
        barChart.update();
    }
    
    // Update Heatmap (24-hour activity)
    updateActivityHeatmap(usageArray);
}

// Update device timeline charts
function updateDeviceTimelineCharts(usageArray) {
    // Group data by device
    const lightDevices = {};
    const fanDevices = {};
    
    usageArray.forEach(entry => {
        if (entry.deviceType === 'light') {
            if (!lightDevices[entry.deviceName]) {
                lightDevices[entry.deviceName] = [];
            }
            lightDevices[entry.deviceName].push({
                timestamp: entry.timestamp,
                state: entry.action === 'ON' ? 1 : 0
            });
        } else if (entry.deviceType === 'fan') {
            if (!fanDevices[entry.deviceName]) {
                fanDevices[entry.deviceName] = [];
            }
            fanDevices[entry.deviceName].push({
                timestamp: entry.timestamp,
                speed: entry.value || 0
            });
        }
    });
    
    // Update Lights Timeline Chart with professional colors
    if (lightsTimelineChart) {
        const datasets = [];
        let colorIndex = 0;
        
        Object.keys(lightDevices).forEach(deviceName => {
            const data = lightDevices[deviceName].sort((a, b) => a.timestamp - b.timestamp);
            const color = chartColors.primary[colorIndex % chartColors.primary.length];
            
            datasets.push({
                label: deviceName,
                data: data.map(d => ({ x: new Date(d.timestamp), y: d.state })),
                borderColor: color,
                backgroundColor: color,
                stepped: true,
                tension: 0,
                borderWidth: 3,
                pointRadius: 4,
                pointHoverRadius: 6,
                fill: false
            });
            colorIndex++;
        });
        
        lightsTimelineChart.data.datasets = datasets;
        lightsTimelineChart.update('none');
    }
    
    // Update Fans Timeline Chart with professional colors
    if (fansTimelineChart) {
        const datasets = [];
        let colorIndex = 0;
        
        Object.keys(fanDevices).forEach(deviceName => {
            const data = fanDevices[deviceName].sort((a, b) => a.timestamp - b.timestamp);
            const color = chartColors.primary[colorIndex % chartColors.primary.length];
            const bgColor = chartColors.gradient[colorIndex % chartColors.gradient.length];
            
            datasets.push({
                label: deviceName,
                data: data.map(d => ({ x: new Date(d.timestamp), y: d.speed })),
                borderColor: color,
                backgroundColor: bgColor,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 4,
                pointHoverRadius: 6,
                fill: true
            });
            colorIndex++;
        });
        
        fansTimelineChart.data.datasets = datasets;
        fansTimelineChart.update('none');
    }
}

// Update 24-hour activity heatmap
function updateActivityHeatmap(usageArray) {
    const heatmapContainer = document.getElementById('heatmap');
    if (!heatmapContainer) return;
    
    // Create 24 hour buckets
    const hourCounts = new Array(24).fill(0);
    
    usageArray.forEach(entry => {
        const hour = new Date(entry.timestamp).getHours();
        hourCounts[hour]++;
    });
    
    const maxCount = Math.max(...hourCounts, 1);
    
    heatmapContainer.innerHTML = '';
    
    hourCounts.forEach((count, hour) => {
        const intensity = count / maxCount;
        
        // Professional gradient coloring with multiple levels
        let backgroundColor, textColor;
        if (count === 0) {
            backgroundColor = 'rgba(229, 231, 235, 0.5)'; // Light grey for no activity
            textColor = '#9CA3AF';
        } else if (intensity < 0.25) {
            backgroundColor = 'rgba(147, 197, 253, 0.5)'; // Light blue
            textColor = '#1E40AF';
        } else if (intensity < 0.5) {
            backgroundColor = 'rgba(96, 165, 250, 0.7)'; // Medium blue
            textColor = '#1E3A8A';
        } else if (intensity < 0.75) {
            backgroundColor = 'rgba(59, 130, 246, 0.85)'; // Strong blue
            textColor = '#FFFFFF';
        } else {
            backgroundColor = 'rgba(37, 99, 235, 1)'; // Deep blue for highest activity
            textColor = '#FFFFFF';
        }
        
        const div = document.createElement('div');
        div.className = 'flex flex-col items-center justify-center rounded-lg shadow-sm transition-all hover:scale-110 cursor-pointer';
        div.style.backgroundColor = backgroundColor;
        div.style.color = textColor;
        div.style.padding = '8px';
        div.style.minHeight = '60px';
        div.style.fontWeight = '600';
        
        const hourLabel = document.createElement('div');
        hourLabel.textContent = hour.toString().padStart(2, '0') + ':00';
        hourLabel.style.fontSize = '11px';
        hourLabel.style.marginBottom = '4px';
        
        const countLabel = document.createElement('div');
        countLabel.textContent = count;
        countLabel.style.fontSize = '16px';
        countLabel.style.fontWeight = 'bold';
        
        div.appendChild(hourLabel);
        div.appendChild(countLabel);
        div.title = `${hour}:00 - ${count} activities`;
        
        heatmapContainer.appendChild(div);
    });
}

// Change device time range
function changeDeviceTimeRange(hours) {
    currentDeviceTimeRange = hours;
    
    // Update button states for device time range
    document.querySelectorAll('.device-time-btn').forEach(btn => {
        if (parseInt(btn.dataset.range) === hours) {
            btn.className = 'device-time-btn px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition';
        } else {
            btn.className = 'device-time-btn px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition';
        }
    });
    
    // Reload analytics and restart listener with new time range
    loadDeviceUsageAnalytics(hours);
    if (isAnalyticsPageActive) {
        startDeviceUsageRealtimeListener(hours);
    }
}

// Change sensor time range
function changeSensorTimeRange(hours) {
    currentSensorTimeRange = hours;
    
    // Update button states
    document.querySelectorAll('.time-range-btn').forEach(btn => {
        if (parseInt(btn.dataset.range) === hours) {
            btn.className = 'time-range-btn px-4 py-2 rounded-lg bg-indigo-600 text-white';
        } else {
            btn.className = 'time-range-btn px-4 py-2 rounded-lg bg-gray-200';
        }
    });
    
    // Reload data and restart listener with new time range
    loadSensorData(hours);
    if (isAnalyticsPageActive) {
        startSensorRealtimeListener(hours);
    }
}

// Export sensor data to Excel
async function exportSensorData() {
    if (!realtimeDb) {
        showToast("Firebase not ready", "error");
        return;
    }
    
    try {
        showToast("Preparing Excel file...", "info");
        
        const { dbRef, get } = window.firebaseModules;
        const historyRef = dbRef(realtimeDb, 'sensors/history');
        const snapshot = await get(historyRef);
        
        if (!snapshot.exists()) {
            showToast("No data available", "warning");
            return;
        }
        
        const data = snapshot.val();
        const dataArray = Object.values(data);
        
        // Filter by current time range
        let filteredData;
        if (currentSensorTimeRange === -1) {
            // ALL data
            filteredData = dataArray;
        } else {
            const now = Date.now();
            const startTime = now - (currentSensorTimeRange * 60 * 60 * 1000);
            filteredData = dataArray.filter(d => d.timestamp >= startTime && d.timestamp <= now);
        }
        
        if (filteredData.length === 0) {
            showToast("No data in selected time range", "warning");
            return;
        }
        
        // Sort by timestamp
        const sortedData = filteredData.sort((a, b) => a.timestamp - b.timestamp);
        
        // Prepare data for Excel
        const excelData = sortedData.map(record => ({
            'Timestamp': new Date(record.timestamp).toLocaleString(),
            'Temperature (Â°C)': parseFloat(record.temperature || 0).toFixed(2),
            'Humidity (%)': parseFloat(record.humidity || 0).toFixed(2),
            'Gas Level (0-1024)': parseInt(record.gasLevel || 0),
            'Gas Alarm': record.gasAlarm ? 'DETECTED' : 'CLEAR',
            'Motion': record.motion ? 'DETECTED' : 'NONE'
        }));
        
        // Create workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(excelData);
        
        // Set column widths
        ws['!cols'] = [
            { wch: 20 }, // Timestamp
            { wch: 15 }, // Temperature
            { wch: 15 }, // Humidity
            { wch: 15 }, // Gas Level
            { wch: 12 }, // Gas Alarm
            { wch: 12 }  // Motion
        ];
        
        XLSX.utils.book_append_sheet(wb, ws, 'Sensor Data');
        
        // Generate filename with date range
        const timeRangeLabel = currentSensorTimeRange === -1 ? 'ALL' : 
                              (currentSensorTimeRange >= 24 ? `${currentSensorTimeRange/24}D` : `${currentSensorTimeRange}H`);
        const filename = `SensorData_${timeRangeLabel}_${new Date().toISOString().split('T')[0]}.xlsx`;
        
        // Download file
        XLSX.writeFile(wb, filename);
        
        showToast(`Downloaded ${sortedData.length} records`, "success");
        addLog(`ðŸ“¥ Sensor data exported (${sortedData.length} records)`, 'system');
        
    } catch (error) {
        console.error('Error exporting sensor data:', error);
        showToast("Export failed: " + error.message, "error");
    }
}

// ========== PZEM ANALYTICS FUNCTIONS ==========

// Initialize PZEM charts
function initPZEMCharts() {
    // Destroy existing charts before creating new ones
    if (powerHistoryChart) {
        powerHistoryChart.destroy();
        powerHistoryChart = null;
    }
    if (voltageHistoryChart) {
        voltageHistoryChart.destroy();
        voltageHistoryChart = null;
    }
    if (currentHistoryChart) {
        currentHistoryChart.destroy();
        currentHistoryChart = null;
    }
    if (energyHistoryChart) {
        energyHistoryChart.destroy();
        energyHistoryChart = null;
    }
    
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: true,
        interaction: {
            mode: 'index',
            intersect: false
        },
        plugins: {
            legend: { 
                display: true,
                position: 'top',
                labels: {
                    font: { size: 12, weight: '600' },
                    padding: 10
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                cornerRadius: 8,
                titleFont: { size: 13, weight: 'bold' },
                bodyFont: { size: 12 }
            }
        },
        scales: {
            x: { 
                type: 'time',
                time: {
                    unit: 'minute',
                    displayFormats: {
                        minute: 'HH:mm',
                        hour: 'HH:mm'
                    },
                    tooltipFormat: 'MMM dd, HH:mm:ss'
                },
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                    font: { size: 11, weight: '600' }
                },
                title: {
                    display: true,
                    text: 'Time',
                    font: { size: 12, weight: 'bold' }
                }
            },
            y: { 
                display: true,
                grid: {
                    color: 'rgba(0, 0, 0, 0.08)'
                },
                ticks: {
                    font: { size: 11, weight: '600' }
                }
            }
        }
    };
    
    // Power Chart
    const powerCtx = document.getElementById('powerHistoryChart').getContext('2d');
    powerHistoryChart = new Chart(powerCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Power (W)',
                data: [],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                tension: 0.4,
                fill: true,
                borderWidth: 2,
                pointRadius: 2,
                pointHoverRadius: 5
            }]
        },
        options: {
            ...chartOptions,
            scales: {
                ...chartOptions.scales,
                y: {
                    ...chartOptions.scales.y,
                    title: {
                        display: true,
                        text: 'Power (Watts)',
                        font: { size: 12, weight: 'bold' }
                    }
                }
            }
        }
    });
    
    // Voltage Chart
    const voltageCtx = document.getElementById('voltageHistoryChart').getContext('2d');
    voltageHistoryChart = new Chart(voltageCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Voltage (V)',
                data: [],
                borderColor: '#eab308',
                backgroundColor: 'rgba(234, 179, 8, 0.2)',
                tension: 0.4,
                fill: true,
                borderWidth: 2,
                pointRadius: 2,
                pointHoverRadius: 5
            }]
        },
        options: {
            ...chartOptions,
            scales: {
                ...chartOptions.scales,
                y: {
                    ...chartOptions.scales.y,
                    title: {
                        display: true,
                        text: 'Voltage (Volts)',
                        font: { size: 12, weight: 'bold' }
                    }
                }
            }
        }
    });
    
    // Current Chart
    const currentCtx = document.getElementById('currentHistoryChart').getContext('2d');
    currentHistoryChart = new Chart(currentCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Current (A)',
                data: [],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                tension: 0.4,
                fill: true,
                borderWidth: 2,
                pointRadius: 2,
                pointHoverRadius: 5
            }]
        },
        options: {
            ...chartOptions,
            scales: {
                ...chartOptions.scales,
                y: {
                    ...chartOptions.scales.y,
                    title: {
                        display: true,
                        text: 'Current (Amperes)',
                        font: { size: 12, weight: 'bold' }
                    }
                }
            }
        }
    });
    
    // Energy Chart
    const energyCtx = document.getElementById('energyHistoryChart').getContext('2d');
    energyHistoryChart = new Chart(energyCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Energy (kWh)',
                data: [],
                borderColor: '#a855f7',
                backgroundColor: 'rgba(168, 85, 247, 0.2)',
                tension: 0.4,
                fill: true,
                borderWidth: 2,
                pointRadius: 2,
                pointHoverRadius: 5
            }]
        },
        options: {
            ...chartOptions,
            scales: {
                ...chartOptions.scales,
                y: {
                    ...chartOptions.scales.y,
                    title: {
                        display: true,
                        text: 'Energy (kWh)',
                        font: { size: 12, weight: 'bold' }
                    }
                }
            }
        }
    });
}

// Load PZEM data from Firebase
async function loadPZEMData(hours = 1) {
    if (!realtimeDb) {
        console.warn("âš ï¸ Realtime Database not initialized");
        return;
    }
    
    const { dbRef, get } = window.firebaseModules;
    
    try {
        console.log(`ðŸ” Loading PZEM data for last ${hours} hours...`);
        
        const historyRef = dbRef(realtimeDb, 'powerMonitor/history');
        const snapshot = await get(historyRef);
        
        if (snapshot.exists()) {
            const data = snapshot.val();
            const dataArray = Object.values(data);
            console.log(`ðŸ“¦ Total PZEM records: ${dataArray.length}`);
            
            // Validate and normalize timestamps
            const MIN_VALID_TIMESTAMP = new Date('2020-01-01').getTime();
            const now = Date.now();
            
            const validatedData = dataArray
                .map(d => {
                    if (!d.timestamp) return null;
                    let ts = d.timestamp;
                    if (ts < 10000000000) ts *= 1000;
                    if (ts < MIN_VALID_TIMESTAMP || ts > now + 86400000) return null;
                    return { ...d, timestamp: ts };
                })
                .filter(d => d !== null);
            
            console.log(`âœ… Validated ${validatedData.length} PZEM records (removed ${dataArray.length - validatedData.length} invalid)`);
            
            // Filter by time range
            let filteredData;
            if (hours === -1) {
                filteredData = validatedData;
            } else {
                const startTime = now - (hours * 60 * 60 * 1000);
                filteredData = validatedData.filter(d => d.timestamp >= startTime && d.timestamp <= now);
            }
            
            console.log(`âœ… Filtered ${filteredData.length} PZEM records for ${hours}h range`);
            
            if (filteredData.length > 0) {
                const sortedData = filteredData.sort((a, b) => a.timestamp - b.timestamp);
                updatePZEMCharts(sortedData, hours);
                calculatePZEMStats(sortedData);
            } else {
                console.log('âš ï¸ No PZEM data in selected time range');
                updatePZEMCharts([], hours);
            }
        } else {
            console.log('âš ï¸ No PZEM history found in database');
            console.log('ðŸ’¡ PZEM historical data will appear when load is connected');
            updatePZEMCharts([]);
        }
    } catch (error) {
        console.error('âŒ Error loading PZEM data:', error);
        updatePZEMCharts([]);
    }
}

// Start real-time PZEM data listener
function startPZEMRealtimeListener(hours = currentPZEMTimeRange) {
    if (!realtimeDb) {
        console.warn("âš ï¸ Realtime Database not initialized");
        return;
    }
    
    // Stop existing listener if any
    if (pzemDataListener) {
        pzemDataListener();
        pzemDataListener = null;
    }
    
    const { dbRef, onValue } = window.firebaseModules;
    
    try {
        console.log(`ðŸ”´ Starting real-time PZEM listener for ${hours}h...`);
        
        const historyRef = dbRef(realtimeDb, 'powerMonitor/history');
        
        pzemDataListener = onValue(historyRef, (snapshot) => {
            if (snapshot.exists() && isAnalyticsPageActive) {
                const data = snapshot.val();
                const dataArray = Object.values(data);
                
                // Validate and normalize timestamps
                const MIN_VALID_TIMESTAMP = new Date('2020-01-01').getTime();
                const now = Date.now();
                
                const validatedData = dataArray
                    .map(d => {
                        if (!d.timestamp) return null;
                        let ts = d.timestamp;
                        if (ts < 10000000000) ts *= 1000;
                        if (ts < MIN_VALID_TIMESTAMP || ts > now + 86400000) return null;
                        return { ...d, timestamp: ts };
                    })
                    .filter(d => d !== null);
                
                // Filter by time range
                let filteredData;
                if (hours === -1) {
                    filteredData = validatedData;
                } else {
                    const startTime = now - (hours * 60 * 60 * 1000);
                    filteredData = validatedData.filter(d => d.timestamp >= startTime && d.timestamp <= now);
                }
                
                console.log(`ðŸ“Š Real-time PZEM update: ${filteredData.length} records`);
                
                if (filteredData.length > 0) {
                    const sortedData = filteredData.sort((a, b) => a.timestamp - b.timestamp);
                    updatePZEMCharts(sortedData, hours);
                    calculatePZEMStats(sortedData);
                }
            }
        }, (error) => {
            console.error('âŒ Real-time PZEM listener error:', error);
        });
        
        console.log('âœ… Real-time PZEM listener started');
    } catch (error) {
        console.error('âŒ Error starting PZEM listener:', error);
    }
}

// Stop real-time PZEM listener
function stopPZEMRealtimeListener() {
    if (pzemDataListener) {
        console.log('ðŸ›‘ Stopping real-time PZEM listener...');
        pzemDataListener();
        pzemDataListener = null;
    }
}


// Update PZEM charts with data
function updatePZEMCharts(dataArray, hours = currentPZEMTimeRange) {
    let labels = [];
    let powerData = [];
    let voltageData = [];
    let currentData = [];
    let energyData = [];
    
    // Determine appropriate time unit based on data range
    let timeUnit = 'minute';
    if (hours === -1 || hours > 720) { // ALL or > 30 days
        timeUnit = 'day';
    } else if (hours > 168) { // > 7 days
        timeUnit = 'day';
    } else if (hours > 24) { // > 1 day
        timeUnit = 'hour';
    }
    
    if (dataArray && dataArray.length > 0) {
        // Filter and validate data
        const validData = dataArray.filter(d => 
            d.timestamp && 
            !isNaN(d.power) && 
            !isNaN(d.voltage) && 
            !isNaN(d.current) && 
            !isNaN(d.energy)
        );
        
        if (validData.length > 0) {
            // Use timestamp objects for proper time-series display
            labels = validData.map(d => new Date(d.timestamp));
            powerData = validData.map(d => parseFloat(d.power) || 0);
            voltageData = validData.map(d => parseFloat(d.voltage) || 0);
            currentData = validData.map(d => parseFloat(d.current) || 0);
            energyData = validData.map(d => parseFloat(d.energy) || 0);
        } else {
            // No valid data
            labels = [new Date()];
            powerData = [0];
            voltageData = [0];
            currentData = [0];
            energyData = [0];
        }
    } else {
        // No data at all
        labels = [new Date()];
        powerData = [0];
        voltageData = [0];
        currentData = [0];
        energyData = [0];
    }
    
    // Update charts with animations disabled for better performance
    if (powerHistoryChart) {
        powerHistoryChart.data.labels = labels;
        powerHistoryChart.data.datasets[0].data = powerData;
        if (powerHistoryChart.options.scales && powerHistoryChart.options.scales.x && powerHistoryChart.options.scales.x.time) {
            powerHistoryChart.options.scales.x.time.unit = timeUnit;
        }
        powerHistoryChart.update('none');
    }
    
    if (voltageHistoryChart) {
        voltageHistoryChart.data.labels = labels;
        voltageHistoryChart.data.datasets[0].data = voltageData;
        if (voltageHistoryChart.options.scales && voltageHistoryChart.options.scales.x && voltageHistoryChart.options.scales.x.time) {
            voltageHistoryChart.options.scales.x.time.unit = timeUnit;
        }
        voltageHistoryChart.update('none');
    }
    
    if (currentHistoryChart) {
        currentHistoryChart.data.labels = labels;
        currentHistoryChart.data.datasets[0].data = currentData;
        if (currentHistoryChart.options.scales && currentHistoryChart.options.scales.x && currentHistoryChart.options.scales.x.time) {
            currentHistoryChart.options.scales.x.time.unit = timeUnit;
        }
        currentHistoryChart.update('none');
    }
    
    if (energyHistoryChart) {
        energyHistoryChart.data.labels = labels;
        energyHistoryChart.data.datasets[0].data = energyData;
        if (energyHistoryChart.options.scales && energyHistoryChart.options.scales.x && energyHistoryChart.options.scales.x.time) {
            energyHistoryChart.options.scales.x.time.unit = timeUnit;
        }
        energyHistoryChart.update('none');
    }
}

// Calculate PZEM statistics
function calculatePZEMStats(dataArray) {
    if (!dataArray || dataArray.length === 0) {
        document.getElementById('pzem-peak-power').textContent = '-- W';
        document.getElementById('pzem-peak-time').textContent = '--';
        document.getElementById('pzem-avg-power').textContent = '-- W';
        document.getElementById('pzem-total-energy').textContent = '-- kWh';
        document.getElementById('pzem-energy-cost').textContent = 'â‚¹ --';
        document.getElementById('pzem-runtime').textContent = '-- hrs';
        return;
    }
    
    // Filter out invalid data and sort by timestamp
    const validData = dataArray.filter(d => 
        d.power !== undefined && 
        d.power !== null && 
        !isNaN(d.power) &&
        d.power >= 0 &&
        d.power < 10000 &&  // Reject unrealistic power readings > 10kW
        d.timestamp !== undefined
    ).sort((a, b) => a.timestamp - b.timestamp);
    
    if (validData.length === 0) {
        document.getElementById('pzem-peak-power').textContent = '0 W';
        document.getElementById('pzem-peak-time').textContent = 'No data';
        document.getElementById('pzem-avg-power').textContent = '0 W';
        document.getElementById('pzem-total-energy').textContent = '0.00 kWh';
        document.getElementById('pzem-energy-cost').textContent = 'â‚¹ 0.00';
        document.getElementById('pzem-runtime').textContent = '0.0 hrs';
        return;
    }
    
    // Extract valid power values with additional validation
    const powers = validData.map(d => parseFloat(d.power)).filter(p => !isNaN(p) && p >= 0 && p < 10000);
    
    // Peak power with proper index mapping
    if (powers.length > 0) {
        const maxPower = Math.max(...powers);
        const maxDataPoint = validData.find(d => parseFloat(d.power) === maxPower);
        
        if (maxDataPoint) {
            const maxTime = new Date(maxDataPoint.timestamp).toLocaleString('en-IN', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            document.getElementById('pzem-peak-power').textContent = maxPower.toFixed(2) + ' W';
            document.getElementById('pzem-peak-time').textContent = maxTime;
        }
        
        // Average power (only count when power > 0.5W to exclude noise)
        const activePowers = powers.filter(p => p > 0.5);
        if (activePowers.length > 0) {
            const avgPower = activePowers.reduce((a, b) => a + b, 0) / activePowers.length;
            document.getElementById('pzem-avg-power').textContent = avgPower.toFixed(2) + ' W';
        } else {
            document.getElementById('pzem-avg-power').textContent = '0 W';
        }
    }
    
    // Total energy consumption - use latest reading minus earliest reading in selected range
    const energies = validData
        .map(d => parseFloat(d.energy))
        .filter(e => !isNaN(e) && e >= 0 && e < 1000000); // Filter unrealistic energy values
    
    if (energies.length >= 2) {
        // Sort to get first and last values
        const sortedEnergies = [...energies].sort((a, b) => a - b);
        const firstEnergy = sortedEnergies[0];
        const lastEnergy = sortedEnergies[sortedEnergies.length - 1];
        
        // Calculate difference
        let totalEnergy = lastEnergy - firstEnergy;
        
        // If negative or too large, it likely means PZEM was reset, use last value only
        if (totalEnergy < 0 || totalEnergy > 1000) {
            totalEnergy = lastEnergy;
        }
        
        const pricePerKwh = parseFloat(document.getElementById('price-per-kwh')?.value) || 6.5;
        const totalCost = totalEnergy * pricePerKwh;
        
        document.getElementById('pzem-total-energy').textContent = totalEnergy.toFixed(3) + ' kWh';
        document.getElementById('pzem-energy-cost').textContent = 'â‚¹ ' + totalCost.toFixed(2);
    } else if (energies.length === 1) {
        // Only one reading, use it directly
        const totalEnergy = energies[0];
        const pricePerKwh = parseFloat(document.getElementById('price-per-kwh')?.value) || 6.5;
        const totalCost = totalEnergy * pricePerKwh;
        
        document.getElementById('pzem-total-energy').textContent = totalEnergy.toFixed(3) + ' kWh';
        document.getElementById('pzem-energy-cost').textContent = 'â‚¹ ' + totalCost.toFixed(2);
    } else {
        document.getElementById('pzem-total-energy').textContent = '0.000 kWh';
        document.getElementById('pzem-energy-cost').textContent = 'â‚¹ 0.00';
    }
    
    // Runtime calculation - count time when current > 0.1A (meaningful load)
    const activeRecords = validData.filter(d => {
        const current = parseFloat(d.current);
        return !isNaN(current) && current > 0.1; // Only count when meaningful current
    });
    
    if (activeRecords.length > 1) {
        // Calculate actual time span of active records
        const firstActiveTime = activeRecords[0].timestamp;
        const lastActiveTime = activeRecords[activeRecords.length - 1].timestamp;
        const timeSpanMs = lastActiveTime - firstActiveTime;
        const totalHours = timeSpanMs / (1000 * 60 * 60); // Convert ms to hours
        
        // Cap at reasonable maximum (selected time range)
        const maxHours = currentPZEMTimeRange || 24;
        const cappedHours = Math.min(totalHours, maxHours);
        
        document.getElementById('pzem-runtime').textContent = cappedHours.toFixed(2) + ' hrs';
    } else if (activeRecords.length === 1) {
        // Only one active record
        document.getElementById('pzem-runtime').textContent = '0.01 hrs';
    } else {
        document.getElementById('pzem-runtime').textContent = '0.00 hrs';
    }
}

// Change PZEM time range
function changePZEMTimeRange(hours) {
    currentPZEMTimeRange = hours;
    
    // Update button states
    document.querySelectorAll('.pzem-time-range-btn').forEach(btn => {
        if (parseInt(btn.dataset.range) === hours) {
            btn.className = 'pzem-time-range-btn px-4 py-2 rounded-lg bg-indigo-600 text-white';
        } else {
            btn.className = 'pzem-time-range-btn px-4 py-2 rounded-lg bg-gray-200';
        }
    });
    
    // Reload data and restart listener with new time range
    loadPZEMData(hours);
    if (isAnalyticsPageActive) {
        startPZEMRealtimeListener(hours);
    }
}

// Export PZEM data to Excel
async function exportPZEMData() {
    if (!realtimeDb) {
        showToast("Firebase not ready", "error");
        return;
    }
    
    try {
        showToast("Preparing Excel file...", "info");
        
        const { dbRef, get } = window.firebaseModules;
        const historyRef = dbRef(realtimeDb, 'powerMonitor/history');
        const snapshot = await get(historyRef);
        
        if (!snapshot.exists()) {
            showToast("No data available", "warning");
            return;
        }
        
        const data = snapshot.val();
        const dataArray = Object.values(data);
        
        // Filter by current time range
        let filteredData;
        if (currentPZEMTimeRange === -1) {
            // ALL data
            filteredData = dataArray;
        } else {
            const now = Date.now();
            const startTime = now - (currentPZEMTimeRange * 60 * 60 * 1000);
            filteredData = dataArray.filter(d => d.timestamp >= startTime && d.timestamp <= now);
        }
        
        if (filteredData.length === 0) {
            showToast("No data in selected time range", "warning");
            return;
        }
        
        // Sort by timestamp
        const sortedData = filteredData.sort((a, b) => a.timestamp - b.timestamp);
        
        // Prepare data for Excel
        const excelData = sortedData.map(record => ({
            'Timestamp': new Date(record.timestamp).toLocaleString(),
            'Voltage (V)': parseFloat(record.voltage || 0).toFixed(2),
            'Current (A)': parseFloat(record.current || 0).toFixed(3),
            'Power (W)': parseFloat(record.power || 0).toFixed(2),
            'Energy (kWh)': parseFloat(record.energy || 0).toFixed(3),
            'Frequency (Hz)': parseFloat(record.frequency || 0).toFixed(2),
            'Power Factor': parseFloat(record.powerFactor || 0).toFixed(3)
        }));
        
        // Create workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(excelData);
        
        // Set column widths
        ws['!cols'] = [
            { wch: 20 }, // Timestamp
            { wch: 12 }, // Voltage
            { wch: 12 }, // Current
            { wch: 12 }, // Power
            { wch: 14 }, // Energy
            { wch: 14 }, // Frequency
            { wch: 14 }  // Power Factor
        ];
        
        XLSX.utils.book_append_sheet(wb, ws, 'Power Monitor Data');
        
        // Calculate statistics for summary sheet
        const avgVoltage = (sortedData.reduce((sum, r) => sum + (r.voltage || 0), 0) / sortedData.length).toFixed(2);
        const avgCurrent = (sortedData.reduce((sum, r) => sum + (r.current || 0), 0) / sortedData.length).toFixed(3);
        const avgPower = (sortedData.reduce((sum, r) => sum + (r.power || 0), 0) / sortedData.length).toFixed(2);
        const maxPower = Math.max(...sortedData.map(r => r.power || 0)).toFixed(2);
        const totalEnergy = (sortedData[sortedData.length - 1]?.energy || 0).toFixed(3);
        
        const summaryData = [
            { 'Metric': 'Average Voltage', 'Value': avgVoltage + ' V' },
            { 'Metric': 'Average Current', 'Value': avgCurrent + ' A' },
            { 'Metric': 'Average Power', 'Value': avgPower + ' W' },
            { 'Metric': 'Peak Power', 'Value': maxPower + ' W' },
            { 'Metric': 'Total Energy', 'Value': totalEnergy + ' kWh' },
            { 'Metric': 'Total Records', 'Value': sortedData.length },
            { 'Metric': 'Time Range', 'Value': currentPZEMTimeRange === -1 ? 'ALL' : (currentPZEMTimeRange >= 24 ? `${currentPZEMTimeRange/24} Days` : `${currentPZEMTimeRange} Hours`) },
            { 'Metric': 'Export Date', 'Value': new Date().toLocaleString() }
        ];
        
        const wsSummary = XLSX.utils.json_to_sheet(summaryData);
        wsSummary['!cols'] = [{ wch: 20 }, { wch: 20 }];
        XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
        
        // Generate filename with date range
        const timeRangeLabel = currentPZEMTimeRange === -1 ? 'ALL' : 
                              (currentPZEMTimeRange >= 24 ? `${currentPZEMTimeRange/24}D` : `${currentPZEMTimeRange}H`);
        const filename = `PowerMonitor_${timeRangeLabel}_${new Date().toISOString().split('T')[0]}.xlsx`;
        
        // Download file
        XLSX.writeFile(wb, filename);
        
        showToast(`Downloaded ${sortedData.length} records`, "success");
        addLog(`ðŸ“¥ Power monitor data exported (${sortedData.length} records)`, 'system');
        
    } catch (error) {
        console.error('Error exporting PZEM data:', error);
        showToast("Export failed: " + error.message, "error");
    }
}

// ========== END PZEM ANALYTICS FUNCTIONS ==========

// ========== END SENSOR FUNCTIONS ==========

// Export logs to Excel
function exportLogsToExcel() {
    if (logEntries.length === 0) {
        showToast("No logs to export", "warning");
        return;
    }
    
    try {
        showToast("Preparing Excel file...", "info");
        
        // Prepare data for Excel
        const excelData = logEntries.map(entry => ({
            'Date': entry.date || new Date(entry.timestamp).toLocaleDateString(),
            'Time': entry.time,
            'User': entry.user || 'System',
            'Category': entry.category || 'general',
            'Activity': entry.text
        }));
        
        // Create workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(excelData);
        
        // Set column widths
        ws['!cols'] = [
            { wch: 12 }, // Date
            { wch: 12 }, // Time
            { wch: 20 }, // User
            { wch: 15 }, // Category
            { wch: 60 }  // Activity
        ];
        
        XLSX.utils.book_append_sheet(wb, ws, 'Activity Logs');
        
        // Create summary sheet
        const categoryCount = {};
        logEntries.forEach(entry => {
            const cat = entry.category || 'general';
            categoryCount[cat] = (categoryCount[cat] || 0) + 1;
        });
        
        const summaryData = [
            { 'Metric': 'Total Entries', 'Value': logEntries.length },
            { 'Metric': 'Export Date', 'Value': new Date().toLocaleString() },
            { 'Metric': '', 'Value': '' },
            { 'Metric': 'By Category', 'Value': '' },
            ...Object.entries(categoryCount).map(([cat, count]) => ({
                'Metric': `  ${cat}`,
                'Value': count
            }))
        ];
        
        const wsSummary = XLSX.utils.json_to_sheet(summaryData);
        wsSummary['!cols'] = [{ wch: 25 }, { wch: 20 }];
        XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
        
        // Generate filename
        const filename = `ActivityLogs_${new Date().toISOString().split('T')[0]}.xlsx`;
        
        // Download file
        XLSX.writeFile(wb, filename);
        
        showToast(`Downloaded ${logEntries.length} log entries`, "success");
        addLog(`ðŸ“¥ Activity logs exported to Excel (${logEntries.length} entries)`, 'system');
        
    } catch (error) {
        console.error('Error exporting logs to Excel:', error);
        showToast("Export failed: " + error.message, "error");
    }
}

// Page Navigation
function switchPage(pageName) {
    // Normalize page names and only operate on pages that exist in the DOM
    const normalized = pageName === 'dashboard' ? 'control' : pageName;
    const pages = ['control', 'monitor', 'analytics', 'logs', 'faults', 'menu', 'fire-alarm'];
    pages.forEach(page => {
        const el = document.getElementById(`page-${page}`);
        if (el) el.classList.add('hidden');
    });

    const target = document.getElementById(`page-${normalized}`);
    if (target) {
        target.classList.remove('hidden');
    } else {
        // Fallback to control page if requested page not found
        const fallback = document.getElementById('page-control');
        if (fallback) fallback.classList.remove('hidden');
    }

    document.querySelectorAll('.nav-tab').forEach(tab => {
        if (tab.dataset.page === pageName) {
            tab.classList.add('active');
        } else {
            tab.classList.remove('active');
        }
    });

    // Load data when switching pages
    if (pageName === 'analytics') {
        isAnalyticsPageActive = true;

        // Initialize charts
        initSensorCharts();
        initPZEMCharts();

        // Load initial data
        loadSensorData(currentSensorTimeRange);
        loadPZEMData(currentPZEMTimeRange);
        loadDeviceUsageAnalytics();

        // Start real-time listeners for live updates
        console.log('ðŸ”´ Starting all real-time analytics listeners...');
        startSensorRealtimeListener(currentSensorTimeRange);
        startPZEMRealtimeListener(currentPZEMTimeRange);
        startDeviceUsageRealtimeListener(currentDeviceTimeRange);
    } else {
        // Stop real-time listeners when leaving analytics page
        if (isAnalyticsPageActive) {
            isAnalyticsPageActive = false;
            console.log('ðŸ›‘ Stopping all real-time analytics listeners...');
            stopSensorRealtimeListener();
            stopPZEMRealtimeListener();
            stopDeviceUsageRealtimeListener();
        }

        if (pageName === 'logs') {
            loadLogsFromFirebase();
            loadAlarmHistory(); // Load fire alarm history
        }
    }
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM Content Loaded");

    // Night suggestion banner listeners
    const nightSuggestionBanner = document.getElementById('night-suggestion-banner');
    if (nightSuggestionBanner) {
        const yesBtn = document.getElementById('night-suggestion-yes');
        const noBtn = document.getElementById('night-suggestion-no');

        const hideBanner = () => {
            nightSuggestionBanner.classList.add('opacity-0', 'translate-y-4');
            setTimeout(() => {
                nightSuggestionBanner.classList.add('hidden');
            }, 300);
        };

        yesBtn.addEventListener('click', () => {
            turnOnAllLights();
            hideBanner();
        });

        noBtn.addEventListener('click', () => {
            hideBanner();
        });
    }
    
    // Detect mobile and show help text
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
    if (isMobile) {
        const mobileHelp = document.getElementById('mobile-help');
        if (mobileHelp) {
            mobileHelp.classList.remove('hidden');
        }
        console.log("ðŸ“± Mobile device detected");
    }
    
    // Auth Forms
    const authContainer = document.getElementById('auth-container');
    const signupContainer = document.getElementById('signup-container');
    const forgotPasswordContainer = document.getElementById('forgot-password-container');
    const mainApp = document.getElementById('main-app');
    
    console.log("Auth elements:", { authContainer, signupContainer, forgotPasswordContainer, mainApp });
    
    document.getElementById('switch-to-signup').addEventListener('click', () => {
        authContainer.classList.add('hidden');
        signupContainer.classList.remove('hidden');
        forgotPasswordContainer.classList.add('hidden');
    });
    
    document.getElementById('switch-to-login').addEventListener('click', () => {
        signupContainer.classList.add('hidden');
        authContainer.classList.remove('hidden');
        forgotPasswordContainer.classList.add('hidden');
    });
    
    document.getElementById('forgot-password-btn').addEventListener('click', () => {
        authContainer.classList.add('hidden');
        signupContainer.classList.add('hidden');
        forgotPasswordContainer.classList.remove('hidden');
    });
    
    document.getElementById('switch-to-login-from-forgot').addEventListener('click', () => {
        forgotPasswordContainer.classList.add('hidden');
        signupContainer.classList.add('hidden');
        authContainer.classList.remove('hidden');
    });
    
    // Forgot Password Form
    document.getElementById('forgot-password-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const { sendPasswordResetEmail } = window.firebaseModules;
        const email = document.getElementById('reset-email').value;
        
        try {
            await sendPasswordResetEmail(auth, email);
            showToast("Password reset email sent! Check your inbox.", "success");
            document.getElementById('reset-email').value = '';
            
            // Switch back to login after 2 seconds
            setTimeout(() => {
                forgotPasswordContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
            }, 2000);
        } catch (error) {
            console.error("Password reset error:", error);
            let errorMsg = "Failed to send reset email";
            if (error.code === 'auth/user-not-found') {
                errorMsg = "No account found with this email";
            } else if (error.code === 'auth/invalid-email') {
                errorMsg = "Invalid email address";
            } else if (error.code === 'auth/too-many-requests') {
                errorMsg = "Too many attempts. Please try again later";
            }
            showToast(errorMsg, "error");
        }
    });
    
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const { signInWithEmailAndPassword, setPersistence, browserLocalPersistence, browserSessionPersistence } = window.firebaseModules;
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const rememberMe = document.getElementById('remember-me').checked;
        
        try {
            // Set persistence based on "Remember Me" checkbox
            const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
            await setPersistence(auth, persistence);
            
            // Sign in after setting persistence
            await signInWithEmailAndPassword(auth, email, password);
            showToast("Login successful!", "success");
        } catch (error) {
            showToast(error.message, "error");
        }
    });
    
    document.getElementById('signup-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const { createUserWithEmailAndPassword, updateProfile, setPersistence, browserLocalPersistence } = window.firebaseModules;
        const name = document.getElementById('signup-name').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        
        try {
            // Set persistence to LOCAL for new users (default to remember)
            await setPersistence(auth, browserLocalPersistence);
            
            const cred = await createUserWithEmailAndPassword(auth, email, password);
            await updateProfile(cred.user, { displayName: name });
            showToast("Account created!", "success");
        } catch (error) {
            showToast(error.message, "error");
        }
    });
    
    // Logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
        const { signOut } = window.firebaseModules;
        const userEmail = currentUser ? currentUser.email : 'Unknown';
        addLog(`User logged out: ${userEmail}`, 'auth');
        
        // Stop all real-time listeners before logout
        isAnalyticsPageActive = false;
        stopSensorRealtimeListener();
        stopPZEMRealtimeListener();
        stopDeviceUsageRealtimeListener();
        console.log('ðŸ›‘ Stopped all real-time listeners for logout');
        
        await signOut(auth);
        showToast("Logged out", "success");
        
        // Hide all auth screens
        forgotPasswordContainer.classList.add('hidden');
        signupContainer.classList.add('hidden');
    });

    // Feedback Form Handler
    document.getElementById('feedback-form').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const name = document.getElementById('feedback-name').value;
        const email = document.getElementById('feedback-email').value;
        const subject = document.getElementById('feedback-subject').value;
        const message = document.getElementById('feedback-message').value;
        const sendToPiku = document.getElementById('send-to-piku').checked;
        const sendToArnab = document.getElementById('send-to-arnab').checked;
        
        // Validate at least one recipient is selected
        if (!sendToPiku && !sendToArnab) {
            showToast("Please select at least one recipient", "error");
            return;
        }
        
        // Build email recipients
        const recipients = [];
        if (sendToPiku) recipients.push('pikumandal5233@gmail.com');
        if (sendToArnab) recipients.push('arnabmandal123123@gmail.com');
        
        // Build email body
        const emailBody = `Hello Team,

I would like to share my feedback regarding the Smart Home Automation System.

Name: ${name}
Email: ${email}
Subject: ${subject}

Message:
${message}

---
Sent via Smart Home Automation Feedback System
Timestamp: ${new Date().toLocaleString()}`;
        
        // Build Gmail compose URL
        const gmailURL = `https://mail.google.com/mail/?view=cm&fs=1&to=${recipients.join(',')}&su=${encodeURIComponent(`[Smart Home Feedback] ${subject}`)}&body=${encodeURIComponent(emailBody)}`;
        
        // Log activity
        addLog(`Feedback submitted by ${name} (${subject})`, 'system');
        
        // Show success message
        showToast("Redirecting to Gmail...", "success");
        
        // Open Gmail in new tab
        setTimeout(() => {
            window.open(gmailURL, '_blank');
            
            // Reset form
            document.getElementById('feedback-form').reset();
            document.getElementById('send-to-piku').checked = true;
            document.getElementById('send-to-arnab').checked = true;
            
            showToast("Thank you for your feedback! ðŸŒŸ", "success");
        }, 500);
    });
    
        // Drawer event listeners and functions (removed)
    
    // Accordion
    document.querySelectorAll('.accordion-toggle').forEach(toggle => {
        toggle.addEventListener('click', () => {
            const content = document.getElementById(`accordion-${toggle.dataset.accordion}`);
            if (!content) { // Add null check
                console.warn(`Accordion content for ID accordion-${toggle.dataset.accordion} not found.`);
                return; 
            }
            const isOpen = content.style.maxHeight && content.style.maxHeight !== '0px';
            
            document.querySelectorAll('.accordion-content').forEach(c => c.style.maxHeight = '0px');
            
            if (!isOpen) {
                content.style.maxHeight = content.scrollHeight + 'px';
                toggle.querySelector('svg').classList.add('rotate-180');
            } else {
                toggle.querySelector('svg').classList.remove('rotate-180');
            }
        });
    });
    
    // Navigation
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => switchPage(tab.dataset.page));
    });
    
    // Quick Actions
    document.getElementById('turn-all-on').addEventListener('click', () => {
        // Turn on all lights
        for (let i = 1; i <= NUM_LIGHTS; i++) {
            publishMessage(`homeautomation/project/light/${i}/set`, "ON");
        }
        // Turn on all fans (2 fans)
        publishMessage(`homeautomation/project/fan/1/set`, "75");
        publishMessage(`homeautomation/project/fan/2/set`, "75");
        addLog("Turned ON all devices (lights + fans)", 'device-control');
        showToast("All devices turned ON", "success");
    });
    
    document.getElementById('turn-all-off').addEventListener('click', () => {
        // Turn off all lights
        for (let i = 1; i <= NUM_LIGHTS; i++) {
            publishMessage(`homeautomation/project/light/${i}/set`, "OFF");
        }
        // Turn off all fans (2 fans)
        publishMessage(`homeautomation/project/fan/1/set`, "0");
        publishMessage(`homeautomation/project/fan/2/set`, "0");
        addLog("Turned OFF all devices (lights + fans)", 'device-control');
        showToast("All devices turned OFF", "info");
    });
    
    // Fire Alarm
    const testAlarmBtnPage = document.getElementById('test-alarm-btn-page');
    if (testAlarmBtnPage) {
        testAlarmBtnPage.addEventListener('click', () => {
            publishMessage("homeautomation/project/alarm/flame", "DETECTED", true);
            addLog("Test alarm triggered", 'alarm');
        });
    }
    
    const stopAlarmBtnPage = document.getElementById('stop-alarm-btn-page');
    if (stopAlarmBtnPage) {
        stopAlarmBtnPage.addEventListener('click', () => {
            stopAlarm();
            publishMessage("homeautomation/project/alarm/flame", "CLEAR", true);
            addLog("Alarm stopped", 'alarm');
        });
    }
    
    // Voice Control
    document.getElementById('voice-btn').addEventListener('click', () => {
        if (!recognition) {
            showToast("Voice control not supported in this browser", "error");
            speak("Voice control is not supported in this browser");
            return;
        }
        
        try {
            // Cancel any ongoing speech before starting recognition
            const synth = getSynthesis();
            if (synth.isSpeaking()) {
                try { synth.cancel(); } catch(e){}
            }
            recognition.start();
            addLog("Voice recognition started", 'voice-command');
        } catch (error) {
            console.error("Error starting voice recognition:", error);
            if (error.message.includes('already started')) {
                showToast("Already listening...", "info");
            } else {
                showToast("Failed to start voice recognition", "error");
                speak("Failed to start voice recognition");
            }
        }
    });
    
    // Logs
    document.getElementById('log-search').addEventListener('input', renderLog);
    document.getElementById('clear-logs-btn').addEventListener('click', () => {
        logEntries = [];
        renderLog();
        showToast("Logs cleared", "success");
    });
    
    document.getElementById('export-logs-excel-btn').addEventListener('click', () => {
        exportLogsToExcel();
    });
    
    document.getElementById('export-logs-btn').addEventListener('click', () => {
        const text = logEntries.map(e => `[${e.time}] ${e.user ? `[${e.user}]` : ''} ${e.text}`).join('\n');
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `logs-${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        showToast("Logs exported as TXT", "success");
    });
    
    // Fire Alarm History
    const refreshAlarmHistoryBtn = document.getElementById('refresh-alarm-history-btn');
    if (refreshAlarmHistoryBtn) {
        refreshAlarmHistoryBtn.addEventListener('click', () => {
            loadAlarmHistory();
            showToast("Alarm history refreshed", "success");
        });
    }
    
    document.getElementById('drawer-logs-btn').addEventListener('click', () => {
        showPage('logs');
    });

document.getElementById('drawer-faults-btn')?.addEventListener('click', () => showPage('faults'));
    document.getElementById('drawer-fire-alarm-btn')?.addEventListener('click', () => showPage('fire-alarm'));
    
    // Profile editing listeners
    const editBtn = document.getElementById('edit-profile-btn');
    const saveBtn = document.getElementById('save-profile-btn');
    const cancelBtn = document.getElementById('cancel-edit-profile-btn');
    const nameView = document.getElementById('profile-name-view');
    const nameEdit = document.getElementById('profile-name-edit');
    const nameInput = document.getElementById('profile-name-input');
    const displayNameEl = document.getElementById('profile-display-name');
    const photoUploadInput = document.getElementById('photo-upload');
    const profilePhotoImg = document.getElementById('profile-photo');

    editBtn.addEventListener('click', () => {
        // Switch to edit mode
        nameView.classList.add('hidden');
        nameEdit.classList.remove('hidden');
        nameInput.value = displayNameEl.textContent;

        editBtn.classList.add('hidden');
        saveBtn.classList.remove('hidden');
        cancelBtn.classList.remove('hidden');
    });

    cancelBtn.addEventListener('click', () => {
        // Switch back to view mode
        nameView.classList.remove('hidden');
        nameEdit.classList.add('hidden');
        photoUploadInput.value = ''; // Clear file selection

        editBtn.classList.remove('hidden');
        saveBtn.classList.add('hidden');
        cancelBtn.classList.add('hidden');
        
        // Hide progress bar in case it was visible
        document.getElementById('upload-progress-bar').classList.add('hidden');
    });

    saveBtn.addEventListener('click', async () => {
        const newName = nameInput.value;
        const photoFile = photoUploadInput.files[0];

        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        
        await saveProfile(newName, photoFile);

        // Switch back to view mode
        nameView.classList.remove('hidden');
        nameEdit.classList.add('hidden');
        photoUploadInput.value = ''; // Clear file selection

        editBtn.classList.remove('hidden');
        saveBtn.classList.add('hidden');
        cancelBtn.classList.add('hidden');
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save';
    });

    function turnOnAllLights() {
        if (isSystemLocked) {
            showToast("System is locked. Cannot turn on lights.", "warning");
            return;
        }
        const lights = appliances.filter(app => app.type === 'light');
        lights.forEach(light => {
            publishMessage(`homeautomation/project/light/${light.deviceId}/set`, "ON");
        });
        addLog("Turned on all lights via night-time suggestion.", "automation");
        showToast("Turning on all lights...", "info");
    }

    function handleUserLogin(user) {
        // 1. Fetch user name and show greeting
        const { dbRef, get } = window.firebaseModules;
        const userRef = dbRef(realtimeDb, `users/${user.uid}`);
        get(userRef).then(snapshot => {
            let greetingName = user.email; // Default to email
            if (snapshot.exists()) {
                const userData = snapshot.val();
                if (userData.name) { // Check if name is not null, undefined, or empty
                    greetingName = userData.name;
                }
            }
            showToast(`Welcome, ${greetingName}!`, 'success');

        }).catch(error => {
            console.error("Error fetching user data:", error);
            // Fallback to email even if DB fetch fails
            showToast(`Welcome, ${user.email}!`, 'success');
        });

        // 2. Check for night time and show suggestion
        const currentHour = new Date().getHours();
        // Night is from 7 PM (19) to 6 AM (5)
        if (currentHour >= 19 || currentHour < 6) {
            const banner = document.getElementById('night-suggestion-banner');
            if (banner) {
                banner.classList.remove('hidden');
                setTimeout(() => {
                    banner.classList.remove('opacity-0', 'translate-y-4');
                }, 500); // Delay before showing
            }
        }
    }

    photoUploadInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                profilePhotoImg.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    // Auth State Listener - Initialize after DOM is ready
    function initAuthListener() {
        if (!window.firebaseModules || !auth) {
            setTimeout(initAuthListener, 100);
            return;
        }
        
        const { onAuthStateChanged } = window.firebaseModules;
        console.log("Setting up auth listener...");
        
        onAuthStateChanged(auth, async (user) => {
            console.log("Auth state changed:", user ? "Logged in" : "Logged out");
            
            if (user) {
                currentUser = user;
                console.log("User logged in:", user.email);
                
                // Hide auth screens
                authContainer.classList.add('hidden');
                signupContainer.classList.add('hidden');
                forgotPasswordContainer.classList.add('hidden');
                
                // Show main app
                mainApp.classList.remove('hidden');
                
                listenToUserProfile(user.uid);
                
                // Log login event
                addLog(`User logged in: ${user.email}`, 'auth');
                handleUserLogin(user);
                
                // Initialize app
                await loadAppliances();
                renderDevices();
                loadTimers();
                loadSmartLightToggleStates();
                loadSmartFanToggleStates();
                // Timers will be lazy-loaded per device when the Manage Timers accordion is opened
                startTimerScheduler();
                startSmartLightingScheduler();
                startSmartFanScheduler();
                connectMqtt();
                setTimeout(initCharts, 1000);
                
                                // Initialize sensor monitoring
                
                                setTimeout(() => {
                
                                    startSensorListeners();
                
                                    initSensorCharts();
                
                                }, 1500);
                
                
                
                                // Page-specific event listeners
                
                                const drawerFireAlarmBtn = document.getElementById('drawer-fire-alarm-btn');
                
                                if (drawerFireAlarmBtn) {
                
                                    drawerFireAlarmBtn.addEventListener('click', () => showPage('fire-alarm'));
                
                                }
                
                
                
                                const logoutBtn = document.getElementById('logout-btn');
                
                                if (logoutBtn) {
                
                                    logoutBtn.addEventListener('click', async () => {
                
                                        const { signOut } = window.firebaseModules;
                
                                        const userEmail = currentUser ? currentUser.email : 'Unknown';
                
                                        addLog(`User logged out: ${userEmail}`, 'auth');
                
                                        
                
                                        // Stop all real-time listeners before logout
                
                                        isAnalyticsPageActive = false;
                
                                        stopSensorRealtimeListener();
                
                                        stopPZEMRealtimeListener();
                
                                        stopDeviceUsageRealtimeListener();
                
                                        console.log('ðŸ›‘ Stopped all real-time listeners for logout');
                
                                        
                
                                        await signOut(auth);
                
                                        showToast("Logged out", "success");
                
                                        
                
                                        // Hide all auth screens
                
                                        forgotPasswordContainer.classList.add('hidden');
                
                                        signupContainer.classList.add('hidden');
                
                                    });
                
                                }
                
                            } else {
                
                                console.log("User logged out");
                
                                currentUser = null;
                
                                
                
                                // Show auth screen
                
                                mainApp.classList.add('hidden');
                
                                signupContainer.classList.add('hidden');
                
                                forgotPasswordContainer.classList.add('hidden');
                
                                authContainer.classList.remove('hidden');
                
                                
                
                                // Reset to dashboard
                
                                switchPage('dashboard');
                
                            }
            updateFloatingVoiceButtonVisibility();
        });
    }
    
    // Start auth listener when Firebase is ready
    window.addEventListener('firebaseReady', initAuthListener);
    // Also try immediately in case Firebase is already ready
    setTimeout(initAuthListener, 500);
});

const scrollToTopBtn = document.getElementById('scroll-to-top');
if (scrollToTopBtn) {
    window.addEventListener('scroll', () => {
      if (window.scrollY > 200) {
        scrollToTopBtn.classList.remove('hidden');
      } else {
        scrollToTopBtn.classList.add('hidden');
      }
    });

    scrollToTopBtn.addEventListener('click', () => {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    });
}
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const fireAlarmButton = document.getElementById('drawer-fire-alarm-btn');
        if (fireAlarmButton) {
            fireAlarmButton.addEventListener('click', () => {
                setTimeout(() => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 100); // A small delay to ensure the page is visible
            });
        }
    });
</script>
<button id="scroll-to-top" class="hidden fixed bottom-4 right-4 bg-indigo-600 text-white rounded-full p-3 shadow-lg hover:bg-indigo-700">
  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
</button>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;

        // Apply saved theme preference on load
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
            if (themeToggle) {
                themeToggle.checked = true;
            }
        } else {
            body.classList.remove('dark-mode');
            if (themeToggle) {
                themeToggle.checked = false;
            }
        }

        // Listen for changes on the theme toggle
        if (themeToggle) {
            themeToggle.addEventListener('change', () => {
                if (themeToggle.checked) {
                    body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark');
                } else {
                    body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light');
                }
            });
        }
    });
</script>
</body>
</html>
